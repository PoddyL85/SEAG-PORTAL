<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nicolas's SEAG Portal</title>
    
    <!-- Google Fonts: Orbitron for a gaming feel -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">

    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel to compile JSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- PDF.js for parsing PDF files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


    <style>
        body {
            font-family: 'Roboto', sans-serif;
        }
        .font-orbitron {
            font-family: 'Orbitron', sans-serif;
        }
        .glowing-border {
            box-shadow: 0 0 2px #00aaff, 0 0 5px #00aaff, 0 0 10px #00aaff;
        }
        .glowing-text {
            text-shadow: 0 0 5px #00aaff, 0 0 10px #00aaff;
        }
        /* Custom styles for modal and notifications */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .notification-bar {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            transition: opacity 0.5s, transform 0.5s;
        }
        /* Animation for feedback flash */
        @keyframes flash-green {
            0% { background-color: #16a34a; } /* green-600 */
            100% { background-color: transparent; }
        }
        @keyframes flash-red {
            0% { background-color: #dc2626; } /* red-600 */
            100% { background-color: transparent; }
        }
        .flash-correct {
            animation: flash-green 0.5s ease-out;
        }
        .flash-incorrect {
            animation: flash-red 0.5s ease-out;
        }
        /* Print styles */
        @media print {
            body * {
                visibility: hidden;
            }
            #print-area, #print-area * {
                visibility: visible;
            }
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none;
            }
        }
    </style>
</head>
<body class="bg-slate-900 text-gray-200">
    <div id="root"></div>

    <script type="text/babel">
        // This is your entire React Application inside a single script tag.
        // Data is saved in the browser's localStorage.

        // Required for PDF.js to work
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js`;

        const { useState, useEffect, useCallback, useRef } = React;

        // --- PASTE YOUR API KEY HERE ---
        const GEMINI_API_KEY = "AIzaSyBGKBOQ-oupxp1bHgN3nXFMyKrjqex-A-s";

        // --- Default Test Data ---
        const defaultTests = [
            {
                id: "maths-pack-1",
                title: "Maths Test Pack 1",
                subject: "Maths",
                notes: "From 2023 practice paper, page 5.",
                questions: [
                    { question: "A football pitch measures 115 metres long and 80 metres wide. The area of a rugby pitch is 6,392 square metres. How many square metres smaller is the area of the rugby pitch than the area of the football pitch?", options: ["9200 m²", "2908 m²", "2809 m²", "2808 m²", "6197 m²"], answer: "2808 m²" },
                    { question: "Convert this measurement: 1701 g = ___ kg", options: ["17.01 kg", "1.701 kg", "170.1 kg", "1.7 kg", "0.1701 kg"], answer: "1.701 kg" },
                    { question: "How many lines of symmetry does a rhombus have?", options: ["0", "1", "2", "3", "4"], answer: "2" },
                    { question: "Which is the most appropriate instrument for measuring the distance around a football?", options: ["trundle wheel", "odometer", "metre stick", "tape measure", "ruler"], answer: "tape measure" },
                    { question: "Ahmed cycled 13 km on Monday and 15 km on Thursday. How much further did he cycle on Thursday than on Monday?", options: ["1 km", "3 km", "5 km", "4 km", "2 km"], answer: "2 km" },
                    { question: "What decimal fraction is equivalent to 3/4?", options: ["0.25", "0.33", "0.20", "0.75", "0.10"], answer: "0.75", tags: ['fractions'] },
                    { question: "A regular hexagon has a side length of 7 cm. A square has the same perimeter as the hexagon. What is the area of the square?", options: ["42 cm²", "100 cm²", "10.5 cm²", "110.25 cm²", "49 cm²"], answer: "110.25 cm²", tags: ['geometry'] },
                    { question: "What is the tenth number in this sequence: 1.5, 3.0, 4.5, 6.0, ...?", options: ["9.0", "12.5", "15", "15.0", "17.5"], answer: "15.0" },
                    { question: "Girls in Years 4, 5, 6, and 7 collected £4, £12, £16, and £17 respectively. What was the average amount collected?", options: ["£12.00", "£12.25", "£12.50", "£10.00", "£13.00"], answer: "£12.25" },
                    { question: "A rectangle's corners are at A(25, 30), B(55, 30), C(55, 14), and D. What are the coordinates of point D?", options: ["(25, 14)", "(55, 30)", "(25, 22)", "(55, 14)", "(40, 14)"], answer: "(25, 14)", tags: ['geometry'] },
                    { question: "By how much is 18.401 greater than 14.1?", options: ["4.3", "3.3", "4.301", "3.301", "4"], answer: "4.301" },
                    { question: "A stack of 20 identical pizza boxes is 160 cm tall. Giovanni removes 3 from the top. How tall is the stack now?", options: ["130 cm", "132 cm", "134 cm", "136 cm", "138 cm"], answer: "136 cm" },
                    { question: "What would be the best unit of measure for recording the amount of water in a paddling pool?", options: ["litres", "mm", "cm", "m³", "ml"], answer: "litres" },
                    { question: "A scale shows a weight between 1.2 kg and 1.3 kg, marked in 10 increments. The pointer is on the 4th mark after 1.2. What is the weight?", options: ["1.21 kg", "1.22 kg", "1.23 kg", "1.24 kg", "1.25 kg"], answer: "1.24 kg" },
                    { question: "b × 6 = 48. What does (b + 2) × 5 equal?", options: ["30", "40", "20", "50", "60"], answer: "50" },
                    { question: "How many vertical lines are in an isosceles trapezium with a vertical line of symmetry drawn through it?", options: ["0", "1", "2", "3", "4"], answer: "1" },
                    { question: "What is 7/10 of £17?", options: ["£9.90", "£10.90", "£11.70", "£11.90", "£12.90"], answer: "£11.90", tags: ['percentages', 'fractions'] },
                    { question: "A chart showing population change over time with points connected by lines is what type of chart?", options: ["Block Graph", "Pie Chart", "Bar Graph", "Bar-Line Graph", "Line Graph"], answer: "Line Graph" },
                    { question: "A rectangle is divided into 8 equal squares. 6 of them are shaded. What fraction is shaded?", options: ["1/4", "3/8", "5/8", "3/4", "7/8"], answer: "3/4", tags: ['fractions'] },
                    { question: "A chart shows temperature ranges. The lowest is -13°C and the highest is 6°C. What is the difference between the highest and lowest temperatures?", options: ["-13°C", "18°C", "19°C", "20°C", "21°C"], answer: "19°C" },
                    { question: "Pattern 1 has 9 blocks. Pattern 2 has 13 blocks. Pattern 3 has 17 blocks. The rule is (Number of blocks) = 4 * PatternNumber + 5. Which pattern will have 49 blocks?", options: ["9", "10", "11", "12", "13"], answer: "11" },
                    { question: "In a sale, everything was reduced by 25%. How much would be saved on an item which usually cost £4.80?", answer: "£1.20", tags: ['percentages'] },
                    { question: "A decision tree sorts numbers. If the number is even, it checks if it's a multiple of 5. If not even, it checks if it's a square number. Which box would the number 64 be put into? (Box A: even, mult of 5. Box B: even, not mult of 5. Box C: odd, square. Box D: odd, not square)", answer: "B" },
                    { question: "What is the missing number in this sequence: 2, 5, 11, 23, ___?", answer: "47" },
                    { question: "A film starts at 19:45 and lasts for 1 hour and 35 minutes. What time does it finish?", answer: "21:20" },
                    { question: "Calculate 3.5 × 8.", answer: "28" },
                    { question: "A bag contains 6 red balls and 10 blue balls. What is the probability of picking a red ball?", answer: "6/16", tags: ['fractions'] },
                    { question: "What is 15% of 300?", answer: "45", tags: ['percentages'] }
                ]
            },
            {
                id: "maths-pack-2",
                title: "Maths Test Pack 2",
                subject: "Maths",
                notes: "General maths revision.",
                questions: [
                    { question: "A baker uses 250g of flour for every cake. How many cakes can he bake with a 5kg bag of flour?", options: ["10", "15", "20", "25", "30"], answer: "20" },
                    { question: "What is the value of x if 4x + 5 = 25?", options: ["3", "4", "5", "6", "7"], answer: "5" },
                    { question: "A train travels at 60 mph. How long does it take to travel 150 miles?", options: ["2 hours", "2.5 hours", "3 hours", "3.5 hours", "4 hours"], answer: "2.5 hours" },
                    { question: "What is the next prime number after 19?", options: ["20", "21", "22", "23", "24"], answer: "23" },
                    { question: "A rectangle has a perimeter of 30 cm. Its length is 10 cm. What is its width?", options: ["5 cm", "6 cm", "7 cm", "8 cm", "10 cm"], answer: "5 cm", tags: ['geometry'] },
                    { question: "Simplify the ratio 18:24.", options: ["2:3", "3:4", "4:5", "5:6", "6:7"], answer: "3:4" },
                    { question: "What is 0.25 as a percentage?", options: ["2.5%", "25%", "250%", "0.025%", "0.25%"], answer: "25%", tags: ['percentages'] },
                    { question: "A circle has a radius of 5 cm. What is its diameter?", options: ["5 cm", "10 cm", "15 cm", "20 cm", "25 cm"], answer: "10 cm", tags: ['geometry'] },
                    { question: "Find the mean of these numbers: 4, 6, 8, 10.", options: ["5", "6", "7", "8", "9"], answer: "7" },
                    { question: "If a = 3 and b = 4, what is the value of 2a + 3b?", options: ["15", "16", "17", "18", "19"], answer: "18" },
                    { question: "How many degrees are in a right angle?", options: ["45", "90", "180", "270", "360"], answer: "90", tags: ['geometry'] },
                    { question: "What is the square root of 144?", options: ["10", "11", "12", "13", "14"], answer: "12" },
                    { question: "A map has a scale of 1:10000. A distance on the map is 5 cm. What is the real distance in metres?", options: ["50m", "500m", "5000m", "50000m", "5m"], answer: "500m" },
                    { question: "What is the area of a triangle with a base of 10 cm and a height of 6 cm?", options: ["20 cm²", "30 cm²", "40 cm²", "50 cm²", "60 cm²"], answer: "30 cm²", tags: ['geometry'] },
                    { question: "Convert 2.5 hours into minutes.", options: ["120", "130", "140", "150", "160"], answer: "150" },
                    { question: "What is the mode of this set of numbers: 2, 3, 3, 4, 5, 5, 5, 6?", options: ["2", "3", "4", "5", "6"], answer: "5" },
                    { question: "A cube has a volume of 27 cm³. What is the length of one side?", options: ["2 cm", "3 cm", "4 cm", "5 cm", "6 cm"], answer: "3 cm", tags: ['geometry'] },
                    { question: "What is 3/5 as a decimal?", options: ["0.3", "0.4", "0.5", "0.6", "0.7"], answer: "0.6", tags: ['fractions'] },
                    { question: "A car journey starts at 08:30 and ends at 11:15. How long was the journey?", options: ["2h 15m", "2h 30m", "2h 45m", "3h 00m", "3h 15m"], answer: "2h 45m" },
                    { question: "Increase £50 by 20%.", options: ["£52", "£55", "£58", "£60", "£62"], answer: "£60", tags: ['percentages'] },
                    { question: "What is the sum of the angles in a quadrilateral?", options: ["90°", "180°", "270°", "360°", "540°"], answer: "360°", tags: ['geometry'] },
                    { question: "Write 0.05 as a fraction in its simplest form.", answer: "1/20", tags: ['fractions'] },
                    { question: "A book costs £8.50. There is a 10% discount. What is the new price?", answer: "£7.65", tags: ['percentages'] },
                    { question: "How many faces does a triangular prism have?", answer: "5", tags: ['geometry'] },
                    { question: "What is the next number in the Fibonacci sequence: 1, 1, 2, 3, 5, 8, ___?", answer: "13" },
                    { question: "Calculate 1/4 + 3/8.", answer: "5/8", tags: ['fractions'] },
                    { question: "A square has an area of 64 cm². What is its perimeter?", answer: "32 cm", tags: ['geometry'] },
                    { question: "What is the largest factor of 24 (other than 24)?", answer: "12" }
                ]
            },
            {
                id: "english-pack-1",
                title: "English Test Pack 1",
                subject: "English",
                notes: "Focus on punctuation and grammar.",
                questions: [
                    { question: "Identify the sentence with the correct punctuation: The cat sat on the mat. or The cat, sat on the mat.", answer: "The cat sat on the mat.", tags: ['punctuation'] },
                    { question: "Which word is the adjective in this sentence: The quick brown fox jumps over the lazy dog.", answer: "quick", tags: ['grammar'] },
                    { question: "Choose the correct spelling: a) accomodate b) accommodate c) acommodate", answer: "b", tags: ['spelling'] },
                    { question: "What is the synonym for 'happy'?", options: ["Sad", "Joyful", "Angry", "Tired"], answer: "Joyful", tags: ['vocabulary'] },
                    { question: "Identify the verb in the sentence: She sings beautifully.", answer: "sings", tags: ['grammar'] },
                    { question: "Which of the following is a correctly punctuated question? a) Where are you going. b) Where are you going! c) Where are you going?", answer: "c", tags: ['punctuation'] },
                    { question: "What is the plural of 'child'?", answer: "children", tags: ['grammar'] },
                    { question: "Choose the antonym for 'brave'.", options: ["Cowardly", "Heroic", "Strong", "Bold"], answer: "Cowardly", tags: ['vocabulary'] },
                    { question: "Identify the pronoun in: 'He gave the book to her.'", answer: "He", tags: ['grammar'] },
                    { question: "Correct the spelling of 'recieve'.", answer: "receive", tags: ['spelling'] },
                    { question: "Which sentence uses 'its' and 'it's' correctly?", options: ["The dog wagged it's tail because its happy.", "The dog wagged its tail because it's happy.", "The dog wagged it's tail because it's happy."], answer: "The dog wagged its tail because it's happy.", tags: ['grammar'] },
                    { question: "What type of word is 'quickly'?", answer: "adverb", tags: ['grammar'] },
                    { question: "Find the error: 'Me and my friend went to the park.'", answer: "Me", tags: ['grammar'] },
                    { question: "What is the past tense of 'go'?", answer: "went", tags: ['grammar'] },
                    { question: "Identify the proper noun: 'We visited Paris in France.'", answer: "Paris", tags: ['grammar'] },
                    { question: "Which is the correct contraction for 'do not'?", answer: "don't", tags: ['punctuation'] },
                    { question: "What does the prefix 'un-' mean in 'unhappy'?", answer: "not", tags: ['vocabulary'] },
                    { question: "Choose the correctly spelled word: a) seperate b) separate c) seporate", answer: "b", tags: ['spelling'] },
                    { question: "Identify the conjunction: 'I wanted to go, but I was too tired.'", answer: "but", tags: ['grammar'] },
                    { question: "What is the superlative form of 'good'?", answer: "best", tags: ['grammar'] },
                    { question: "Which sentence is in the passive voice?", options: ["The boy threw the ball.", "The ball was thrown by the boy."], answer: "The ball was thrown by the boy.", tags: ['grammar'] },
                    { question: "What is the meaning of the idiom 'bite the bullet'?", answer: "To endure a difficult situation", tags: ['vocabulary'] },
                    { question: "Correct the sentence: 'their going to the store.'", answer: "They're going to the store.", tags: ['grammar'] },
                    { question: "Identify the preposition: 'The cat is under the table.'", answer: "under", tags: ['grammar'] },
                    { question: "What is the collective noun for a group of lions?", answer: "pride", tags: ['vocabulary'] },
                    { question: "Choose the correct homophone: 'I want to go ___, over there.'", options: ["their", "there", "they're"], answer: "there", tags: ['vocabulary'] },
                    { question: "What is the function of an apostrophe in 'the cat's toy'?", answer: "To show possession", tags: ['punctuation'] },
                    { question: "Which word completes the simile: 'as brave as a ___'?", answer: "lion", tags: ['vocabulary'] }
                ]
            },
            {
                id: "english-pack-2",
                title: "English Test Pack 2",
                subject: "English",
                notes: "Vocabulary and sentence structure.",
                questions: [
                    { question: "Which sentence is grammatically correct?", options: ["She done her homework.", "She did her homework."], answer: "She did her homework.", tags: ['grammar'] },
                    { question: "What is the plural of 'goose'?", answer: "geese", tags: ['grammar'] },
                    { question: "Identify the adverb: 'The turtle walked slowly.'", answer: "slowly", tags: ['grammar'] },
                    { question: "Choose the correct word: 'The book is on ___ shelf.'", options: ["it's", "its"], answer: "its", tags: ['grammar'] },
                    { question: "What is an antonym for 'ancient'?", options: ["Old", "Modern", "Historic", "Past"], answer: "Modern", tags: ['vocabulary'] },
                    { question: "Which word is a noun?", options: ["beautiful", "ran", "happiness", "quickly"], answer: "happiness", tags: ['grammar'] },
                    { question: "Correct the spelling of 'neccessary'.", answer: "necessary", tags: ['spelling'] },
                    { question: "What does the suffix '-less' mean in 'careless'?", answer: "without", tags: ['vocabulary'] },
                    { question: "Identify the verb in the imperative sentence: 'Close the door.'", answer: "Close", tags: ['grammar'] },
                    { question: "What is the comparative form of 'bad'?", answer: "worse", tags: ['grammar'] },
                    { question: "Which of these is a compound sentence?", options: ["I like tea.", "I like tea and he likes coffee."], answer: "I like tea and he likes coffee.", tags: ['grammar'] },
                    { question: "What is the collective noun for a group of fish?", answer: "school", tags: ['vocabulary'] },
                    { question: "Choose the correct homophone: 'She has a new ___ of shoes.'", options: ["pair", "pare", "pear"], answer: "pair", tags: ['vocabulary'] },
                    { question: "Identify the type of sentence: 'What a beautiful day!'", answer: "Exclamatory", tags: ['punctuation'] },
                    { question: "What is the meaning of the idiom 'spill the beans'?", answer: "To reveal a secret", tags: ['vocabulary'] },
                    { question: "Correct the punctuation: 'Lets eat Grandma'", answer: "Let's eat, Grandma.", tags: ['punctuation'] },
                    { question: "What is the abstract noun in: 'Honesty is the best policy.'?", answer: "Honesty", tags: ['grammar'] },
                    { question: "Which word is spelled correctly?", options: ["wierd", "weird", "weerd"], answer: "weird", tags: ['spelling'] },
                    { question: "Identify the direct object: 'The dog chased the cat.'", answer: "cat", tags: ['grammar'] },
                    { question: "What is the opposite of 'expand'?", answer: "contract", tags: ['vocabulary'] },
                    { question: "Which sentence uses 'who' and 'whom' correctly?", options: ["Who did you give the book to?", "Whom did you give the book to?"], answer: "Whom did you give the book to?", tags: ['grammar'] },
                    { question: "What is the root word of 'unbelievable'?", answer: "believe", tags: ['vocabulary'] },
                    { question: "Identify the simile: 'He is as strong as an ox.'", answer: "as strong as an ox", tags: ['vocabulary'] },
                    { question: "What is the plural of 'cactus'?", answer: "cacti", tags: ['grammar'] },
                    { question: "Choose the correct verb form: 'The news ___ always on at 6.'", options: ["is", "are"], answer: "is", tags: ['grammar'] },
                    { question: "What type of pronoun is 'myself'?", answer: "Reflexive", tags: ['grammar'] },
                    { question: "Correct the sentence: 'I could of gone to the party.'", answer: "I could have gone to the party.", tags: ['grammar'] },
                    { question: "What does the prefix 're-' mean in 'rewrite'?", answer: "again", tags: ['vocabulary'] }
                ]
            },
            {
                id: "full-test-1",
                title: "Full Practice Test 1",
                subject: "Mixed",
                notes: "Full-length practice exam 1.",
                questions: [
                    // English Section (28 Qs)
                    { question: "Identify the sentence with the correct punctuation: The cat sat on the mat. or The cat, sat on the mat.", answer: "The cat sat on the mat.", tags: ['punctuation'] },
                    { question: "Which word is the adjective in this sentence: The quick brown fox jumps over the lazy dog.", answer: "quick", tags: ['grammar'] },
                    { question: "Choose the correct spelling: a) accomodate b) accommodate c) acommodate", answer: "b", tags: ['spelling'] },
                    { question: "What is the synonym for 'happy'?", options: ["Sad", "Joyful", "Angry", "Tired"], answer: "Joyful", tags: ['vocabulary'] },
                    { question: "Identify the verb in the sentence: She sings beautifully.", answer: "sings", tags: ['grammar'] },
                    { question: "Which of the following is a correctly punctuated question? a) Where are you going. b) Where are you going! c) Where are you going?", answer: "c", tags: ['punctuation'] },
                    { question: "What is the plural of 'child'?", answer: "children", tags: ['grammar'] },
                    { question: "Choose the antonym for 'brave'.", options: ["Cowardly", "Heroic", "Strong", "Bold"], answer: "Cowardly", tags: ['vocabulary'] },
                    { question: "Identify the pronoun in: 'He gave the book to her.'", answer: "He", tags: ['grammar'] },
                    { question: "Correct the spelling of 'recieve'.", answer: "receive", tags: ['spelling'] },
                    { question: "Which sentence uses 'its' and 'it's' correctly?", options: ["The dog wagged it's tail because its happy.", "The dog wagged its tail because it's happy.", "The dog wagged it's tail because it's happy."], answer: "The dog wagged its tail because it's happy.", tags: ['grammar'] },
                    { question: "What type of word is 'quickly'?", answer: "adverb", tags: ['grammar'] },
                    { question: "Find the error: 'Me and my friend went to the park.'", answer: "Me", tags: ['grammar'] },
                    { question: "What is the past tense of 'go'?", answer: "went", tags: ['grammar'] },
                    { question: "Identify the proper noun: 'We visited Paris in France.'", answer: "Paris", tags: ['grammar'] },
                    { question: "Which is the correct contraction for 'do not'?", answer: "don't", tags: ['punctuation'] },
                    { question: "What does the prefix 'un-' mean in 'unhappy'?", answer: "not", tags: ['vocabulary'] },
                    { question: "Choose the correctly spelled word: a) seperate b) separate c) seporate", answer: "b", tags: ['spelling'] },
                    { question: "Identify the conjunction: 'I wanted to go, but I was too tired.'", answer: "but", tags: ['grammar'] },
                    { question: "What is the superlative form of 'good'?", answer: "best", tags: ['grammar'] },
                    { question: "Which sentence is in the passive voice?", options: ["The boy threw the ball.", "The ball was thrown by the boy."], answer: "The ball was thrown by the boy.", tags: ['grammar'] },
                    { question: "What is the meaning of the idiom 'bite the bullet'?", answer: "To endure a difficult situation", tags: ['vocabulary'] },
                    { question: "Correct the sentence: 'their going to the store.'", answer: "They're going to the store.", tags: ['grammar'] },
                    { question: "Identify the preposition: 'The cat is under the table.'", answer: "under", tags: ['grammar'] },
                    { question: "What is the collective noun for a group of lions?", answer: "pride", tags: ['vocabulary'] },
                    { question: "Choose the correct homophone: 'I want to go ___, over there.'", options: ["their", "there", "they're"], answer: "there", tags: ['vocabulary'] },
                    { question: "What is the function of an apostrophe in 'the cat's toy'?", answer: "To show possession", tags: ['punctuation'] },
                    { question: "Which word completes the simile: 'as brave as a ___'?", answer: "lion", tags: ['vocabulary'] },
                    // Maths Section (28 Qs)
                    { question: "A football pitch measures 115 metres long and 80 metres wide. The area of a rugby pitch is 6,392 square metres. How many square metres smaller is the area of the rugby pitch than the area of the football pitch?", options: ["9200 m²", "2908 m²", "2809 m²", "2808 m²", "6197 m²"], answer: "2808 m²" },
                    { question: "Convert this measurement: 1701 g = ___ kg", options: ["17.01 kg", "1.701 kg", "170.1 kg", "1.7 kg", "0.1701 kg"], answer: "1.701 kg" },
                    { question: "How many lines of symmetry does a rhombus have?", options: ["0", "1", "2", "3", "4"], answer: "2" },
                    { question: "Which is the most appropriate instrument for measuring the distance around a football?", options: ["trundle wheel", "odometer", "metre stick", "tape measure", "ruler"], answer: "tape measure" },
                    { question: "Ahmed cycled 13 km on Monday and 15 km on Thursday. How much further did he cycle on Thursday than on Monday?", options: ["1 km", "3 km", "5 km", "4 km", "2 km"], answer: "2 km" },
                    { question: "What decimal fraction is equivalent to 3/4?", options: ["0.25", "0.33", "0.20", "0.75", "0.10"], answer: "0.75", tags: ['fractions'] },
                    { question: "A regular hexagon has a side length of 7 cm. A square has the same perimeter as the hexagon. What is the area of the square?", options: ["42 cm²", "100 cm²", "10.5 cm²", "110.25 cm²", "49 cm²"], answer: "110.25 cm²", tags: ['geometry'] },
                    { question: "What is the tenth number in this sequence: 1.5, 3.0, 4.5, 6.0, ...?", options: ["9.0", "12.5", "15", "15.0", "17.5"], answer: "15.0" },
                    { question: "Girls in Years 4, 5, 6, and 7 collected £4, £12, £16, and £17 respectively. What was the average amount collected?", options: ["£12.00", "£12.25", "£12.50", "£10.00", "£13.00"], answer: "£12.25" },
                    { question: "A rectangle's corners are at A(25, 30), B(55, 30), C(55, 14), and D. What are the coordinates of point D?", options: ["(25, 14)", "(55, 30)", "(25, 22)", "(55, 14)", "(40, 14)"], answer: "(25, 14)", tags: ['geometry'] },
                    { question: "By how much is 18.401 greater than 14.1?", options: ["4.3", "3.3", "4.301", "3.301", "4"], answer: "4.301" },
                    { question: "A stack of 20 identical pizza boxes is 160 cm tall. Giovanni removes 3 from the top. How tall is the stack now?", options: ["130 cm", "132 cm", "134 cm", "136 cm", "138 cm"], answer: "136 cm" },
                    { question: "What would be the best unit of measure for recording the amount of water in a paddling pool?", options: ["litres", "mm", "cm", "m³", "ml"], answer: "litres" },
                    { question: "A scale shows a weight between 1.2 kg and 1.3 kg, marked in 10 increments. The pointer is on the 4th mark after 1.2. What is the weight?", options: ["1.21 kg", "1.22 kg", "1.23 kg", "1.24 kg", "1.25 kg"], answer: "1.24 kg" },
                    { question: "b × 6 = 48. What does (b + 2) × 5 equal?", options: ["30", "40", "20", "50", "60"], answer: "50" },
                    { question: "How many vertical lines are in an isosceles trapezium with a vertical line of symmetry drawn through it?", options: ["0", "1", "2", "3", "4"], answer: "1" },
                    { question: "What is 7/10 of £17?", options: ["£9.90", "£10.90", "£11.70", "£11.90", "£12.90"], answer: "£11.90", tags: ['percentages', 'fractions'] },
                    { question: "A chart showing population change over time with points connected by lines is what type of chart?", options: ["Block Graph", "Pie Chart", "Bar Graph", "Bar-Line Graph", "Line Graph"], answer: "Line Graph" },
                    { question: "A rectangle is divided into 8 equal squares. 6 of them are shaded. What fraction is shaded?", options: ["1/4", "3/8", "5/8", "3/4", "7/8"], answer: "3/4", tags: ['fractions'] },
                    { question: "A chart shows temperature ranges. The lowest is -13°C and the highest is 6°C. What is the difference between the highest and lowest temperatures?", options: ["-13°C", "18°C", "19°C", "20°C", "21°C"], answer: "19°C" },
                    { question: "Pattern 1 has 9 blocks. Pattern 2 has 13 blocks. Pattern 3 has 17 blocks. The rule is (Number of blocks) = 4 * PatternNumber + 5. Which pattern will have 49 blocks?", options: ["9", "10", "11", "12", "13"], answer: "11" },
                    { question: "In a sale, everything was reduced by 25%. How much would be saved on an item which usually cost £4.80?", answer: "£1.20", tags: ['percentages'] },
                    { question: "A decision tree sorts numbers. If the number is even, it checks if it's a multiple of 5. If not even, it checks if it's a square number. Which box would the number 64 be put into? (Box A: even, mult of 5. Box B: even, not mult of 5. Box C: odd, square. Box D: odd, not square)", answer: "B" },
                    { question: "What is the missing number in this sequence: 2, 5, 11, 23, ___?", answer: "47" },
                    { question: "A film starts at 19:45 and lasts for 1 hour and 35 minutes. What time does it finish?", answer: "21:20" },
                    { question: "Calculate 3.5 × 8.", answer: "28" },
                    { question: "A bag contains 6 red balls and 10 blue balls. What is the probability of picking a red ball?", answer: "6/16", tags: ['fractions'] },
                    { question: "What is 15% of 300?", answer: "45", tags: ['percentages'] }
                ]
            },
            {
                id: "full-test-2",
                title: "Full Practice Test 2",
                subject: "Mixed",
                notes: "Full-length practice exam 2.",
                questions: [
                    // English Section (28 Qs)
                    { question: "Which sentence is grammatically correct?", options: ["She done her homework.", "She did her homework."], answer: "She did her homework.", tags: ['grammar'] },
                    { question: "What is the plural of 'goose'?", answer: "geese", tags: ['grammar'] },
                    { question: "Identify the adverb: 'The turtle walked slowly.'", answer: "slowly", tags: ['grammar'] },
                    { question: "Choose the correct word: 'The book is on ___ shelf.'", options: ["it's", "its"], answer: "its", tags: ['grammar'] },
                    { question: "What is an antonym for 'ancient'?", options: ["Old", "Modern", "Historic", "Past"], answer: "Modern", tags: ['vocabulary'] },
                    { question: "Which word is a noun?", options: ["beautiful", "ran", "happiness", "quickly"], answer: "happiness", tags: ['grammar'] },
                    { question: "Correct the spelling of 'neccessary'.", answer: "necessary", tags: ['spelling'] },
                    { question: "What does the suffix '-less' mean in 'careless'?", answer: "without", tags: ['vocabulary'] },
                    { question: "Identify the verb in the imperative sentence: 'Close the door.'", answer: "Close", tags: ['grammar'] },
                    { question: "What is the comparative form of 'bad'?", answer: "worse", tags: ['grammar'] },
                    { question: "Which of these is a compound sentence?", options: ["I like tea.", "I like tea and he likes coffee."], answer: "I like tea and he likes coffee.", tags: ['grammar'] },
                    { question: "What is the collective noun for a group of fish?", answer: "school", tags: ['vocabulary'] },
                    { question: "Choose the correct homophone: 'She has a new ___ of shoes.'", options: ["pair", "pare", "pear"], answer: "pair", tags: ['vocabulary'] },
                    { question: "Identify the type of sentence: 'What a beautiful day!'", answer: "Exclamatory", tags: ['punctuation'] },
                    { question: "What is the meaning of the idiom 'spill the beans'?", answer: "To reveal a secret", tags: ['vocabulary'] },
                    { question: "Correct the punctuation: 'Lets eat Grandma'", answer: "Let's eat, Grandma.", tags: ['punctuation'] },
                    { question: "What is the abstract noun in: 'Honesty is the best policy.'?", answer: "Honesty", tags: ['grammar'] },
                    { question: "Which word is spelled correctly?", options: ["wierd", "weird", "weerd"], answer: "weird", tags: ['spelling'] },
                    { question: "Identify the direct object: 'The dog chased the cat.'", answer: "cat", tags: ['grammar'] },
                    { question: "What is the opposite of 'expand'?", answer: "contract", tags: ['vocabulary'] },
                    { question: "Which sentence uses 'who' and 'whom' correctly?", options: ["Who did you give the book to?", "Whom did you give the book to?"], answer: "Whom did you give the book to?", tags: ['grammar'] },
                    { question: "What is the root word of 'unbelievable'?", answer: "believe", tags: ['vocabulary'] },
                    { question: "Identify the simile: 'He is as strong as an ox.'", answer: "as strong as an ox", tags: ['vocabulary'] },
                    { question: "What is the plural of 'cactus'?", answer: "cacti", tags: ['grammar'] },
                    { question: "Choose the correct verb form: 'The news ___ always on at 6.'", options: ["is", "are"], answer: "is", tags: ['grammar'] },
                    { question: "What type of pronoun is 'myself'?", answer: "Reflexive", tags: ['grammar'] },
                    { question: "Correct the sentence: 'I could of gone to the party.'", answer: "I could have gone to the party.", tags: ['grammar'] },
                    { question: "What does the prefix 're-' mean in 'rewrite'?", answer: "again", tags: ['vocabulary'] },
                    // Maths Section (28 Qs)
                    { question: "A baker uses 250g of flour for every cake. How many cakes can he bake with a 5kg bag of flour?", options: ["10", "15", "20", "25", "30"], answer: "20" },
                    { question: "What is the value of x if 4x + 5 = 25?", options: ["3", "4", "5", "6", "7"], answer: "5" },
                    { question: "A train travels at 60 mph. How long does it take to travel 150 miles?", options: ["2 hours", "2.5 hours", "3 hours", "3.5 hours", "4 hours"], answer: "2.5 hours" },
                    { question: "What is the next prime number after 19?", options: ["20", "21", "22", "23", "24"], answer: "23" },
                    { question: "A rectangle has a perimeter of 30 cm. Its length is 10 cm. What is its width?", options: ["5 cm", "6 cm", "7 cm", "8 cm", "10 cm"], answer: "5 cm", tags: ['geometry'] },
                    { question: "Simplify the ratio 18:24.", options: ["2:3", "3:4", "4:5", "5:6", "6:7"], answer: "3:4" },
                    { question: "What is 0.25 as a percentage?", options: ["2.5%", "25%", "250%", "0.025%", "0.25%"], answer: "25%", tags: ['percentages'] },
                    { question: "A circle has a radius of 5 cm. What is its diameter?", options: ["5 cm", "10 cm", "15 cm", "20 cm", "25 cm"], answer: "10 cm", tags: ['geometry'] },
                    { question: "Find the mean of these numbers: 4, 6, 8, 10.", options: ["5", "6", "7", "8", "9"], answer: "7" },
                    { question: "If a = 3 and b = 4, what is the value of 2a + 3b?", options: ["15", "16", "17", "18", "19"], answer: "18" },
                    { question: "How many degrees are in a right angle?", options: ["45", "90", "180", "270", "360"], answer: "90", tags: ['geometry'] },
                    { question: "What is the square root of 144?", options: ["10", "11", "12", "13", "14"], answer: "12" },
                    { question: "A map has a scale of 1:10000. A distance on the map is 5 cm. What is the real distance in metres?", options: ["50m", "500m", "5000m", "50000m", "5m"], answer: "500m" },
                    { question: "What is the area of a triangle with a base of 10 cm and a height of 6 cm?", options: ["20 cm²", "30 cm²", "40 cm²", "50 cm²", "60 cm²"], answer: "30 cm²", tags: ['geometry'] },
                    { question: "Convert 2.5 hours into minutes.", options: ["120", "130", "140", "150", "160"], answer: "150" },
                    { question: "What is the mode of this set of numbers: 2, 3, 3, 4, 5, 5, 5, 6?", options: ["2", "3", "4", "5", "6"], answer: "5" },
                    { question: "A cube has a volume of 27 cm³. What is the length of one side?", options: ["2 cm", "3 cm", "4 cm", "5 cm", "6 cm"], answer: "3 cm", tags: ['geometry'] },
                    { question: "What is 3/5 as a decimal?", options: ["0.3", "0.4", "0.5", "0.6", "0.7"], answer: "0.6", tags: ['fractions'] },
                    { question: "A car journey starts at 08:30 and ends at 11:15. How long was the journey?", options: ["2h 15m", "2h 30m", "2h 45m", "3h 00m", "3h 15m"], answer: "2h 45m" },
                    { question: "Increase £50 by 20%.", options: ["£52", "£55", "£58", "£60", "£62"], answer: "£60", tags: ['percentages'] },
                    { question: "What is the sum of the angles in a quadrilateral?", options: ["90°", "180°", "270°", "360°", "540°"], answer: "360°", tags: ['geometry'] },
                    { question: "Write 0.05 as a fraction in its simplest form.", answer: "1/20", tags: ['fractions'] },
                    { question: "A book costs £8.50. There is a 10% discount. What is the new price?", answer: "£7.65", tags: ['percentages'] },
                    { question: "How many faces does a triangular prism have?", answer: "5", tags: ['geometry'] },
                    { question: "What is the next number in the Fibonacci sequence: 1, 1, 2, 3, 5, 8, ___?", answer: "13" },
                    { question: "Calculate 1/4 + 3/8.", answer: "5/8", tags: ['fractions'] },
                    { question: "A square has an area of 64 cm². What is its perimeter?", answer: "32 cm", tags: ['geometry'] },
                    { question: "What is the largest factor of 24 (other than 24)?", answer: "12" }
                ]
            },
        ];
        
        // --- Achievements Data ---
        const achievementsList = [
            // Mastery Badges
            { id: 'fractionFanatic', title: 'Fraction Fanatic', description: 'Answer 50 questions involving fractions correctly.', category: 'Mastery', unlocksTitle: 'The Denominator' },
            { id: 'vocabularyVirtuoso', title: 'Vocabulary Virtuoso', description: 'Correctly answer 100 vocabulary-based English questions.', category: 'Mastery', unlocksTitle: 'The Lexicographer' },
            { id: 'geometryGuru', title: 'Geometry Guru', description: 'Achieve a 90% or higher score on three different tests that include geometry questions.', category: 'Mastery', unlocksTitle: 'The Shape Shifter' },
            { id: 'punctuationPro', title: 'Punctuation Pro', description: 'Correctly answer 25 questions related to punctuation.', category: 'Mastery', unlocksTitle: 'Captain Comma' },
            // Performance Badges
            { id: 'speedDemon', title: 'Speed Demon', description: 'Finish any test with more than half the time remaining (Test Mode only).', category: 'Performance', unlocksTitle: 'The Flash' },
            { id: 'comebackKid', title: 'Comeback Kid', description: 'After getting a question wrong, answer the next three correctly.', category: 'Performance', unlocksTitle: 'The Unstoppable' },
            { id: 'clutchPerformer', title: 'Clutch Performer', description: 'Correctly answer the final question of a 56-question "Full Practice Test."', category: 'Performance', unlocksTitle: 'The Finisher' },
            // Consistency Badges
            { id: 'weeklyWarrior', title: 'Weekly Warrior', description: 'Complete at least one test every week for a month.', category: 'Consistency', unlocksTitle: 'The Consistent' },
            { id: 'dedicatedDabbler', title: 'Dedicated Dabbler', description: 'Log in and complete the "Daily Challenge" for 7 days in a row.', category: 'Consistency', unlocksTitle: 'The Dedicated' },
            { id: 'centuryClub', title: 'Century Club', description: 'Correctly answer 100 total questions across all tests.', category: 'Consistency', unlocksTitle: 'Centurion' },
            { id: 'marathonRunner', title: 'Marathon Runner', description: 'Complete all available "Full Practice Tests" at least once.', category: 'Consistency', unlocksTitle: 'The Marathoner' },
        ];


        // --- Helper Components ---
        const LoadingSpinner = ({ message }) => (
            <div className="flex flex-col justify-center items-center h-screen bg-slate-900">
                <div className="animate-spin rounded-full h-32 w-32 border-t-4 border-b-4 border-cyan-400 mb-4"></div>
                <p className="text-lg text-cyan-400 font-orbitron">{message}</p>
            </div>
        );
        
        const CharacterMessage = ({ message, character }) => {
            const characters = { GameMaster: "🎮" };
            return (
                <div className="bg-slate-800 border-l-4 border-cyan-400 text-cyan-100 p-4 my-6 rounded-r-lg shadow-lg flex items-center">
                    <span className="text-4xl mr-4">{characters[character] || '🤖'}</span>
                    <p className="font-semibold">{message}</p>
                </div>
            );
        };

        const Notification = ({ message, type, onDismiss }) => {
            useEffect(() => {
                const timer = setTimeout(onDismiss, 3000);
                return () => clearTimeout(timer);
            }, [onDismiss]);

            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            return (
                <div className={`notification-bar p-4 rounded-lg text-white font-bold shadow-lg ${bgColor}`}>
                    {message}
                </div>
            );
        };

        const Modal = ({ title, message, onConfirm, onCancel, confirmText, children }) => (
            <div className="modal-backdrop">
                <div className="bg-slate-800 border border-cyan-500 rounded-xl shadow-2xl p-8 w-full max-w-md text-center">
                    <h2 className="text-2xl font-bold font-orbitron text-cyan-300 mb-4">{title}</h2>
                    {message && <p className="text-slate-300 mb-8">{message}</p>}
                    {children}
                    <div className="flex justify-center gap-4 mt-8">
                        {onCancel && <button onClick={onCancel} className="bg-slate-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-slate-500">Cancel</button>}
                        {onConfirm && <button onClick={onConfirm} className={`font-bold py-2 px-6 rounded-lg ${confirmText === 'Awesome!' || confirmText === 'Start' ? 'bg-green-600 hover:bg-green-500' : 'bg-red-600 hover:bg-red-500'}`}>{confirmText}</button>}
                    </div>
                </div>
            </div>
        );

        // --- Main App Components ---
        const Dashboard = ({ userData, setView, setSelectedTest, allTests, showModal, hideModal, updateUserData, appData, updateAllData, showNotification }) => {
            const xpForNextLevel = userData.level * 100;
            const xpPercent = (userData.xp / xpForNextLevel) * 100;

            const handleSelectTest = (testId) => {
                showModal({
                    title: "Choose Your Mode",
                    children: (
                        <div className="space-y-4">
                            <button onClick={() => { setSelectedTest({ id: testId, settings: { mode: 'Practice' } }); setView('quiz'); hideModal(); }} className="w-full text-left p-4 bg-cyan-700 hover:bg-cyan-600 rounded-lg">
                                <h3 className="font-bold text-cyan-200">Practice Mode</h3>
                                <p className="text-sm text-slate-300">No timer, hints enabled, and live feedback on your answers.</p>
                            </button>
                            <button onClick={() => { setSelectedTest({ id: testId, settings: { mode: 'Test' } }); setView('quiz'); hideModal(); }} className="w-full text-left p-4 bg-yellow-700 hover:bg-yellow-600 rounded-lg">
                                <h3 className="font-bold text-yellow-200">Test Mode</h3>
                                <p className="text-sm text-slate-300">A timer will run, hints are disabled, and results are shown only at the end.</p>
                            </button>
                        </div>
                    ),
                    onCancel: () => {} // Just to show the cancel button
                });
            };

            if (!userData) return <LoadingSpinner message="Loading user data..." />;
            
            const handleDailyChallenge = () => {
                let allQuestions = allTests.flatMap(test => test.questions);
                const dailyQuestions = allQuestions.sort(() => 0.5 - Math.random()).slice(0, 5);
                const challengeTest = {
                    id: 'daily-challenge',
                    title: 'Daily Challenge',
                    subject: 'Mixed',
                    questions: dailyQuestions
                };
                updateAllData({ ...appData, allTests: [...allTests.filter(t => t.id !== 'daily-challenge'), challengeTest] });
                setSelectedTest({ id: 'daily-challenge', settings: { mode: 'Practice' } });
                setView('quiz');
            };

            const handlePracticeMistakes = () => {
                const incorrectQuestions = [];
                const seenQuestions = new Set();

                Object.values(userData.progress || {}).forEach(progressData => {
                    const test = allTests.find(t => t.id === Object.keys(userData.progress).find(key => userData.progress[key] === progressData));
                    if (test) {
                        Object.entries(progressData.answers).forEach(([qIndex, userAnswer]) => {
                            const question = test.questions[qIndex];
                            if (question && question.answer !== userAnswer && !seenQuestions.has(question.question)) {
                                incorrectQuestions.push(question);
                                seenQuestions.add(question.question);
                            }
                        });
                    }
                });

                if (incorrectQuestions.length === 0) {
                    showNotification({message: "No mistakes to practice. Great job!", type: "success"});
                    return;
                }

                const mistakesTest = {
                    id: 'mistakes-test',
                    title: 'Practice Your Mistakes',
                    subject: 'Mixed',
                    questions: incorrectQuestions
                };
                
                updateAllData({ ...appData, allTests: [...allTests.filter(t => t.id !== 'mistakes-test'), mistakesTest] });
                setSelectedTest({ id: 'mistakes-test', settings: { mode: 'Practice' } });
                setView('quiz');
            };

            const hasMistakes = Object.values(userData.progress || {}).some(p => p.score < Object.keys(p.answers).length);


            return (
                <div className="p-4 sm:p-8 min-h-screen">
                    <div className="max-w-7xl mx-auto">
                        <div className="flex flex-wrap justify-between items-center mb-4 gap-4">
                            <h1 className="text-3xl sm:text-4xl font-bold font-orbitron glowing-text text-cyan-300 flex items-center">
                                <span className="text-5xl mr-4">{userData.avatar || '👨‍🚀'}</span>
                                Welcome, {userData.name}! {userData.title && <span className="text-lg ml-4 bg-yellow-500/20 text-yellow-300 px-3 py-1 rounded-full border border-yellow-500">{userData.title}</span>}
                            </h1>
                            <div className="flex gap-2">
                                <button onClick={() => setView('settings')} className="bg-slate-700 text-cyan-300 font-semibold py-2 px-4 rounded-lg hover:bg-slate-600 transition-colors">Profile</button>
                                <button onClick={() => setView('achievements')} className="bg-slate-700 text-cyan-300 font-semibold py-2 px-4 rounded-lg hover:bg-slate-600 transition-colors">Achievements</button>
                                <button onClick={() => setView('admin')} className="bg-slate-700 text-cyan-300 font-semibold py-2 px-4 rounded-lg hover:bg-slate-600 transition-colors">Admin Panel</button>
                            </div>
                        </div>

                        {/* XP and Level System */}
                        <div className="bg-slate-800/50 border border-slate-700 rounded-xl p-4 mb-8">
                            <div className="flex justify-between items-center mb-2 font-orbitron">
                                <span className="font-bold text-cyan-300">Level {userData.level}</span>
                                <span className="text-sm text-slate-400">{userData.xp} / {xpForNextLevel} XP</span>
                            </div>
                            <div className="w-full bg-slate-700 rounded-full h-4 border-2 border-slate-600">
                                <div className="bg-gradient-to-r from-cyan-500 to-blue-500 h-full rounded-full transition-all duration-500" style={{ width: `${xpPercent}%` }}></div>
                            </div>
                        </div>

                        {/* Daily Challenge & Practice Mistakes Section */}
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                            <div className="bg-slate-800/50 border-2 border-purple-500 rounded-xl p-6 shadow-lg">
                                <div className="flex justify-between items-center">
                                    <div>
                                        <h2 className="text-2xl font-orbitron text-purple-300">Daily Challenge</h2>
                                        <p className="text-slate-400">A quick warm-up to get you started!</p>
                                    </div>
                                    <div className="text-center">
                                        <div className="text-4xl">🔥</div>
                                        <div className="font-bold text-xl">{userData.dailyChallengeStreak || 0} Day Streak</div>
                                    </div>
                                </div>
                                <div className="mt-4">
                                    {userData.dailyChallenge?.completedToday ? (
                                        <p className="text-center text-green-400 font-bold p-3 bg-slate-800 rounded-lg">Challenge Complete! Come back tomorrow.</p>
                                    ) : (
                                        <button onClick={handleDailyChallenge} className="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-500">Start Daily Challenge</button>
                                    )}
                                </div>
                            </div>
                            <div className="bg-slate-800/50 border-2 border-orange-500 rounded-xl p-6 shadow-lg">
                                <h2 className="text-2xl font-orbitron text-orange-300">Review Mistakes</h2>
                                <p className="text-slate-400 mb-4">Tackle the questions you've gotten wrong before.</p>
                                <button onClick={handlePracticeMistakes} disabled={!hasMistakes} className="w-full bg-orange-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-orange-500 disabled:bg-slate-600 disabled:cursor-not-allowed">
                                    Practice Your Mistakes
                                </button>
                            </div>
                        </div>

                        <CharacterMessage message="Ready to ace these tests? Let's get started!" character="GameMaster" />
                        
                        <div className="bg-slate-800/50 border border-slate-700 rounded-xl shadow-lg p-6">
                            <h2 className="text-2xl font-bold font-orbitron text-cyan-300 mb-6">Available Tests</h2>
                            {allTests.length > 0 ? (
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    {allTests.filter(t => !t.isBoss).map(test => (
                                        <TestCard key={test.id} testId={test.id} test={test} onStart={() => handleSelectTest(test.id)} progress={userData.progress?.[test.id]} />
                                    ))}
                                </div>
                            ) : (
                                <p className="text-slate-400">No tests found. Create one in the Admin Panel.</p>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const TestCard = ({ testId, test, onStart, progress }) => {
            const questionsCount = test.questions.length;
            const answeredCount = progress ? Object.keys(progress.answers || {}).length : 0;
            const progressPercent = questionsCount > 0 ? (answeredCount / questionsCount) * 100 : 0;

            return (
                <div className="bg-slate-800 border border-slate-700 rounded-lg p-5 flex flex-col justify-between hover:border-cyan-400 hover:shadow-cyan-500/10 hover:shadow-lg transition-all">
                    <div>
                        <h3 className="text-xl font-bold font-orbitron text-cyan-300">{test.title}</h3>
                        <p className="text-slate-400 mb-4">{test.subject} - {questionsCount} Questions</p>
                        <div className="w-full bg-slate-700 rounded-full h-2.5 mb-2">
                            <div className="bg-cyan-400 h-2.5 rounded-full" style={{ width: `${progressPercent}%` }}></div>
                        </div>
                        <p className="text-sm text-slate-400 mb-4">{answeredCount} / {questionsCount} answered</p>
                    </div>
                    <button onClick={onStart} className="w-full bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-500 transition-colors">
                        {answeredCount > 0 && answeredCount < questionsCount ? 'Continue Test' : 'Start Test'}
                    </button>
                </div>
            );
        };
        
        const QuizView = ({ userData, testDetails, setView, allTests, updateUserData, showNotification, showModal }) => {
            const { id: testId, settings } = testDetails;
            const test = allTests.find(t => t.id === testId);

            const [currentQuestionIndex, setCurrentQuestionIndex] = useState(userData?.progress?.[testId]?.lastQuestionIndex || 0);
            const [userAnswers, setUserAnswers] = useState(userData?.progress?.[testId]?.answers || {});
            const [submittedAnswers, setSubmittedAnswers] = useState({});
            const [streak, setStreak] = useState(userData?.progress?.[testId]?.streak || 0);
            const [hint, setHint] = useState(null);
            const [isHintLoading, setIsHintLoading] = useState(false);
            const [feedback, setFeedback] = useState(null);
            const [flash, setFlash] = useState(null);

            const getInitialTime = () => {
                const savedTime = userData?.progress?.[testId]?.timeLeft;
                const totalTime = test.subject === 'Mixed' ? 60 * 60 : 30 * 60;
                return (savedTime !== undefined && savedTime > 0) ? savedTime : totalTime;
            };
            const [timeLeft, setTimeLeft] = useState(getInitialTime);
            const [isPaused, setIsPaused] = useState(false);

            useEffect(() => {
                if (isPaused || !timeLeft || settings.mode === 'Practice') return;
                const intervalId = setInterval(() => setTimeLeft(t => t > 0 ? t - 1 : 0), 1000);
                return () => clearInterval(intervalId);
            }, [timeLeft, isPaused, settings.mode]);
            
            const calculateScore = useCallback(() => Object.entries(userAnswers).reduce((acc, [index, answer]) => (test.questions[index]?.answer === answer ? acc + 1 : acc), 0), [userAnswers, test.questions]);

            const saveProgress = useCallback((isFinished = false) => {
                const score = calculateScore();
                let newUserData = { ...userData };
                
                if (isFinished) {
                    if (settings.mode === 'Test') {
                        newUserData.xp = (newUserData.xp || 0) + score;
                    }
                }
                
                const newProgress = { ...newUserData.progress, [testId]: { answers: userAnswers, lastQuestionIndex: currentQuestionIndex, score: score, timeLeft: timeLeft, streak: streak, settings: settings } };
                newUserData.progress = newProgress;
                
                updateUserData(newUserData);
            }, [userData, testId, userAnswers, currentQuestionIndex, calculateScore, timeLeft, streak, settings, updateUserData]);


            const handleAnswerSelect = (answer) => {
                const newAnswers = { ...userAnswers, [currentQuestionIndex]: answer };
                setUserAnswers(newAnswers);
            };

            const handleSubmitAnswer = () => {
                const answer = userAnswers[currentQuestionIndex];
                if (!answer) return;

                setSubmittedAnswers({...submittedAnswers, [currentQuestionIndex]: true});

                const isCorrect = test.questions[currentQuestionIndex].answer === answer;
                
                let newUserData = { ...userData };
                
                if (isCorrect) {
                    newUserData.totalCorrectAnswers = (newUserData.totalCorrectAnswers || 0) + 1;
                    
                    const tags = test.questions[currentQuestionIndex].tags || [];
                    tags.forEach(tag => {
                        newUserData.correctAnswersByTag[tag] = (newUserData.correctAnswersByTag[tag] || 0) + 1;
                    });

                    if (newUserData.lastAnswerWasIncorrect) {
                        newUserData.consecutiveCorrectAfterWrong = (newUserData.consecutiveCorrectAfterWrong || 0) + 1;
                    }
                    newUserData.lastAnswerWasIncorrect = false;
                } else {
                    newUserData.lastAnswerWasIncorrect = true;
                    newUserData.consecutiveCorrectAfterWrong = 0;
                }
                
                updateUserData(newUserData);

                const newStreak = isCorrect ? streak + 1 : 0;
                setStreak(newStreak);

                setFlash(isCorrect ? 'correct' : 'incorrect');
                setTimeout(() => setFlash(null), 500);

                if (settings.mode === 'Practice') {
                    setFeedback(isCorrect ? "Correct! Great job!" : `Not quite. The correct answer is: ${test.questions[currentQuestionIndex].answer}`);
                }
            };

            const goToNext = () => {
                if (currentQuestionIndex < test.questions.length - 1) {
                    setFeedback(null);
                    setHint(null);
                    setCurrentQuestionIndex(i => i + 1);
                }
            };

            const handleFinish = () => { 
                saveProgress(true); 
                setView('results'); 
            };
            const handlePause = () => { 
                setIsPaused(true); 
                saveProgress(); 
                showNotification({message: 'Progress saved!', type: 'success'});
                setView('dashboard'); 
            };

            const fetchHint = async () => {
                setIsHintLoading(true);
                setHint(null);
                const question = test.questions[currentQuestionIndex];
                const prompt = `You are a helpful teaching assistant for a 10-year-old student. Provide a short, simple hint for the following question. Do NOT give the answer. Just provide a small clue to help the student think about the problem correctly. Question: "${question.question}"`;
                
                try {
                    if (!GEMINI_API_KEY) {
                        throw new Error("API Key is missing.");
                    }
                    let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                    const payload = { contents: chatHistory };
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.json();
                        throw new Error(`API Error: ${errorBody.error.message}`);
                    }

                    const result = await response.json();
                    const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (text) {
                        setHint(text);
                    } else {
                        throw new Error("Invalid API response structure.");
                    }
                } catch (error) {
                    console.error("Error fetching hint:", error);
                    showModal({
                        title: "AI Feature Error",
                        message: `Could not get a hint. Please check the API Key and connection. Error: ${error.message}`,
                        onConfirm: () => {},
                        confirmText: "OK"
                    });
                    setHint("Sorry, could not get a hint at this time.");
                } finally {
                    setIsHintLoading(false);
                }
            };

            if (!test) return <LoadingSpinner message="Loading Test..." />;
            const currentQ = test.questions[currentQuestionIndex];
            const isCurrentQSubmitted = !!submittedAnswers[currentQuestionIndex];
            
            useEffect(() => {
                saveProgress();
            }, [userAnswers, currentQuestionIndex]);
            
            return (
                <div className={`p-4 sm:p-8 min-h-screen flex items-center justify-center ${flash === 'correct' ? 'flash-correct' : ''} ${flash === 'incorrect' ? 'flash-incorrect' : ''}`}>
                    <div className="bg-slate-800 border border-slate-700 rounded-xl shadow-2xl p-6 sm:p-8 w-full max-w-4xl">
                        <div className="flex justify-between items-center mb-2">
                            <h2 className="text-xl sm:text-2xl font-bold font-orbitron text-cyan-300">{test.title}</h2>
                            {streak > 1 && <span className="text-lg text-orange-400 font-orbitron">🔥 {streak} Streak!</span>}
                            {settings.mode === 'Test' && <div className="text-lg sm:text-xl font-mono bg-slate-900 text-cyan-300 px-4 py-2 rounded-lg glowing-border">{Math.floor(timeLeft / 60)}:{('0' + timeLeft % 60).slice(-2)}</div>}
                        </div>
                        <p className="text-center font-mono text-slate-400 mb-4">Question {currentQuestionIndex + 1} of {test.questions.length}</p>
                        <div className="mb-6 min-h-[6rem]"><p className="text-lg text-gray-300">{currentQ.question}</p></div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            {currentQ.options ? currentQ.options.map((option, index) => (
                                <button key={index} onClick={() => handleAnswerSelect(option)} disabled={isCurrentQSubmitted} className={`p-4 rounded-lg border-2 text-left transition-all ${userAnswers[currentQuestionIndex] === option ? 'bg-cyan-900 border-cyan-400' : 'bg-slate-700 border-slate-600 hover:bg-slate-600'} ${isCurrentQSubmitted ? 'cursor-not-allowed opacity-70' : ''}`}>{option}</button>
                            )) : <textarea value={userAnswers[currentQuestionIndex] || ''} onChange={(e) => handleAnswerSelect(e.target.value)} disabled={isCurrentQSubmitted} className="w-full col-span-2 p-4 bg-slate-700 border-2 border-slate-600 rounded-lg disabled:opacity-70" placeholder="Type your answer here..." rows="4"></textarea>}
                        </div>

                        {!isCurrentQSubmitted && (
                            <div className="text-center my-4">
                                <button onClick={handleSubmitAnswer} disabled={!userAnswers[currentQuestionIndex]} className="bg-green-600 text-white font-bold py-2 px-8 rounded-lg hover:bg-green-500 disabled:bg-slate-600 disabled:cursor-not-allowed">Submit Answer</button>
                            </div>
                        )}

                        <div className="my-4 text-center">
                            {settings.mode === 'Practice' && <button onClick={fetchHint} disabled={isHintLoading || hint} className="text-sm text-cyan-400 hover:text-cyan-200 disabled:opacity-50 disabled:cursor-not-allowed">
                                {isHintLoading ? '✨ Generating Hint...' : (hint ? 'Hint Revealed!' : '✨ Get a Hint')}
                            </button>}
                            {hint && <div className="mt-2 p-3 bg-slate-700 border border-slate-600 text-yellow-300 rounded-lg text-sm">{hint}</div>}
                        </div>

                        {feedback && <div className={`p-4 rounded-lg my-4 text-white ${feedback.startsWith('Correct') ? 'bg-green-500' : 'bg-red-500'}`}>{feedback}</div>}
                        <div className="flex justify-between mt-8">
                            <button onClick={handlePause} className="bg-yellow-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-yellow-500">Pause & Save</button>
                            {currentQuestionIndex < test.questions.length - 1 ? (
                                <button onClick={goToNext} disabled={!isCurrentQSubmitted} className="bg-cyan-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-cyan-500 disabled:bg-slate-600 disabled:cursor-not-allowed">Next</button>
                            ) : (
                                <button onClick={handleFinish} disabled={!isCurrentQSubmitted} className="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-500 disabled:bg-slate-600 disabled:cursor-not-allowed">Finish Test</button>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const ResultsView = ({ userData, setView, testDetails, allTests }) => {
            const { id: testId } = testDetails;
            const test = allTests.find(t => t.id === testId);
            const userAnswers = userData.progress[testId].answers;
            const score = userData.progress[testId].score;
            const [aiFeedback, setAiFeedback] = useState('');
            const [isFeedbackLoading, setIsFeedbackLoading] = useState(false);
            const [conceptExplanations, setConceptExplanations] = useState({});
            const [isLoadingExplanation, setIsLoadingExplanation] = useState(null);


            const getAIFeedback = async () => {
                setIsFeedbackLoading(true);
                const incorrectQuestions = test.questions.filter((q, i) => userAnswers[i] !== q.answer);
                const prompt = `My son, Nicolas, just completed a test. He scored ${score} out of ${test.questions.length}. Here are the questions he got wrong: ${JSON.stringify(incorrectQuestions)}. Please provide a short, encouraging summary of his performance. Highlight his strengths based on the questions he likely got right, and gently point out one or two common themes or topics from the incorrect answers that he could focus on next time. Keep the tone positive and motivating for a 10-year-old.`;

                try {
                    let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                    const payload = { contents: chatHistory };
                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    const result = await response.json();
                    const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                    if(text) setAiFeedback(text); else throw new Error();
                } catch (error) {
                    setAiFeedback("Sorry, couldn't generate feedback at this time.");
                } finally {
                    setIsFeedbackLoading(false);
                }
            };
            
            const getConceptExplanation = async (question, index) => {
                setIsLoadingExplanation(index);
                const prompt = `Please explain the concept behind this question for a 10-year-old. Question: "${question.question}". Correct Answer: "${question.answer}". Keep it simple and clear.`;
                try {
                    let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                    const payload = { contents: chatHistory };
                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    const result = await response.json();
                    const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                    if(text) setConceptExplanations(prev => ({...prev, [index]: text})); else throw new Error();
                } catch (error) {
                    setConceptExplanations(prev => ({...prev, [index]: "Sorry, couldn't get an explanation."}));
                } finally {
                    setIsLoadingExplanation(null);
                }
            };


            if (!test) return <LoadingSpinner message="Loading Results..." />;

            return (
                <div className="p-4 sm:p-8 min-h-screen">
                    <div className="max-w-4xl mx-auto">
                        <div className="bg-slate-800 border border-slate-700 rounded-xl shadow-2xl p-6 sm:p-8 w-full">
                            <h2 className="text-4xl font-bold text-cyan-300 font-orbitron mb-2 text-center">Test Complete!</h2>
                            <p className="text-2xl text-center mb-4">You scored: <span className="font-bold text-yellow-400">{score} / {test.questions.length}</span></p>
                            
                            <div className="text-center my-6">
                                <button onClick={getAIFeedback} disabled={isFeedbackLoading} className="bg-purple-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-purple-500 disabled:bg-slate-600">
                                    {isFeedbackLoading ? '✨ Analyzing Performance...' : '✨ Get AI Feedback'}
                                </button>
                            </div>
                            
                            {aiFeedback && (
                                <div className="bg-slate-700/50 p-4 rounded-lg my-4 border border-slate-600">
                                    <h3 className="font-bold font-orbitron text-purple-300 mb-2">Performance Review</h3>
                                    <p className="text-slate-300 whitespace-pre-wrap">{aiFeedback}</p>
                                </div>
                            )}

                            <div className="space-y-4 mt-8">
                                {test.questions.map((q, index) => {
                                    const userAnswer = userAnswers[index];
                                    const isCorrect = userAnswer === q.answer;
                                    return (
                                        <div key={index} className={`p-4 rounded-lg border-l-4 ${isCorrect ? 'bg-green-900/40 border-green-500' : 'bg-red-900/40 border-red-500'}`}>
                                            <p className="font-semibold text-slate-300 mb-2">{index + 1}. {q.question}</p>
                                            <p className={`text-sm ${isCorrect ? 'text-green-400' : 'text-red-400'}`}>Your answer: <span className="font-bold">{userAnswer || "Not answered"}</span></p>
                                            {!isCorrect && <p className="text-sm text-yellow-400">Correct answer: <span className="font-bold">{q.answer}</span></p>}
                                            {!isCorrect && (
                                                <div className="mt-2">
                                                    <button onClick={() => getConceptExplanation(q, index)} disabled={isLoadingExplanation === index} className="text-xs text-cyan-400 hover:text-cyan-200 disabled:opacity-50">
                                                        {isLoadingExplanation === index ? '✨ Explaining...' : '✨ Explain Concept'}
                                                    </button>
                                                    {conceptExplanations[index] && <p className="text-xs mt-1 p-2 bg-slate-700 rounded">{conceptExplanations[index]}</p>}
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>

                            <div className="text-center mt-8">
                                <button onClick={() => setView('dashboard')} className="bg-cyan-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-cyan-500">Back to Dashboard</button>
                            </div>
                        </div>
                    </div>
                </div>
            )
        };

        const AdminView = ({ userData, setView, allTests, updateAllData, showModal, showNotification }) => {
            const [adminView, setAdminView] = useState('main');
            const [editingTest, setEditingTest] = useState(null);

            const handleResetProgress = (testId) => {
                showModal({
                    title: "Reset Progress?",
                    message: `Are you sure you want to reset all progress for this test? This action cannot be undone.`,
                    confirmText: "Reset",
                    onConfirm: () => {
                        const newProgress = { ...userData.progress };
                        delete newProgress[testId];
                        updateAllData({ userData: { ...userData, progress: newProgress }, allTests });
                        showNotification({message: "Progress reset successfully!", type: 'success'});
                    }
                });
            };

            const handleDeleteTest = (testId) => {
                showModal({
                    title: "Delete Test?",
                    message: `Are you sure you want to permanently delete this test? This action cannot be undone.`,
                    confirmText: "Delete",
                    onConfirm: () => {
                        const newAllTests = allTests.filter(t => t.id !== testId);
                        const newProgress = { ...userData.progress };
                        delete newProgress[testId];
                        updateAllData({ userData: { ...userData, progress: newProgress }, allTests: newAllTests });
                        showNotification({message: "Test deleted successfully!", type: 'success'});
                    }
                });
            };

            const handleEditTest = (test) => {
                setEditingTest(test);
                setAdminView('create');
            }
            
            if (adminView === 'create') {
                return <CreateTestView setAdminView={setAdminView} allTests={allTests} updateAllData={updateAllData} userData={userData} showNotification={showNotification} editingTest={editingTest} setEditingTest={setEditingTest} showModal={showModal} />;
            }
            
            if (adminView === 'analysis') {
                return <ProblemAnalysisView setAdminView={setAdminView} userData={userData} allTests={allTests} />;
            }

            return (
                <div className="p-8 min-h-screen">
                    <div className="max-w-5xl mx-auto">
                        <div className="flex justify-between items-center mb-8">
                            <h1 className="text-4xl font-bold font-orbitron text-cyan-300">Admin Panel</h1>
                            <button onClick={() => setView('dashboard')} className="bg-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-600">&larr; Back to Dashboard</button>
                        </div>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                            <button onClick={() => { setEditingTest(null); setAdminView('create'); }} className="bg-green-600 text-white p-6 rounded-lg font-bold text-xl hover:bg-green-500">Create New Test</button>
                            <button onClick={() => setAdminView('analysis')} className="bg-purple-600 text-white p-6 rounded-lg font-bold text-xl hover:bg-purple-500">Problem Analysis</button>
                        </div>

                        <div className="bg-slate-800/50 border border-slate-700 rounded-xl p-6">
                            <h2 className="text-2xl font-bold mb-4 font-orbitron text-cyan-300">Manage Tests</h2>
                            <div className="space-y-4">
                                {allTests.map(test => (
                                    <div key={test.id} className="bg-slate-800 p-4 rounded-lg flex flex-wrap justify-between items-center gap-4">
                                        <div><h3 className="text-lg font-bold">{test.title}</h3><p className="text-slate-400">{test.questions.length} questions</p></div>
                                        <div className="flex gap-2">
                                            <button onClick={() => handleEditTest(test)} className="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Edit</button>
                                            <button onClick={() => handleDeleteTest(test.id)} className="bg-red-800 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700">Delete</button>
                                            <button onClick={() => handleResetProgress(test.id)} className="bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-yellow-700">Reset Progress</button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                         <div className="bg-slate-800/50 border border-slate-700 rounded-xl p-6 mt-8">
                            <h2 className="text-xl font-bold mb-4 font-orbitron text-cyan-300">Data Warning</h2>
                            <p className="text-slate-400">All progress and created tests are saved in this browser's local storage. Clearing browser data will erase everything.</p>
                        </div>
                    </div>
                </div>
            );
        };
        
        const CreateTestView = ({ setAdminView, allTests, updateAllData, userData, showNotification, editingTest, setEditingTest, showModal }) => {
            const [title, setTitle] = useState(editingTest?.title || '');
            const [subject, setSubject] = useState(editingTest?.subject || 'Maths');
            const [notes, setNotes] = useState(editingTest?.notes || '');
            const [questions, setQuestions] = useState(editingTest?.questions || [{ question: '', options: ['', '', '', ''], answer: '' }]);
            const [isParsing, setIsParsing] = useState(false);
            const [bulkText, setBulkText] = useState('');
            const [aiTopic, setAiTopic] = useState('');
            const [aiNumQuestions, setAiNumQuestions] = useState(10);

            const handleQuestionChange = (index, field, value) => {
                const newQuestions = [...questions];
                newQuestions[index][field] = value;
                setQuestions(newQuestions);
            };
            
            const handleOptionChange = (qIndex, oIndex, value) => {
                const newQuestions = [...questions];
                if (!newQuestions[qIndex].options) newQuestions[qIndex].options = ['', '', '', ''];
                newQuestions[qIndex].options[oIndex] = value;
                setQuestions(newQuestions);
            };

            const addQuestion = () => {
                setQuestions([...questions, { question: '', options: ['', '', '', ''], answer: '' }]);
            };
            
            const handleSaveTest = () => {
                if (!title || questions.some(q => !q.question || !q.answer)) {
                    showNotification({message: "Title and all question fields are required.", type: 'error'});
                    return;
                }

                if (editingTest) {
                    // Update existing test
                    const updatedTest = { ...editingTest, title, subject, questions, notes };
                    const newAllTests = allTests.map(t => t.id === editingTest.id ? updatedTest : t);
                    updateAllData({ userData, allTests: newAllTests });
                    showNotification({message: "Test updated successfully!", type: 'success'});
                } else {
                    // Create new test
                    const newTest = { id: `custom-${Date.now()}`, title, subject, questions, notes };
                    const newAllTests = [...allTests, newTest];
                    updateAllData({ userData, allTests: newAllTests });
                    showNotification({message: "Test created successfully!", type: 'success'});
                }
                setEditingTest(null);
                setAdminView('main');
            };

            const handleBulkImport = () => {
                try {
                    const parsedQuestions = [];
                    const lines = bulkText.split('\n');
                    let currentQuestion = null;

                    for (const line of lines) {
                        if (line.startsWith('Q:')) {
                            if (currentQuestion) parsedQuestions.push(currentQuestion);
                            currentQuestion = { question: line.substring(2).trim(), options: [], answer: '' };
                        } else if (line.startsWith('O:') && currentQuestion) {
                            currentQuestion.options.push(line.substring(2).trim());
                        } else if (line.startsWith('A:') && currentQuestion) {
                            currentQuestion.answer = line.substring(2).trim();
                        }
                    }
                    if (currentQuestion) parsedQuestions.push(currentQuestion);

                    if (parsedQuestions.length > 0) {
                        setQuestions(parsedQuestions);
                        showNotification({message: 'Bulk import successful!', type: 'success'});
                    } else {
                        showNotification({message: 'Could not find any questions in the provided format.', type: 'error'});
                    }
                } catch (e) {
                    showNotification({message: 'Error parsing bulk text. Please check the format.', type: 'error'});
                }
            };
            
            const handleAIGenerate = async () => {
                if (!aiTopic) {
                    showNotification({ message: "Please enter a topic to generate questions.", type: "error" });
                    return;
                }
                setIsParsing(true);
                try {
                    if (!GEMINI_API_KEY) {
                        throw new Error("API Key is missing.");
                    }
                    const prompt = `Generate ${aiNumQuestions} multiple-choice ${subject} questions suitable for a 10-year-old based on the topic: "${aiTopic}". Provide the response as a JSON array of objects. Each object should have keys "question", "options" (an array of strings), and "answer". Example: [{"question": "What is 2+2?", "options": ["3", "4", "5"], "answer": "4"}]`;
                    
                    let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                    const payload = { contents: chatHistory };
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
                    
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });

                    if (!response.ok) {
                        const errorBody = await response.json();
                        throw new Error(`API Error: ${errorBody.error.message}`);
                    }

                    const result = await response.json();
                    let rawText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (rawText) {
                        // Clean the response from markdown
                        if (rawText.startsWith("```json")) {
                            rawText = rawText.substring(7, rawText.length - 3).trim();
                        }
                        const parsedJson = JSON.parse(rawText);
                        if (Array.isArray(parsedJson)) {
                             setQuestions(parsedJson.map(q => ({ question: q.question, options: q.options || ['', '', '', ''], answer: q.answer })));
                             setTitle(`AI Generated: ${aiTopic}`);
                             showNotification({ message: "AI generated questions successfully!", type: 'success' });
                        } else {
                            throw new Error("AI response was not in the expected format (array of questions).");
                        }
                    } else {
                        throw new Error("Failed to get a valid response from the AI.");
                    }
                } catch (error) {
                    console.error("Error generating with AI:", error);
                    showModal({
                        title: "AI Feature Error",
                        message: `Could not generate test. Please check the API Key and connection. Error: ${error.message}`,
                        onConfirm: () => {},
                        confirmText: "OK"
                    });
                } finally {
                    setIsParsing(false);
                }
            };

            return (
                 <div className="p-8 min-h-screen">
                    <div className="max-w-4xl mx-auto">
                        <div className="flex justify-between items-center mb-8">
                            <h1 className="text-3xl font-bold font-orbitron text-cyan-300">{editingTest ? 'Edit Test' : 'Create New Test'}</h1>
                            <button onClick={() => { setEditingTest(null); setAdminView('main'); }} className="bg-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-600">&larr; Back to Admin</button>
                        </div>
                        <div className="bg-slate-800/50 border border-slate-700 p-6 rounded-xl space-y-6">
                            {/* AI Generation Section */}
                            <div className="bg-slate-800 p-4 rounded-lg border border-purple-500">
                                <h3 className="text-lg font-bold mb-2 text-purple-300">✨ Generate Test with AI</h3>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <input type="text" value={aiTopic} onChange={e => setAiTopic(e.target.value)} placeholder="Enter a topic..." className="md:col-span-2 p-2 bg-slate-700 rounded-md border border-slate-600" />
                                    <input type="number" value={aiNumQuestions} onChange={e => setAiNumQuestions(parseInt(e.target.value, 10))} className="p-2 bg-slate-700 rounded-md border border-slate-600" />
                                </div>
                                <button onClick={handleAIGenerate} disabled={isParsing} className="mt-2 w-full bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-500 disabled:bg-slate-600">
                                    {isParsing ? 'Generating...' : 'Generate Questions'}
                                </button>
                            </div>

                            {/* Bulk Import Section */}
                            <div className="bg-slate-800 p-4 rounded-lg border border-slate-700">
                                <h3 className="text-lg font-bold mb-2">Bulk Import from Text</h3>
                                <textarea 
                                    className="w-full p-2 bg-slate-700 rounded-md border border-slate-600"
                                    rows="6"
                                    placeholder={`Paste your test here. Use this format:\nQ: What is 2+2?\nO: 3\nO: 4\nO: 5\nA: 4`}
                                    value={bulkText}
                                    onChange={e => setBulkText(e.target.value)}
                                ></textarea>
                                <button onClick={handleBulkImport} className="mt-2 w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-500">Parse Bulk Text</button>
                            </div>

                            <hr className="border-slate-600"/>

                            <div>
                                <label className="block mb-2 font-bold">Test Title</label>
                                <input type="text" value={title} onChange={e => setTitle(e.target.value)} className="w-full p-2 bg-slate-700 rounded-md border border-slate-600" />
                            </div>
                            <div>
                                <label className="block mb-2 font-bold">Subject</label>
                                <select value={subject} onChange={e => setSubject(e.target.value)} className="w-full p-2 bg-slate-700 rounded-md border border-slate-600">
                                    <option>Maths</option>
                                    <option>English</option>
                                    <option>Mixed</option>
                                </select>
                            </div>
                            <div>
                                <label className="block mb-2 font-bold">Admin Notes (Visible only to you)</label>
                                <input type="text" value={notes} onChange={e => setNotes(e.target.value)} className="w-full p-2 bg-slate-700 rounded-md border border-slate-600" placeholder="e.g., Source of test, focus area..." />
                            </div>
                            <hr className="border-slate-600"/>
                            {questions.map((q, qIndex) => (
                                <div key={qIndex} className="bg-slate-800 p-4 rounded-lg border border-slate-700">
                                    <label className="block mb-2 font-bold">Question {qIndex + 1}</label>
                                    <textarea value={q.question} onChange={e => handleQuestionChange(qIndex, 'question', e.target.value)} className="w-full p-2 bg-slate-700 rounded-md border border-slate-600" rows="2" placeholder="Enter question text..."></textarea>
                                    <div className="grid grid-cols-2 gap-4 my-4">
                                        {(q.options || ['', '', '', '']).map((opt, oIndex) => (
                                             <input key={oIndex} type="text" value={opt} onChange={e => handleOptionChange(qIndex, oIndex, e.target.value)} placeholder={`Option ${oIndex + 1}`} className="p-2 bg-slate-700 rounded-md border border-slate-600" />
                                        ))}
                                    </div>
                                    <label className="block mb-2 font-bold">Correct Answer</label>
                                    <input type="text" value={q.answer} onChange={e => handleQuestionChange(qIndex, 'answer', e.target.value)} placeholder="Must match one of the options exactly" className="w-full p-2 bg-slate-700 rounded-md border border-slate-600" />
                                </div>
                            ))}
                            <button onClick={addQuestion} className="bg-slate-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-slate-500">Add Another Question</button>
                        </div>
                        <div className="mt-8 text-center">
                            <button onClick={handleSaveTest} className="bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-500 text-xl">{editingTest ? 'Update Test' : 'Save Test'}</button>
                        </div>
                    </div>
                </div>
            );
        };
        
        const ProblemAnalysisView = ({ setAdminView, userData, allTests }) => {
            const [analysis, setAnalysis] = useState(null);
            const [explanations, setExplanations] = useState({});
            const [isLoadingExplanation, setIsLoadingExplanation] = useState(null);

            useEffect(() => {
                const incorrectAnswers = [];
                if (userData.progress && allTests.length > 0) {
                    Object.entries(userData.progress).forEach(([testId, progressData]) => {
                        const test = allTests.find(t => t.id === testId);
                        if (test) {
                            Object.entries(progressData.answers).forEach(([qIndex, userAnswer]) => {
                                const question = test.questions[qIndex];
                                if (question && question.answer !== userAnswer) {
                                    incorrectAnswers.push({
                                        questionText: question.question,
                                        correctAnswer: question.answer,
                                        userAnswer: userAnswer,
                                    });
                                }
                            });
                        }
                    });
                }
                
                const counts = incorrectAnswers.reduce((acc, curr) => {
                    const key = curr.questionText;
                    if (!acc[key]) {
                        acc[key] = { count: 0, details: curr, wrongAnswers: {} };
                    }
                    acc[key].count += 1;
                    acc[key].wrongAnswers[curr.userAnswer] = (acc[key].wrongAnswers[curr.userAnswer] || 0) + 1;
                    return acc;
                }, {});

                const sortedAnalysis = Object.entries(counts)
                    .map(([question, data]) => ({ question, ...data }))
                    .sort((a, b) => b.count - a.count);
                
                setAnalysis(sortedAnalysis);
            }, [userData, allTests]);

            const fetchExplanation = async (item, index) => {
                setIsLoadingExplanation(index);
                const prompt = `You are a friendly and encouraging teacher helping a 10-11 year old student study. Explain the answer to the following question in a simple, step-by-step way. Question: "${item.details.questionText}" The correct answer is: "${item.details.correctAnswer}" The student's incorrect answer was: "${item.details.userAnswer}". Explain how to get the correct answer.`;
                
                try {
                    let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                    const payload = { contents: chatHistory };
                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();
                    const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (text) {
                        setExplanations(prev => ({ ...prev, [index]: text }));
                    } else {
                        throw new Error("Invalid API response structure.");
                    }
                } catch (error) {
                    console.error("Error fetching explanation:", error);
                    setExplanations(prev => ({ ...prev, [index]: "Sorry, could not get an explanation at this time." }));
                } finally {
                    setIsLoadingExplanation(null);
                }
            };

            return (
                <div className="p-8 min-h-screen">
                    <div className="max-w-4xl mx-auto">
                        <div className="flex justify-between items-center mb-8">
                            <h1 className="text-3xl font-bold font-orbitron text-cyan-300">Problem Analysis</h1>
                            <button onClick={() => setAdminView('main')} className="bg-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-600">&larr; Back to Admin</button>
                        </div>
                        <div className="bg-slate-800/50 border border-slate-700 p-6 rounded-xl">
                            <h2 className="text-xl font-bold mb-4">Most Frequently Incorrect Questions</h2>
                            {analysis && analysis.length > 0 ? (
                                <ul className="space-y-4">
                                    {analysis.map((item, index) => (
                                        <li key={index} className="bg-slate-800 p-4 rounded-lg">
                                            <p className="font-semibold text-gray-300">"{item.question}"</p>
                                            <p className="text-red-400 font-bold">Incorrect {item.count} time(s)</p>
                                            <div className="text-sm text-slate-400 mt-1">
                                                Common wrong answers: {Object.entries(item.wrongAnswers).map(([ans, count]) => `${ans} (${count}x)`).join(', ')}
                                            </div>
                                            <button onClick={() => fetchExplanation(item, index)} disabled={isLoadingExplanation === index} className="mt-2 text-sm text-cyan-400 hover:text-cyan-200 disabled:opacity-50">
                                                {isLoadingExplanation === index ? '✨ Generating...' : '✨ Get AI Explanation'}
                                            </button>
                                            {explanations[index] && <div className="mt-2 p-3 bg-slate-700 border border-slate-600 text-yellow-300 rounded-lg text-sm whitespace-pre-wrap">{explanations[index]}</div>}
                                        </li>
                                    ))}
                                </ul>
                            ) : (
                                <p className="text-slate-400">No incorrect answers have been recorded yet. Complete some tests to see analysis.</p>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const SettingsView = ({ userData, setView, updateUserData, showNotification }) => {
            const [name, setName] = useState(userData.name);
            const [avatar, setAvatar] = useState(userData.avatar || '👨‍🚀');
            const avatars = ['👨‍🚀', '🚀', '⭐', '🎮', '🤖', '🧠', '💡', '🏆'];

            const handleSave = () => {
                updateUserData({ ...userData, name, avatar });
                showNotification({message: "Settings saved!", type: "success"});
                setView('dashboard');
            };

            return (
                 <div className="p-8 min-h-screen flex items-center justify-center">
                    <div className="max-w-md mx-auto w-full bg-slate-800 border border-slate-700 rounded-xl p-8">
                        <h1 className="text-3xl font-bold font-orbitron text-cyan-300 mb-6 text-center">Profile Settings</h1>
                        <div className="mb-6">
                            <label className="block mb-2 font-bold">Player Name</label>
                            <input type="text" value={name} onChange={e => setName(e.target.value)} className="w-full p-2 bg-slate-700 rounded-md border border-slate-600" />
                        </div>
                        <div className="mb-8">
                            <label className="block mb-2 font-bold">Choose Your Avatar</label>
                            <div className="grid grid-cols-4 gap-4">
                                {avatars.map(av => (
                                    <button key={av} onClick={() => setAvatar(av)} className={`text-4xl p-4 rounded-lg transition-all ${avatar === av ? 'bg-cyan-600 ring-2 ring-cyan-300' : 'bg-slate-700 hover:bg-slate-600'}`}>{av}</button>
                                ))}
                            </div>
                        </div>
                        <div className="flex gap-4">
                            <button onClick={() => setView('dashboard')} className="w-full bg-slate-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-slate-500">Cancel</button>
                            <button onClick={handleSave} className="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-500">Save</button>
                        </div>
                    </div>
                </div>
            );
        };
        
        const AchievementsView = ({ userData, setView, updateUserData, showNotification }) => {
            const [activeTab, setActiveTab] = useState('Badges');

            const unlockedTitles = achievementsList.filter(ach => userData.achievements[ach.id] && ach.unlocksTitle);

            const handleEquipTitle = (title) => {
                updateUserData({ ...userData, title: title });
                showNotification({message: `Title "${title}" equipped!`, type: 'success'});
            };

            return (
                <div className="p-8 min-h-screen">
                    <div className="max-w-5xl mx-auto">
                        <div className="flex justify-between items-center mb-8">
                            <h1 className="text-4xl font-bold font-orbitron text-cyan-300">Achievements</h1>
                            <button onClick={() => setView('dashboard')} className="bg-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-600">&larr; Back to Dashboard</button>
                        </div>

                        <div className="flex border-b border-slate-700 mb-6">
                            <button onClick={() => setActiveTab('Badges')} className={`py-2 px-4 font-semibold ${activeTab === 'Badges' ? 'border-b-2 border-cyan-400 text-cyan-300' : 'text-slate-400'}`}>Badges</button>
                            <button onClick={() => setActiveTab('Titles')} className={`py-2 px-4 font-semibold ${activeTab === 'Titles' ? 'border-b-2 border-cyan-400 text-cyan-300' : 'text-slate-400'}`}>Titles</button>
                        </div>

                        {activeTab === 'Badges' && (
                            <div>
                                {['Mastery', 'Performance', 'Consistency'].map(category => (
                                    <div key={category} className="mb-8">
                                        <h2 className="text-2xl font-orbitron text-cyan-300 mb-4">{category} Badges</h2>
                                        <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                            {achievementsList.filter(ach => ach.category === category).map(ach => {
                                                const isUnlocked = userData.achievements[ach.id];
                                                return (
                                                    <div key={ach.id} className={`p-4 rounded-lg border-2 text-center ${isUnlocked ? 'border-yellow-400 bg-slate-800' : 'border-slate-700 bg-slate-800/50'}`}>
                                                        <div className={`text-5xl mb-2 transition-all duration-300 ${isUnlocked ? 'text-yellow-400' : 'text-slate-600 scale-90 grayscale'}`}>🏆</div>
                                                        <h3 className={`font-bold ${isUnlocked ? 'text-yellow-300' : 'text-slate-400'}`}>{ach.title}</h3>
                                                        <p className="text-sm text-slate-500">{ach.description}</p>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {activeTab === 'Titles' && (
                             <div className="bg-slate-800/50 border border-slate-700 p-6 rounded-xl">
                                <h2 className="text-2xl font-orbitron text-cyan-300 mb-4">Equip a Title</h2>
                                {unlockedTitles.length > 0 ? (
                                    <div className="space-y-3">
                                        {unlockedTitles.map(ach => (
                                            <div key={ach.id} className="bg-slate-800 p-4 rounded-lg flex justify-between items-center">
                                                <div>
                                                    <p className="font-bold text-lg text-yellow-300">{ach.unlocksTitle}</p>
                                                    <p className="text-sm text-slate-400">Unlocked from: "{ach.title}"</p>
                                                </div>
                                                <button onClick={() => handleEquipTitle(ach.unlocksTitle)} disabled={userData.title === ach.unlocksTitle} className="bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-500 disabled:bg-slate-600 disabled:cursor-not-allowed">
                                                    {userData.title === ach.unlocksTitle ? 'Equipped' : 'Equip'}
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <p className="text-slate-400">No titles unlocked yet. Earn badges to unlock them!</p>
                                )}
                             </div>
                        )}
                    </div>
                </div>
            );
        };


        // --- Main App Component ---
        function App() {
            const [appData, setAppData] = useState(null);
            const [view, setView] = useState('loading');
            const [selectedTest, setSelectedTest] = useState(null);
            const [notification, setNotification] = useState({ show: false, message: '', type: '' });
            const [modal, setModal] = useState({ show: false, title: '', message: '', onConfirm: null, onCancel: null, confirmText: "Confirm", children: null });

            const showNotification = ({message, type = 'success'}) => {
                setNotification({ show: true, message, type });
            };

            const hideModal = () => {
                 setModal({ show: false });
            };

            const showModal = ({ title, message, onConfirm, onCancel, confirmText, children }) => {
                setModal({ 
                    show: true, 
                    title, 
                    message, 
                    onConfirm: onConfirm ? () => {
                        onConfirm();
                        hideModal();
                    } : null,
                    onCancel: onCancel ? () => {
                        onCancel();
                        hideModal();
                    } : hideModal,
                    confirmText: confirmText || "Confirm",
                    children
                });
            };

            // Load data from localStorage on initial render
            useEffect(() => {
                const savedData = localStorage.getItem('seagPortalData');
                let loadedData;
                if (savedData) {
                    try {
                        loadedData = JSON.parse(savedData);
                    } catch(e) {
                        console.error("Failed to parse saved data, initializing fresh.", e);
                        loadedData = null;
                    }
                }
                
                if (!loadedData) {
                    loadedData = {
                        userData: { name: "Nicolas", progress: {}, achievements: {}},
                        allTests: defaultTests
                    };
                }

                // Initialize/migrate user data to ensure all fields exist
                const defaultUserData = {
                    name: "Nicolas",
                    progress: {},
                    achievements: {},
                    xp: 0,
                    level: 1,
                    avatar: '👨‍🚀',
                    title: null,
                    dailyChallenge: { lastCompleted: null, completedToday: false },
                    dailyChallengeStreak: 0,
                    loginStreak: 0,
                    totalCorrectAnswers: 0,
                    correctAnswersByTag: {},
                    lastAnswerWasIncorrect: false,
                    consecutiveCorrectAfterWrong: 0,
                    weeklyTestCompletion: [],
                    completedFullTests: [],
                    testsWithHighGeometryScore: []
                };

                loadedData.userData = { ...defaultUserData, ...loadedData.userData };
                
                setAppData(loadedData);
                setView('dashboard');
            }, []);

            // Save data to localStorage whenever it changes
            const updateAllData = useCallback((newData) => {
                setAppData(newData);
                localStorage.setItem('seagPortalData', JSON.stringify(newData));
            }, []);
            
            const updateUserData = useCallback((newUserData) => {
                if(appData){
                    // Level Up Logic
                    let currentLevel = newUserData.level;
                    let currentXp = newUserData.xp;
                    let xpForNextLevel = currentLevel * 100;

                    if (currentXp >= xpForNextLevel) {
                        while(currentXp >= xpForNextLevel) {
                            currentLevel++;
                            currentXp -= xpForNextLevel;
                            xpForNextLevel = currentLevel * 100;
                        }
                        newUserData.level = currentLevel;
                        newUserData.xp = currentXp;
                        showNotification({message: `🎉 Level Up! You are now Level ${currentLevel}!`, type: 'success'});
                    }
                    
                    // Badge Checking Logic
                    const newlyUnlocked = [];
                    for(const badge of achievementsList) {
                        if(!newUserData.achievements[badge.id]) {
                            let unlocked = false;
                            switch(badge.id) {
                                case 'centuryClub': if (newUserData.totalCorrectAnswers >= 100) unlocked = true; break;
                                case 'fractionFanatic': if ((newUserData.correctAnswersByTag.fractions || 0) >= 50) unlocked = true; break;
                                case 'vocabularyVirtuoso': if ((newUserData.correctAnswersByTag.vocabulary || 0) >= 100) unlocked = true; break;
                                case 'punctuationPro': if ((newUserData.correctAnswersByTag.punctuation || 0) >= 25) unlocked = true; break;
                                case 'comebackKid': if (newUserData.consecutiveCorrectAfterWrong >= 3) unlocked = true; break;
                                // Other badges are checked upon test completion
                            }
                            if (unlocked) {
                                newUserData.achievements[badge.id] = true;
                                newUserData.xp += 5; // +5 XP bonus for new badge
                                newlyUnlocked.push(badge.title);
                            }
                        }
                    }

                    if (newlyUnlocked.length > 0) {
                        showModal({
                            title: "🏆 Achievement Unlocked! 🏆",
                            message: `Congratulations! You've earned the "${newlyUnlocked.join(', ')}" badge and a +5 XP bonus!`,
                            onConfirm: () => {},
                            confirmText: "Awesome!"
                        });
                    }

                    updateAllData({ ...appData, userData: newUserData });
                }
            }, [appData, updateAllData]);


            if (!appData) {
                return <LoadingSpinner message="Initializing System..." />;
            }

            const renderView = () => {
                switch (view) {
                    case 'loading': return <LoadingSpinner message="Loading Portal..." />;
                    case 'dashboard': return <Dashboard userData={appData.userData} setView={setView} setSelectedTest={setSelectedTest} allTests={appData.allTests} showModal={showModal} hideModal={hideModal} updateUserData={updateUserData} appData={appData} updateAllData={updateAllData} showNotification={showNotification} />;
                    case 'quiz': return <QuizView userData={appData.userData} testDetails={selectedTest} setView={setView} allTests={appData.allTests} updateUserData={updateUserData} showNotification={showNotification} showModal={showModal} />;
                    case 'results': return <ResultsView userData={appData.userData} setView={setView} testDetails={selectedTest} allTests={appData.allTests} />;
                    case 'admin': return <AdminView userData={appData.userData} setView={setView} allTests={appData.allTests} updateAllData={updateAllData} showModal={showModal} showNotification={showNotification} />;
                    case 'settings': return <SettingsView userData={appData.userData} setView={setView} updateUserData={updateUserData} showNotification={showNotification} />;
                    case 'achievements': return <AchievementsView userData={appData.userData} setView={setView} updateUserData={updateUserData} showNotification={showNotification} />;
                    default: return <LoadingSpinner message="Loading Portal..." />;
                }
            };

            return (
                <div className="font-sans">
                    {renderView()}
                    {notification.show && <Notification message={notification.message} type={notification.type} onDismiss={() => setNotification({ show: false })} />}
                    {modal.show && <Modal title={modal.title} message={modal.message} onConfirm={modal.onConfirm} onCancel={modal.onCancel} confirmText={modal.confirmText}>{modal.children}</Modal>}
                </div>
            );
        }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
