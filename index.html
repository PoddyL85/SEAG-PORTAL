<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nicolas's SEAG Portal</title>

  <!-- Google Fonts: Orbitron for a gaming feel -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  
  <!-- Open Sans Font for accessibility -->
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" rel="stylesheet">

  <!-- Tailwind CSS for styling -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React Libraries (Production) -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel to compile JSX in the browser -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- PDF.js for parsing PDF files -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

  <!-- Chart.js for data visualization -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: 'Roboto', sans-serif;
    }
    .font-orbitron {
      font-family: 'Orbitron', sans-serif;
    }
    .glowing-border {
      box-shadow: 0 0 2px #00aaff, 0 0 5px #00aaff, 0 0 10px #00aaff;
    }
    .glowing-text {
      text-shadow: 0 0 5px #00aaff, 0 0 10px #00aaff;
    }
    /* Custom styles for modal and notifications */
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1100; /* ensure above notifications */
    }
    .notification-bar {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1001;
      transition: opacity 0.5s, transform 0.5s;
    }
    /* Animation for feedback flash */
    @keyframes flash-green {
      0% { background-color: #16a34a; } /* green-600 */
      100% { background-color: transparent; }
    }
    @keyframes flash-red {
      0% { background-color: #dc2626; } /* red-600 */
      100% { background-color: transparent; }
    }
    .flash-correct {
      animation: flash-green 0.5s ease-out;
    }
    .flash-incorrect {
      animation: flash-red 0.5s ease-out;
    }
    /* Print styles */
    @media print {
      body * { visibility: hidden; }
      #print-area, #print-area * { visibility: visible; }
      #print-area {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
      }
      .no-print { display: none; }
    }
    .dragging-over {
      border: 2px dashed #38bdf8; /* cyan-400 */
    }
    .dyslexia-friendly {
      font-family: 'Open Sans', Arial, sans-serif !important;
      line-height: 1.8;
      letter-spacing: 0.05em;
    }
    .dyslexia-friendly * {
        font-family: 'Open Sans', Arial, sans-serif !important;
    }
  </style>
</head>
<body class="bg-slate-900 text-gray-200">
  <div id="root"></div>

  <script type="text/babel">
    // This is your entire React Application inside a single script tag.
    // Data is saved in the browser's localStorage.

    if (window.pdfjsLib) {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    } else {
      console.warn('PDF.js failed to load from CDN - PDF import features will be disabled');
    }

    const { useState, useEffect, useCallback, useRef, useMemo } = React;

    // --- Utility: Safe storage write (quota-safe) ---
    function safeSetLocalStorage(key, value) {
      try {
        localStorage.setItem(key, value);
        return true;
      } catch (e) {
        // Best-effort prune of this app's older backups if any
        try {
          const keys = Object.keys(localStorage).filter(k => k.startsWith('seag:history:')).slice(0, 10);
          keys.forEach(k => localStorage.removeItem(k));
          localStorage.setItem(key, value);
          return true;
        } catch (_) {
          console.warn('localStorage write failed:', e?.message || e);
          return false;
        }
      }
    }

    // --- Default Test Data ---
    const defaultTests = [
      /* [UNCHANGED: defaultTests content retained exactly as provided] */
      // ... entire defaultTests array from your message ...
      // Kept identical to avoid any regressions.
      // For brevity in this explanation block, content is unchanged below.
      {
        id: "maths-pack-1",
        title: "Maths Test Pack 1",
        subject: "Maths",
        notes: "From 2023 practice paper, page 5.",
        questions: [
          { question: "A football pitch measures 115 metres long and 80 metres wide. The area of a rugby pitch is 6,392 square metres. How many square metres smaller is the area of the rugby pitch than the area of the football pitch?", options: ["9200 m²", "2908 m²", "2809 m²", "2808 m²", "6197 m²"], answer: "2808 m²" },
          { question: "Convert this measurement: 1701 g = ___ kg", options: ["17.01 kg", "1.701 kg", "170.1 kg", "1.7 kg", "0.1701 kg"], answer: "1.701 kg" },
          { question: "How many lines of symmetry does a rhombus have?", options: ["0", "1", "2", "3", "4"], answer: "2" },
          { question: "Which is the most appropriate instrument for measuring the distance around a football?", options: ["trundle wheel", "odometer", "metre stick", "tape measure", "ruler"], answer: "tape measure" },
          { question: "Ahmed cycled 13 km on Monday and 15 km on Thursday. How much further did he cycle on Thursday than on Monday?", options: ["1 km", "3 km", "5 km", "4 km", "2 km"], answer: "2 km" },
          { question: "What decimal fraction is equivalent to 3/4?", options: ["0.25", "0.33", "0.20", "0.75", "0.10"], answer: "0.75", tags: ['fractions'] },
          { question: "A regular hexagon has a side length of 7 cm. A square has the same perimeter as the hexagon. What is the area of the square?", options: ["42 cm²", "100 cm²", "10.5 cm²", "110.25 cm²", "49 cm²"], answer: "110.25 cm²", tags: ['geometry'] },
          { question: "What is the tenth number in this sequence: 1.5, 3.0, 4.5, 6.0, ...?", options: ["9.0", "12.5", "15", "15.0", "17.5"], answer: "15.0" },
          { question: "Girls in Years 4, 5, 6, and 7 collected £4, £12, £16, and £17 respectively. What was the average amount collected?", options: ["£12.00", "£12.25", "£12.50", "£10.00", "£13.00"], answer: "£12.25" },
          { question: "A rectangle's corners are at A(25, 30), B(55, 30), C(55, 14), and D. What are the coordinates of point D?", options: ["(25, 14)", "(55, 30)", "(25, 22)", "(55, 14)", "(40, 14)"], answer: "(25, 14)", tags: ['geometry'] },
          { question: "By how much is 18.401 greater than 14.1?", options: ["4.3", "3.3", "4.301", "3.301", "4"], answer: "4.301" },
          { question: "A stack of 20 identical pizza boxes is 160 cm tall. Giovanni removes 3 from the top. How tall is the stack now?", options: ["130 cm", "132 cm", "134 cm", "136 cm", "138 cm"], answer: "136 cm" },
          { question: "What would be the best unit of measure for recording the amount of water in a paddling pool?", options: ["litres", "mm", "cm", "m³", "ml"], answer: "litres" },
          { question: "A scale shows a weight between 1.2 kg and 1.3 kg, marked in 10 increments. The pointer is on the 4th mark after 1.2. What is the weight?", options: ["1.21 kg", "1.22 kg", "1.23 kg", "1.24 kg", "1.25 kg"], answer: "1.24 kg" },
          { question: "b × 6 = 48. What does (b + 2) × 5 equal?", options: ["30", "40", "20", "50", "60"], answer: "50" },
          { question: "How many vertical lines are in an isosceles trapezium with a vertical line of symmetry drawn through it?", options: ["0", "1", "2", "3", "4"], answer: "1" },
          { question: "What is 7/10 of £17?", options: ["£9.90", "£10.90", "£11.70", "£11.90", "£12.90"], answer: "£11.90", tags: ['percentages', 'fractions'] },
          { question: "A chart showing population change over time with points connected by lines is what type of chart?", options: ["Block Graph", "Pie Chart", "Bar Graph", "Bar-Line Graph", "Line Graph"], answer: "Line Graph" },
          { question: "A rectangle is divided into 8 equal squares. 6 of them are shaded. What fraction is shaded?", options: ["1/4", "3/8", "5/8", "3/4", "7/8"], answer: "3/4", tags: ['fractions'] },
          { question: "A chart shows temperature ranges. The lowest is -13°C and the highest is 6°C. What is the difference between the highest and lowest temperatures?", options: ["-13°C", "18°C", "19°C", "20°C", "21°C"], answer: "19°C" },
          { question: "Pattern 1 has 9 blocks. Pattern 2 has 13 blocks. Pattern 3 has 17 blocks. The rule is (Number of blocks) = 4 * PatternNumber + 5. Which pattern will have 49 blocks?", options: ["9", "10", "11", "12", "13"], answer: "11" },
          { question: "In a sale, everything was reduced by 25%. How much would be saved on an item which usually cost £4.80?", answer: "£1.20", tags: ['percentages'] },
          { question: "A decision tree sorts numbers. If the number is even, it checks if it's a multiple of 5. If not even, it checks if it's a square number. Which box would the number 64 be put into? (Box A: even, mult of 5. Box B: even, not mult of 5. Box C: odd, square. Box D: odd, not square)", answer: "B" },
          { question: "What is the missing number in this sequence: 2, 5, 11, 23, ___?", answer: "47" },
          { question: "A film starts at 19:45 and lasts for 1 hour and 35 minutes. What time does it finish?", answer: "21:20" },
          { question: "Calculate 3.5 × 8.", answer: "28" },
          { question: "A bag contains 6 red balls and 10 blue balls. What is the probability of picking a red ball?", answer: "6/16", tags: ['fractions'] },
          { question: "What is 15% of 300?", answer: "45", tags: ['percentages'] }
        ]
      },
      {
        id: "maths-pack-2",
        title: "Maths Test Pack 2",
        subject: "Maths",
        notes: "General maths revision.",
        questions: [
          { question: "A baker uses 250g of flour for every cake. How many cakes can he bake with a 5kg bag of flour?", options: ["10", "15", "20", "25", "30"], answer: "20" },
          { question: "What is the value of x if 4x + 5 = 25?", options: ["3", "4", "5", "6", "7"], answer: "5" },
          { question: "A train travels at 60 mph. How long does it take to travel 150 miles?", options: ["2 hours", "2.5 hours", "3 hours", "3.5 hours", "4 hours"], answer: "2.5 hours" },
          { question: "What is the next prime number after 19?", options: ["20", "21", "22", "23", "24"], answer: "23" },
          { question: "A rectangle has a perimeter of 30 cm. Its length is 10 cm. What is its width?", options: ["5 cm", "6 cm", "7 cm", "8 cm", "10 cm"], answer: "5 cm", tags: ['geometry'] },
          { question: "Simplify the ratio 18:24.", options: ["2:3", "3:4", "4:5", "5:6", "6:7"], answer: "3:4" },
          { question: "What is 0.25 as a percentage?", options: ["2.5%", "25%", "250%", "0.025%", "0.25%"], answer: "25%", tags: ['percentages'] },
          { question: "A circle has a radius of 5 cm. What is its diameter?", options: ["5 cm", "10 cm", "15 cm", "20 cm", "25 cm"], answer: "10 cm", tags: ['geometry'] },
          { question: "Find the mean of these numbers: 4, 6, 8, 10.", options: ["5", "6", "7", "8", "9"], answer: "7" },
          { question: "If a = 3 and b = 4, what is the value of 2a + 3b?", options: ["15", "16", "17", "18", "19"], answer: "18" },
          { question: "How many degrees are in a right angle?", options: ["45", "90", "180", "270", "360"], answer: "90", tags: ['geometry'] },
          { question: "What is the square root of 144?", options: ["10", "11", "12", "13", "14"], answer: "12" },
          { question: "A map has a scale of 1:10000. A distance on the map is 5 cm. What is the real distance in metres?", options: ["50m", "500m", "5000m", "50000m", "5m"], answer: "500m" },
          { question: "What is the area of a triangle with a base of 10 cm and a height of 6 cm?", options: ["20 cm²", "30 cm²", "40 cm²", "50 cm²", "60 cm²"], answer: "30 cm²", tags: ['geometry'] },
          { question: "Convert 2.5 hours into minutes.", options: ["120", "130", "140", "150", "160"], answer: "150" },
          { question: "What is the mode of this set of numbers: 2, 3, 3, 4, 5, 5, 5, 6?", options: ["2", "3", "4", "5", "6"], answer: "5" },
          { question: "A cube has a volume of 27 cm³. What is the length of one side?", options: ["2 cm", "3 cm", "4 cm", "5 cm", "6 cm"], answer: "3 cm", tags: ['geometry'] },
          { question: "What is 3/5 as a decimal?", options: ["0.3", "0.4", "0.5", "0.6", "0.7"], answer: "0.6", tags: ['fractions'] },
          { question: "A car journey starts at 08:30 and ends at 11:15. How long was the journey?", options: ["2h 15m", "2h 30m", "2h 45m", "3h 00m", "3h 15m"], answer: "2h 45m" },
          { question: "Increase £50 by 20%.", options: ["£52", "£55", "£58", "£60", "£62"], answer: "£60", tags: ['percentages'] },
          { question: "What is the sum of the angles in a quadrilateral?", options: ["90°", "180°", "270°", "360°", "540°"], answer: "360°", tags: ['geometry'] },
          { question: "Write 0.05 as a fraction in its simplest form.", answer: "1/20", tags: ['fractions'] },
          { question: "A book costs £8.50. There is a 10% discount. What is the new price?", answer: "£7.65", tags: ['percentages'] },
          { question: "How many faces does a triangular prism have?", answer: "5", tags: ['geometry'] },
          { question: "What is the next number in the Fibonacci sequence: 1, 1, 2, 3, 5, 8, ___?", answer: "13" },
          { question: "Calculate 1/4 + 3/8.", answer: "5/8", tags: ['fractions'] },
          { question: "A square has an area of 64 cm². What is its perimeter?", answer: "32 cm", tags: ['geometry'] },
          { question: "What is the largest factor of 24 (other than 24)?", answer: "12" }
        ]
      },
      {
        id: "english-pack-1",
        title: "English Test Pack 1",
        subject: "English",
        notes: "Focus on punctuation and grammar.",
        questions: [
          { question: "Identify the sentence with the correct punctuation: The cat sat on the mat. or The cat, sat on the mat.", answer: "The cat sat on the mat.", tags: ['punctuation'] },
          { question: "Which word is the adjective in this sentence: The quick brown fox jumps over the lazy dog.", answer: "quick", tags: ['grammar'] },
          { question: "Choose the correct spelling: a) accomodate b) accommodate c) acommodate", answer: "b", tags: ['spelling'] },
          { question: "What is the synonym for 'happy'?", options: ["Sad", "Joyful", "Angry", "Tired"], answer: "Joyful", tags: ['vocabulary'] },
          { question: "Identify the verb in the sentence: She sings beautifully.", answer: "sings", tags: ['grammar'] },
          { question: "Which of the following is a correctly punctuated question? a) Where are you going. b) Where are you going! c) Where are you going?", answer: "c", tags: ['punctuation'] },
          { question: "What is the plural of 'child'?", answer: "children", tags: ['grammar'] },
          { question: "Choose the antonym for 'brave'.", options: ["Cowardly", "Heroic", "Strong", "Bold"], answer: "Cowardly", tags: ['vocabulary'] },
          { question: "Identify the pronoun in: 'He gave the book to her.'", answer: "He", tags: ['grammar'] },
          { question: "Correct the spelling of 'recieve'.", answer: "receive", tags: ['spelling'] },
          { question: "Which sentence uses 'its' and 'it's' correctly?", options: ["The dog wagged it's tail because its happy.", "The dog wagged its tail because it's happy.", "The dog wagged it's tail because it's happy."], answer: "The dog wagged its tail because it's happy.", tags: ['grammar'] },
          { question: "What type of word is 'quickly'?", answer: "adverb", tags: ['grammar'] },
          { question: "Find the error: 'Me and my friend went to the park.'", answer: "Me", tags: ['grammar'] },
          { question: "What is the past tense of 'go'?", answer: "went", tags: ['grammar'] },
          { question: "Identify the proper noun: 'We visited Paris in France.'", answer: "Paris", tags: ['grammar'] },
          { question: "Which is the correct contraction for 'do not'?", answer: "don't", tags: ['punctuation'] },
          { question: "What does the prefix 'un-' mean in 'unhappy'?", answer: "not", tags: ['vocabulary'] },
          { question: "Choose the correctly spelled word: a) seperate b) separate c) seporate", answer: "b", tags: ['spelling'] },
          { question: "Identify the conjunction: 'I wanted to go, but I was too tired.'", answer: "but", tags: ['grammar'] },
          { question: "What is the superlative form of 'good'?", answer: "best", tags: ['grammar'] },
          { question: "Which sentence is in the passive voice?", options: ["The boy threw the ball.", "The ball was thrown by the boy."], answer: "The ball was thrown by the boy.", tags: ['grammar'] },
          { question: "What is the meaning of the idiom 'bite the bullet'?", answer: "To endure a difficult situation", tags: ['vocabulary'] },
          { question: "Correct the sentence: 'their going to the store.'", answer: "They're going to the store.", tags: ['grammar'] },
          { question: "Identify the preposition: 'The cat is under the table.'", answer: "under", tags: ['grammar'] },
          { question: "What is the collective noun for a group of lions?", answer: "pride", tags: ['vocabulary'] },
          { question: "Choose the correct homophone: 'I want to go ___, over there.'", options: ["their", "there", "they're"], answer: "there", tags: ['vocabulary'] },
          { question: "What is the function of an apostrophe in 'the cat's toy'?", answer: "To show possession", tags: ['punctuation'] },
          { question: "Which word completes the simile: 'as brave as a ___'?", answer: "lion", tags: ['vocabulary'] }
        ]
      },
      {
        id: "english-pack-2",
        title: "English Test Pack 2",
        subject: "English",
        notes: "Vocabulary and sentence structure.",
        questions: [
          { question: "Which sentence is grammatically correct?", options: ["She done her homework.", "She did her homework."], answer: "She did her homework.", tags: ['grammar'] },
          { question: "What is the plural of 'goose'?", answer: "geese", tags: ['grammar'] },
          { question: "Identify the adverb: 'The turtle walked slowly.'", answer: "slowly", tags: ['grammar'] },
          { question: "Choose the correct word: 'The book is on ___ shelf.'", options: ["it's", "its"], answer: "its", tags: ['grammar'] },
          { question: "What is an antonym for 'ancient'?", options: ["Old", "Modern", "Historic", "Past"], answer: "Modern", tags: ['vocabulary'] },
          { question: "Which word is a noun?", options: ["beautiful", "ran", "happiness", "quickly"], answer: "happiness", tags: ['grammar'] },
          { question: "Correct the spelling of 'neccessary'.", answer: "necessary", tags: ['spelling'] },
          { question: "What does the suffix '-less' mean in 'careless'?", answer: "without", tags: ['vocabulary'] },
          { question: "Identify the verb in the imperative sentence: 'Close the door.'", answer: "Close", tags: ['grammar'] },
          { question: "What is the comparative form of 'bad'?", answer: "worse", tags: ['grammar'] },
          { question: "Which of these is a compound sentence?", options: ["I like tea.", "I like tea and he likes coffee."], answer: "I like tea and he likes coffee.", tags: ['grammar'] },
          { question: "What is the collective noun for a group of fish?", answer: "school", tags: ['vocabulary'] },
          { question: "Choose the correct homophone: 'She has a new ___ of shoes.'", options: ["pair", "pare", "pear"], answer: "pair", tags: ['vocabulary'] },
          { question: "Identify the type of sentence: 'What a beautiful day!'", answer: "Exclamatory", tags: ['punctuation'] },
          { question: "What is the meaning of the idiom 'spill the beans'?", answer: "To reveal a secret", tags: ['vocabulary'] },
          { question: "Correct the punctuation: 'Lets eat Grandma'", answer: "Let's eat, Grandma.", tags: ['punctuation'] },
          { question: "What is the abstract noun in: 'Honesty is the best policy.'?", answer: "Honesty", tags: ['grammar'] },
          { question: "Which word is spelled correctly?", options: ["wierd", "weird", "weerd"], answer: "weird", tags: ['spelling'] },
          { question: "Identify the direct object: 'The dog chased the cat.'", answer: "cat", tags: ['grammar'] },
          { question: "What is the opposite of 'expand'?", answer: "contract", tags: ['vocabulary'] },
          { question: "Which sentence uses 'who' and 'whom' correctly?", options: ["Who did you give the book to?", "Whom did you give the book to?"], answer: "Whom did you give the book to?", tags: ['grammar'] },
          { question: "What is the root word of 'unbelievable'?", answer: "believe", tags: ['vocabulary'] },
          { question: "Identify the simile: 'He is as strong as an ox.'", answer: "as strong as an ox", tags: ['vocabulary'] },
          { question: "What is the plural of 'cactus'?", answer: "cacti", tags: ['grammar'] },
          { question: "Choose the correct verb form: 'The news ___ always on at 6.'", options: ["is", "are"], answer: "is", tags: ['grammar'] },
          { question: "What type of pronoun is 'myself'?", answer: "Reflexive", tags: ['grammar'] },
          { question: "Correct the sentence: 'I could of gone to the party.'", answer: "I could have gone to the party.", tags: ['grammar'] },
          { question: "What does the prefix 're-' mean in 'rewrite'?", answer: "again", tags: ['vocabulary'] },

          // Maths Section (28 Qs)
          { question: "A baker uses 250g of flour for every cake. How many cakes can he bake with a 5kg bag of flour?", options: ["10", "15", "20", "25", "30"], answer: "20" },
          { question: "What is the value of x if 4x + 5 = 25?", options: ["3", "4", "5", "6", "7"], answer: "5" },
          { question: "A train travels at 60 mph. How long does it take to travel 150 miles?", options: ["2 hours", "2.5 hours", "3 hours", "3.5 hours", "4 hours"], answer: "2.5 hours" },
          { question: "What is the next prime number after 19?", options: ["20", "21", "22", "23", "24"], answer: "23" },
          { question: "A rectangle has a perimeter of 30 cm. Its length is 10 cm. What is its width?", options: ["5 cm", "6 cm", "7 cm", "8 cm", "10 cm"], answer: "5 cm", tags: ['geometry'] },
          { question: "Simplify the ratio 18:24.", options: ["2:3", "3:4", "4:5", "5:6", "6:7"], answer: "3:4" },
          { question: "What is 0.25 as a percentage?", options: ["2.5%", "25%", "250%", "0.025%", "0.25%"], answer: "25%", tags: ['percentages'] },
          { question: "A circle has a radius of 5 cm. What is its diameter?", options: ["5 cm", "10 cm", "15 cm", "20 cm", "25 cm"], answer: "10 cm", tags: ['geometry'] },
          { question: "Find the mean of these numbers: 4, 6, 8, 10.", options: ["5", "6", "7", "8", "9"], answer: "7" },
          { question: "If a = 3 and b = 4, what is the value of 2a + 3b?", options: ["15", "16", "17", "18", "19"], answer: "18" },
          { question: "How many degrees are in a right angle?", options: ["45", "90", "180", "270", "360"], answer: "90", tags: ['geometry'] },
          { question: "What is the square root of 144?", options: ["10", "11", "12", "13", "14"], answer: "12" },
          { question: "A map has a scale of 1:10000. A distance on the map is 5 cm. What is the real distance in metres?", options: ["50m", "500m", "5000m", "50000m", "5m"], answer: "500m" },
          { question: "What is the area of a triangle with a base of 10 cm and a height of 6 cm?", options: ["20 cm²", "30 cm²", "40 cm²", "50 cm²", "60 cm²"], answer: "30 cm²", tags: ['geometry'] },
          { question: "Convert 2.5 hours into minutes.", options: ["120", "130", "140", "150", "160"], answer: "150" },
          { question: "What is the mode of this set of numbers: 2, 3, 3, 4, 5, 5, 5, 6?", options: ["2", "3", "4", "5", "6"], answer: "5" },
          { question: "A cube has a volume of 27 cm³. What is the length of one side?", options: ["2 cm", "3 cm", "4 cm", "5 cm", "6 cm"], answer: "3 cm", tags: ['geometry'] },
          { question: "What is 3/5 as a decimal?", options: ["0.3", "0.4", "0.5", "0.6", "0.7"], answer: "0.6", tags: ['fractions'] },
          { question: "A car journey starts at 08:30 and ends at 11:15. How long was the journey?", options: ["2h 15m", "2h 30m", "2h 45m", "3h 00m", "3h 15m"], answer: "2h 45m" },
          { question: "Increase £50 by 20%.", options: ["£52", "£55", "£58", "£60", "£62"], answer: "£60", tags: ['percentages'] },
          { question: "What is the sum of the angles in a quadrilateral?", options: ["90°", "180°", "270°", "360°", "540°"], answer: "360°", tags: ['geometry'] },
          { question: "Write 0.05 as a fraction in its simplest form.", answer: "1/20", tags: ['fractions'] },
          { question: "A book costs £8.50. There is a 10% discount. What is the new price?", answer: "£7.65", tags: ['percentages'] },
          { question: "How many faces does a triangular prism have?", answer: "5", tags: ['geometry'] },
          { question: "What is the next number in the Fibonacci sequence: 1, 1, 2, 3, 5, 8, ___?", answer: "13" },
          { question: "Calculate 1/4 + 3/8.", answer: "5/8", tags: ['fractions'] },
          { question: "A square has an area of 64 cm². What is its perimeter?", answer: "32 cm", tags: ['geometry'] },
          { question: "What is the largest factor of 24 (other than 24)?", answer: "12" }
        ]
      },
    ];

    // --- Achievements Data ---
    const achievementsList = [
      /* [UNCHANGED: achievementsList content retained exactly as provided] */
      // ... content unchanged for correctness and continuity ...
        { id: 'firstSteps', title: 'First Steps', description: 'Attempt your first 5 questions.', category: 'Quick Wins' },
        { id: 'quickThinker', title: 'Quick Thinker', description: 'Get 1 correct answer in under 20 seconds.', category: 'Quick Wins' },
        { id: 'firstStreak', title: 'First Streak', description: 'Get a streak of 3 correct in a row.', category: 'Quick Wins', unlocksTitle: 'Streak Starter' },
        { id: 'topicExplorer', title: 'Topic Explorer', description: 'Attempt questions from 2 different topics in one day.', category: 'Quick Wins' },
        { id: 'mistakeFixer', title: 'Mistake Fixer', description: 'Correctly answer 1 previously-wrong question.', category: 'Quick Wins' },
        { id: 'noHintHeroMini', title: 'No-Hint Hero (Mini)', description: 'Answer 5 questions correctly without using hints.', category: 'Quick Wins' },
        { id: 'accurateStart', title: 'Accurate Start', description: 'Achieve 70% accuracy over your first 10 answers.', category: 'Quick Wins' },
        { id: 'comebackKid', title: 'Comeback Kid', description: 'Get 3 correct answers in a row after getting one wrong.', category: 'Quick Wins' },
        // Medium-Term
        { id: 'speedStreak', title: 'Speed Streak', description: 'Get 3 correct in a row, each under 30 seconds.', category: 'Medium-Term' },
        { id: 'consistencyStar', title: 'Consistency Star', description: 'Practice 2 days in a row.', category: 'Medium-Term' },
        { id: 'varietyChamp', title: 'Variety Champ', description: 'Answer correctly in 3 different topics in one session.', category: 'Medium-Term' },
        { id: 'noHintHeroPro', title: 'No-Hint Hero (Pro)', description: '10 correct in a row without hints.', category: 'Medium-Term' },
        { id: 'solidAccuracy', title: 'Solid Accuracy', description: 'Reach 80% accuracy over any 20-question session.', category: 'Medium-Term' },
        // Longer-Term
        { id: 'packFinisher', title: 'Pack Finisher', description: 'Complete any test pack.', category: 'Longer-Term' },
        { id: 'perfectPack', title: 'Perfect Pack', description: 'Get 100% on any test pack.', category: 'Longer-Term', unlocksTitle: 'Perfectionist' },
        { id: 'masteryBadge', title: 'Mastery Badge', description: 'Reach 90% accuracy over 30 questions in one topic.', category: 'Longer-Term' },
        { id: 'reviewPro', title: 'Review Pro', description: 'Correctly fix 10 mistakes in the "Practice Mistakes" mode.', category: 'Longer-Term' },
        { id: 'weeklyWarrior', title: 'Weekly Warrior', description: 'Complete a test on 5 separate days in one calendar week.', category: 'Longer-Term' },
        // New Achievements
        { id: 'fractionFanatic', title: 'Fraction Fanatic', description: 'Correctly answer 50 fraction questions.', category: 'Longer-Term' },
        { id: 'punctuationPro', title: 'Punctuation Pro', description: 'Correctly answer 25 punctuation questions.', category: 'Medium-Term' },
        { id: 'vocabularyVirtuoso', title: 'Vocabulary Virtuoso', description: 'Correctly answer 100 vocabulary questions.', category: 'Longer-Term' },
        { id: 'centuryClub', title: 'Century Club', description: 'Get 100 total correct answers.', category: 'Medium-Term' },
        { id: 'speedDemon', title: 'Speed Demon', description: 'Finish a test in Test Mode with over half the time remaining.', category: 'Medium-Term', unlocksTitle: 'Speedster' },
        { id: 'clutchPerformer', title: 'Clutch Performer', description: 'Correctly answer the final question of a full 56-question practice test.', category: 'Longer-Term' },
        { id: 'geometryGuru', title: 'Geometry Guru', description: 'Score 90%+ on three different tests containing geometry questions.', category: 'Longer-Term', unlocksTitle: 'Geometer' },
        { id: 'dedicatedDabbler', title: 'Dedicated Dabbler', description: 'Complete the Daily Challenge 7 days in a row.', category: 'Longer-Term' },
        { id: 'marathonRunner', title: 'Marathon Runner', description: 'Complete all available full practice tests.', category: 'Longer-Term', unlocksTitle: 'Endurance Champ' },
    ];

    function xpForAchievementId(id) {
      const ach = achievementsList.find(a => a.id === id);
      if (!ach) return 0;
      switch (ach.category) {
        case 'Quick Wins': return 3;
        case 'Medium-Term': return 5;
        case 'Longer-Term': return 10;
        default: return 0;
      }
    }

    // --- Central Achievement Unlocker ---
    // ISO Week helper
    function isoWeekString(d) {
      const date = new Date(d);
      // Copy date so don't modify original
      const tmp = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      // Thursday in current week decides the year.
      tmp.setUTCDate(tmp.getUTCDate() + 4 - (tmp.getUTCDay() || 7));
      const yearStart = new Date(Date.UTC(tmp.getUTCFullYear(), 0, 1));
      const weekNo = Math.ceil((((tmp - yearStart) / 86400000) + 1) / 7);
      return `${tmp.getUTCFullYear()}-W${String(weekNo).padStart(2, '0')}`;
    }

    function unlockAchievements(userData, event, allTestsMaybe) {
      // [UNCHANGED core unlocker logic; preserved with earlier safety guards]
      userData.achievements = userData.achievements || {};
      userData.correctAnswersByTag = userData.correctAnswersByTag || {};
      userData.badgeProgress = userData.badgeProgress || {};
      userData.badgeProgress.geometryGuruTests = Array.isArray(userData.badgeProgress.geometryGuruTests) ? userData.badgeProgress.geometryGuruTests : [];
      userData.weeklyCompletionWeeks = Array.isArray(userData.weeklyCompletionWeeks) ? userData.weeklyCompletionWeeks : [];
      userData.fullTestsCompleted = Array.isArray(userData.fullTestsCompleted) ? userData.fullTestsCompleted : [];
      // Harden additional containers (patch)
      userData.weeklyDayMap = userData.weeklyDayMap || {};
      userData.pendingAchievementIdsByTest = userData.pendingAchievementIdsByTest || {};
      
      const unlockedNow = [];
      const has = (id) => !!userData.achievements[id];
      const unlock = (id) => {
        if (!userData.achievements[id]) {
          userData.achievements[id] = true;
          unlockedNow.push(id);
        }
      };
      
      const type = event?.type;
      const p = event?.payload || {};
      const mode = p.mode;
      
      // STRICT RULE: only unlock achievements during Test mode actions
      if ((type === 'ANSWER_SUBMITTED' || type === 'PACK_COMPLETED') && mode !== 'Test') {
        // Allow review-based progress in "Practice Mistakes"
        if (!(type === 'ANSWER_SUBMITTED' && p.wasReviewed)) {
          return { updated: userData, unlockedIds: [] };
        }
      }
      
      if (type === 'ANSWER_SUBMITTED') {
        const tagCounts = userData.correctAnswersByTag || {};
        if (!has('fractionFanatic') && (tagCounts.fractions || 0) >= 50) unlock('fractionFanatic');
        if (!has('punctuationPro') && (tagCounts.punctuation || 0) >= 25) unlock('punctuationPro');
        if (!has('vocabularyVirtuoso') && (tagCounts.vocabulary || 0) >= 100) unlock('vocabularyVirtuoso');
        if (!has('centuryClub') && (userData.totalCorrectAnswers || 0) >= 100) unlock('centuryClub');
        if (!has('comebackKid') && p.correct && (userData.correctRunAfterWrong || 0) >= 3) {
          unlock('comebackKid');
        }
        if (!has('firstSteps') && (userData.totalAttempts || 0) >= 5) unlock('firstSteps');
        if (!has('quickThinker') && p.correct && (p.timeToAnswer || 0) <= 20) unlock('quickThinker');
        if (!has('firstStreak') && (userData.currentStreak || 0) >= 3) unlock('firstStreak');
        if (!has('topicExplorer') && (userData.uniqueTagsToday?.tags?.length || 0) >= 2) unlock('topicExplorer');
        if (!has('mistakeFixer') && p.correct && p.wasReviewed) unlock('mistakeFixer');
        if (!has('noHintHeroMini') && (userData.noHintCorrectCount || 0) >= 5) unlock('noHintHeroMini');
        if (!has('accurateStart') && (userData.totalAttempts || 0) >= 10 && ((userData.totalCorrectAnswers || 0) / userData.totalAttempts) >= 0.7) unlock('accurateStart');
        if (!has('speedStreak') && (userData.currentStreak || 0) >= 3 && (userData.lastCorrectAnswerTimes || []).length === 3 && userData.lastCorrectAnswerTimes.every(t => t <= 30)) {
            unlock('speedStreak');
        }
        if (!has('consistencyStar') && (userData.loginStreak || 0) >= 2) unlock('consistencyStar');
        if (!has('varietyChamp') && p.correct && (userData.uniqueTagsToday?.tags?.length || 0) >= 3) unlock('varietyChamp');
        if (!has('noHintHeroPro') && (userData.noHintStreak || 0) >= 10) unlock('noHintHeroPro');
        if (!has('masteryBadge')) {
            const stats = userData.perTopicStats || {};
            if (Object.values(stats).some(s => s.total >= 30 && (s.correct / s.total) >= 0.9)) {
                unlock('masteryBadge');
            }
        }
        if (!has('reviewPro') && (userData.reviewCorrections || 0) >= 10) unlock('reviewPro');
      }
      
      if (type === 'PACK_COMPLETED') {
        if (!has('speedDemon')
            && typeof p.timeLeft === 'number'
            && typeof p.initialTotalTime === 'number'
            && p.timeLeft >= (p.initialTotalTime / 2)) {
          unlock('speedDemon');
        }
        if (!has('clutchPerformer') && p.isFullPractice && p.totalQuestions === 56 && p.lastQuestionCorrect) {
          unlock('clutchPerformer');
        }
        if (p.testHasGeometry && p.totalQuestions > 0 && (p.score / p.totalQuestions) >= 0.9) {
          const list = new Set(userData.badgeProgress.geometryGuruTests);
          list.add(p.finishedTestId);
          userData.badgeProgress.geometryGuruTests = Array.from(list);
          if (!has('geometryGuru') && userData.badgeProgress.geometryGuruTests.length >= 3) {
            unlock('geometryGuru');
          }
        }
        if (p.finishedAt) {
          const finishedDate = new Date(p.finishedAt);
          userData.weeklyDayMap = userData.weeklyDayMap || {};
          const weekKey = isoWeekString(finishedDate);
          const dayKey = finishedDate.toISOString().split('T')[0];
          const days = userData.weeklyDayMap[weekKey] || {};
          days[dayKey] = true;
          userData.weeklyDayMap[weekKey] = days;
          const dayCount = Object.keys(days).length;
          if (!has('weeklyWarrior') && dayCount >= 5) {
            unlock('weeklyWarrior');
          }
        }
        if (p.finishedTestId && /^full-test-/.test(p.finishedTestId)) {
          const ft = new Set(userData.fullTestsCompleted);
          ft.add(p.finishedTestId);
          userData.fullTestsCompleted = Array.from(ft);
          const has1 = userData.fullTestsCompleted.includes('full-test-1');
          const has2 = userData.fullTestsCompleted.includes('full-test-2');
          if (!has('marathonRunner') && has1 && has2) {
            unlock('marathonRunner');
          }
        }
        if (!has('solidAccuracy') && (p.totalQuestions || 0) >= 20 && ((p.score || 0) / (p.totalQuestions || 1)) >= 0.8) unlock('solidAccuracy');
        if (!has('packFinisher')) unlock('packFinisher');
        if (!has('perfectPack') && p.score === p.totalQuestions) unlock('perfectPack');
        if (!has('dedicatedDabbler') && p.isDailyChallenge && (userData.dailyChallengeStreak || 0) >= 7) unlock('dedicatedDabbler');
      }
      return { updated: userData, unlockedIds: unlockedNow };
    }

    // --- Helper Components & Functions ---

    // Enhanced normalization and comparison (patch) [UNCHANGED from your provided code]
    const parseFraction = (s) => {
      const m = String(s).trim().match(/^(-?\d+)\s*\/\s*(-?\d+)$/);
      if (!m) return null;
      const num = parseFloat(m[1]);
      const den = parseFloat(m[2]);
      if (!isFinite(num) || !isFinite(den) || den === 0) return null;
      return num / den;
    };

    const toNumberish = (s) => {
      if (s == null) return null;
      const frac = parseFraction(s);
      if (frac != null) return frac;
      const cleaned = String(s).replace(',', '.').trim();
      const val = parseFloat(cleaned);
      return isFinite(val) ? val : null;
    };

    const stripSuperscripts = (s) => {
      return s
        .replace(/[²]/g, '2')
        .replace(/[³]/g, '3')
        .replace(/\^(\d)/g, '$1')
        .replace(/\b(square|squared)\b/g, '')
        .replace(/\b(cubic|cubed)\b/g, '');
    };

    const normalizeUnits = (s) => {
      return s
        .replace(/[£$€]/g, '')
        .replace(/[°,]/g, '')
        .replace(/%/g, '')
        .replace(/\b(deg|degree|degrees)\b/g, '')
        .replace(/\b(cm2|cm\^2|cm 2|cm\s*²|square\s*cm|sq\s*cm)\b/g, 'cm')
        .replace(/\b(m2|m\^2|m 2|m\s*²|square\s*m|sq\s*m)\b/g, 'm')
        .replace(/\b(km2|km\^2|km 2|km\s*²|square\s*km|sq\s*km)\b/g, 'km')
        .replace(/\b(mm|cm|m|km|g|kg|mg|lb|lbs|mile|miles|meter|meters|metre|metres|l|ml)\b/g, '')
        .replace(/\s+/g, ' ')
        .trim();
    };

    const normalizeAnswer = (answer, tags = []) => {
      if (answer == null) return '';
      if (typeof answer !== 'string') answer = String(answer);
      let s = answer.toLowerCase().trim();
      s = s.replace(/\s+/g, ' ');

      const numericish = tags.includes('geometry') || tags.includes('percentages') || tags.includes('fractions');
      if (numericish) {
        s = stripSuperscripts(s);
        s = normalizeUnits(s);
      }
      return s;
    };

    const nearlyEqual = (a, b, eps = 1e-6) => Math.abs(a - b) <= eps;

    const isAnswerCorrect = (question, userAnswer) => {
      if (!question) return false;
      const correctAnswer = question.answer;
      const tags = question.tags || [];

      const normalizedCorrect = normalizeAnswer(correctAnswer, tags);
      const normalizedUser = normalizeAnswer(userAnswer, tags);
      if (normalizedCorrect === normalizedUser) return true;

      const numericish = tags.includes('geometry') || tags.includes('percentages') || tags.includes('fractions');
      if (numericish) {
        const cNum = toNumberish(normalizedCorrect);
        const uNum = toNumberish(normalizedUser);
        if (cNum != null && uNum != null) {
          if (nearlyEqual(cNum, uNum)) return true;
          if (tags.includes('percentages')) {
            if (nearlyEqual(cNum, uNum / 100)) return true;
            if (nearlyEqual(cNum / 100, uNum)) return true;
          }
        }
      }

      return false;
    };

    const AIExplanation = ({ question, userAnswer, correctAnswer, onClose, currentQuestionIndex }) => {
      const [explanation, setExplanation] = useState('');
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const abortRef = useRef(null);
      const reqRef = useRef(0);
      const mountedRef = useRef(true);

      useEffect(() => {
        mountedRef.current = true;
        return () => {
          mountedRef.current = false;
          if (abortRef.current) abortRef.current.abort();
        };
      }, []);

      const parseAIResponse = (data) => {
        if (typeof data?.explanation === 'string' && data.explanation.trim()) return data.explanation.trim();
        if (typeof data?.response === 'string' && data.response.trim()) return data.response.trim();
        if (typeof data?.message === 'string' && data.message.trim()) return data.message.trim();
        if (typeof data?.text === 'string' && data.text.trim()) return data.text.trim();
        try {
          const parts = data?.candidates?.[0]?.content?.parts;
          if (Array.isArray(parts)) {
            const combined = parts
              .map(p => (typeof p?.text === 'string' ? p.text : ''))
              .join(' ')
              .trim();
            if (combined) return combined;
          }
        } catch (_) {}
        return '';
      };

      const getGenericExplanation = (question, userAnswer, correctAnswer) => {
        const tag = question.tags?.[0] || 'general';
        const fallbacks = {
          'fractions': `When working with fractions, remember to find common denominators first. The correct answer is ${correctAnswer}. Try breaking it down step by step!`,
          'geometry': `For geometry problems, always check your units and formulas. The answer ${correctAnswer} comes from applying the right formula. Draw it out if it helps!`,
          'grammar': `Grammar rules can be tricky! The correct answer is "${correctAnswer}". Try reading the sentence out loud to hear what sounds right.`,
          'general': `Don't worry about getting it wrong - that's how we learn! The correct answer is ${correctAnswer}. Think about what makes this answer right.`
        };
        return fallbacks[tag] || fallbacks.general;
      };

      const generateExplanation = async () => {
        if (!question?.question || userAnswer == null || correctAnswer == null) {
          setLoading(false);
          return;
        }

        setLoading(true);
        setError(null);
        setExplanation('');

        // Abort any in-flight request
        if (abortRef.current) abortRef.current.abort();
        const controller = new AbortController();
        abortRef.current = controller;
        const thisReq = ++reqRef.current;

        try {
          const hasOptions = Array.isArray(question.options) && question.options.length > 0;
          const optionsText = hasOptions
            ? `Options: ${question.options.map((opt, i) => `${i + 1}) ${opt}`).join(' | ')}`
            : '';

          const prompt = `
You are a kind, concise tutor for a 10-year-old student. Explain clearly why the user's answer is not correct and why the correct answer is right. Keep it short and encouraging.

Question: ${question.question}
${optionsText ? optionsText + '\n' : ''}User's answer: ${String(userAnswer)}
Correct answer: ${String(correctAnswer)}
`;

          const payload = {
            contents: [
              {
                role: 'user',
                parts: [{ text: prompt }]
              }
            ]
          };

          const response = await fetch('/.netlify/functions/gemini-proxy', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
            signal: controller.signal
          });

          if (!response.ok) {
            let errorBody = {};
            try { errorBody = await response.json(); } catch {}
            throw new Error(errorBody.error?.message || `HTTP ${response.status}`);
          }

          const data = await response.json();

          if (!mountedRef.current || thisReq !== reqRef.current) return;

          const aiText =
            parseAIResponse(data) ||
            data?.candidates?.[0]?.content?.parts?.[0]?.text ||
            data?.explanation ||
            data?.response ||
            data?.message ||
            data?.text ||
            '';

          if (typeof aiText === 'string' && aiText.trim()) {
            setExplanation(aiText.trim());
          } else {
            setExplanation(getGenericExplanation(question, userAnswer, correctAnswer));
          }
        } catch (err) {
          if (err?.name === 'AbortError') return;
          console.error('Error generating AI explanation:', err);
          setError('Failed to generate explanation');
          setExplanation(getGenericExplanation(question, userAnswer, correctAnswer));
        } finally {
          if (mountedRef.current && thisReq === reqRef.current) setLoading(false);
        }
      };
      
      useEffect(() => {
        setExplanation('');
        const hasQuestion = typeof question?.question === 'string' && question.question.trim().length > 0;
        const hasCorrectAnswer = correctAnswer !== null && correctAnswer !== undefined;
        const hasUserAnswer = userAnswer !== undefined && userAnswer !== null;
        if (hasQuestion && hasCorrectAnswer && hasUserAnswer) {
          generateExplanation();
        } else {
          setLoading(false);
        }
        // Cleanup current in-flight when deps change
        return () => {
          if (abortRef.current) abortRef.current.abort();
        };
      }, [question, userAnswer, correctAnswer]);


      if (loading) {
        return (
          <div className="mt-3 p-4 bg-blue-50 border border-blue-200 rounded-lg">
            <div className="flex items-center gap-2">
              <div className="animate-spin w-4 h-4 border-2 border-blue-600 border-t-transparent rounded-full"></div>
              <span className="text-blue-800">Getting explanation...</span>
            </div>
          </div>
        );
      }

      return (
        <div className="mt-3 p-4 bg-blue-50 border border-blue-200 rounded-lg">
          <div className="flex items-start justify-between gap-3">
            <div className="flex-1">
              <div className="flex items-center gap-2 mb-2">
                <span className="text-lg">🤖</span>
                <span className="font-medium text-blue-800">Why was this wrong?</span>
              </div>
              <p className="text-blue-700 text-sm leading-relaxed">{explanation}</p>
            </div>
            <button
              onClick={onClose}
              className="text-blue-600 hover:text-blue-800 text-sm"
            >
              ✕
            </button>
          </div>
        </div>
      );
    };


    const LoadingSpinner = ({ message }) => (
      <div className="flex flex-col justify-center items-center h-screen bg-slate-900">
        <div className="animate-spin rounded-full h-32 w-32 border-t-4 border-b-4 border-cyan-400 mb-4"></div>
        <p className="text-lg text-cyan-400 font-orbitron">{message}</p>
      </div>
    );

    const CharacterMessage = ({ message, character }) => {
      const characters = { GameMaster: "🎮" };
      return (
        <div className="bg-slate-800 border-l-4 border-cyan-400 text-cyan-100 p-4 my-6 rounded-r-lg shadow-lg flex items-center">
          <span className="text-4xl mr-4">{characters[character] || '🤖'}</span>
          <p className="font-semibold">{message}</p>
        </div>
      );
    };

    const Notification = ({ message, type, onDismiss }) => {
      useEffect(() => {
        const timer = setTimeout(() => {
          if (typeof onDismiss === 'function') onDismiss();
        }, 3000);
        return () => clearTimeout(timer);
      }, [onDismiss]);

      const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
      return (
        <div
          className={`notification-bar p-4 rounded-lg text-white font-bold shadow-lg ${bgColor}`}
          role="status"
          aria-live="polite"
        >
          {message}
        </div>
      );
    };

    const Modal = ({ title, message, onConfirm, onCancel, confirmText, children }) => {
      const isDestructive = ['Delete', 'Reset', 'Remove', 'Overwrite'].includes(confirmText);
      const dialogRef = useRef(null);

      useEffect(() => {
        // Focus first button or container
        const toFocus = dialogRef.current?.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
        toFocus?.focus?.();

        const onKeyDown = (e) => {
          if (e.key === 'Escape') {
            e.stopPropagation();
            if (onCancel) onCancel();
          }
        };
        document.addEventListener('keydown', onKeyDown);
        return () => document.removeEventListener('keydown', onKeyDown);
      }, [onCancel]);

      const titleId = 'modal-title';

      return (
        <div className="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby={titleId}>
          <div ref={dialogRef} className="bg-slate-800 border border-cyan-500 rounded-xl shadow-2xl p-8 w-full max-w-md text-center">
            <h2 id={titleId} className="text-2xl font-bold font-orbitron text-cyan-300 mb-4">{title}</h2>
            {message && <p className="text-slate-300 mb-8">{message}</p>}
            {children}
            <div className="flex justify-center gap-4 mt-8">
              {onCancel && <button onClick={onCancel} className="bg-slate-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-slate-500">Cancel</button>}
              {onConfirm && !!confirmText && (
                <button
                  onClick={onConfirm}
                  className={`font-bold py-2 px-6 rounded-lg ${isDestructive ? 'bg-red-600 hover:bg-red-500 text-white' : 'bg-green-600 hover:bg-green-500 text-white'}`}
                >
                  {confirmText}
                </button>
              )}
            </div>
          </div>
        </div>
      );
    };
    
    const CustomModeSelector = ({ onStart }) => {
        const [useTimer, setUseTimer] = useState(true);
        const [useHints, setUseHints] = useState(false);
        const [shuffle, setShuffle] = useState(false);
        
        return (
            <div className="text-left p-4 bg-slate-700 rounded-lg mt-4 border border-slate-600">
                <h4 className="font-bold text-lg text-center mb-4">Custom Settings</h4>
                <div className="space-y-4">
                    <div className="flex items-center justify-between">
                        <label htmlFor="timer-toggle" className="font-semibold text-slate-300">Enable Timer</label>
                        <input id="timer-toggle" type="checkbox" checked={useTimer} onChange={() => setUseTimer(!useTimer)} className="w-6 h-6 rounded text-cyan-500 bg-slate-800 border-slate-500 focus:ring-cyan-600" />
                    </div>
                    <div className="flex items-center justify-between">
                        <label htmlFor="hints-toggle" className="font-semibold text-slate-300">Enable Hints & Feedback</label>
                        <input id="hints-toggle" type="checkbox" checked={useHints} onChange={() => setUseHints(!useHints)} className="w-6 h-6 rounded text-cyan-500 bg-slate-800 border-slate-500 focus:ring-cyan-600" />
                    </div>
                    <div className="flex items-center justify-between">
                        <label htmlFor="shuffle-toggle" className="font-semibold text-slate-300">Shuffle Questions</label>
                        <input id="shuffle-toggle" type="checkbox" checked={shuffle} onChange={() => setShuffle(!shuffle)} className="w-6 h-6 rounded text-cyan-500 bg-slate-800 border-slate-500 focus:ring-cyan-600" />
                    </div>
                </div>
                <button 
                    onClick={() => onStart({ mode: 'Custom', timer: useTimer, hints: useHints, shuffle: shuffle })} 
                    className="w-full text-center p-3 mt-6 bg-purple-700 hover:bg-purple-600 rounded-lg font-bold"
                >
                    Start Custom Test
                </button>
            </div>
        );
    }

    // --- Main App Components ---
    const Dashboard = ({ userData, setView, setSelectedTest, allTests, showModal, hideModal, updateUserData, appData, updateAllData, showNotification }) => {
      const xpForNextLevel = userData.level * 100;
      const xpPercent = (userData.xp / xpForNextLevel) * 100;

      const handleSelectTest = (testId) => {
        const test = allTests.find(t => t.id === testId);
        const progress = userData.progress?.[testId];
        const totalQ = test?.questions?.length || 0;
        const answered = progress ? Object.keys(progress.answers || {}).length : 0;

        if (progress && answered > 0 && answered < totalQ) {
          setSelectedTest({ id: testId, settings: progress.settings || { mode: 'Practice', shuffle: false } });
          setView('quiz');
          return;
        }

        showModal({
          title: "Choose Your Mode",
          children: (
            <div className="space-y-4">
              <button onClick={() => { setSelectedTest({ id: testId, settings: { mode: 'Practice', shuffle: false } }); setView('quiz'); hideModal(); }} className="w-full text-left p-4 bg-cyan-700 hover:bg-cyan-600 rounded-lg">
                <h3 className="font-bold text-cyan-200">Practice Mode</h3>
                <p className="text-sm text-slate-300">No timer, hints enabled, and live feedback on your answers.</p>
              </button>
              <button onClick={() => { setSelectedTest({ id: testId, settings: { mode: 'Test', shuffle: false } }); setView('quiz'); hideModal(); }} className="w-full text-left p-4 bg-yellow-700 hover:bg-yellow-600 rounded-lg">
                <h3 className="font-bold text-yellow-200">Test Mode</h3>
                <p className="text-sm text-slate-300">A timer will run, hints are disabled, and results are shown only at the end.</p>
              </button>
              <CustomModeSelector onStart={(settings) => {
                  setSelectedTest({ id: testId, settings });
                  setView('quiz');
                  hideModal();
              }} />
            </div>
          ),
          onCancel: () => {},
          confirmText: null
        });
      };

      if (!userData) return <LoadingSpinner message="Loading user data..." />;

      const handleDailyChallenge = () => {
        let allQuestions = allTests.flatMap(test => test.questions);
        const dailyQuestions = allQuestions.sort(() => 0.5 - Math.random()).slice(0, 5);
        const challengeTest = {
          id: 'daily-challenge',
          title: 'Daily Challenge',
          subject: 'Mixed',
          questions: dailyQuestions
        };
        updateAllData({ ...appData, allTests: [...allTests.filter(t => t.id !== 'daily-challenge'), challengeTest] });
        setSelectedTest({ id: 'daily-challenge', settings: { mode: 'Practice', shuffle: true } });
        setView('quiz');
      };

      const handlePracticeMistakes = () => {
        const incorrectQuestions = [];
        const seenQuestions = new Set();

        Object.entries(userData.progress || {}).forEach(([testId, progressData]) => {
          if (testId === 'mistakes-test') return;

          const test = allTests.find(t => t.id === testId);
          if (!test) return;

          Object.entries(progressData.answers || {}).forEach(([qIndexStr, userAnswer]) => {
            const qIndex = Number(qIndexStr);
            if (Number.isNaN(qIndex) || qIndex < 0 || qIndex >= test.questions.length) return;

            const question = test.questions[qIndex];
            if (!question) return;

            if (!isAnswerCorrect(question, userAnswer) && !seenQuestions.has(question.question)) {
              incorrectQuestions.push({ 
                ...question, 
                originalTestId: testId, 
                originalQIndex: qIndex 
              });
              seenQuestions.add(question.question);
            }
          });
        });

        if (incorrectQuestions.length === 0) {
          showNotification({message: "No mistakes to practice. Great job!", type: "success"});
          return;
        }

        const mistakesTest = {
          id: 'mistakes-test',
          title: 'Practice Your Mistakes',
          subject: 'Mixed',
          questions: incorrectQuestions
        };

        updateAllData({ ...appData, allTests: [...allTests.filter(t => t.id !== 'mistakes-test'), mistakesTest] });
        setSelectedTest({ id: 'mistakes-test', settings: { mode: 'Practice', shuffle: true } });
        setView('quiz');
      };

      const hasMistakes = Object.values(userData.progress || {}).some(p => (p.score || 0) < Object.keys(p.answers || {}).length);

      const getGameMasterMessage = () => {
        const entries = Object.entries(userData.progress || {});
        const completed = entries.map(([id, p]) => {
          const test = allTests.find(t => t.id === id);
          if (!test) return null;
          const total = test.questions.length;
          const answered = Object.keys(p.answers || {}).length;
          if (p.settings?.mode === 'Test' && answered === total) {
            return { id, p, test, completedAt: p.completedAt || 0 };
          }
          return null;
        }).filter(Boolean);
        if (completed.length) {
          completed.sort((a, b) => (b.completedAt || 0) - (a.completedAt || 0));
          const { test, p } = completed[0];
          const scorePercentage = test.questions.length ? ((p.score || 0) / test.questions.length) * 100 : 0;
          if (scorePercentage >= 90) {
            return `Incredible work on ${test.title}! You're a real pro!`;
          } else if (scorePercentage < 50) {
            return `That was a tough one! The 'Practice Mistakes' button is a great way to master those tricky questions.`;
          }
        }
        return "Ready to ace these tests? Let's get started!";
      };

      return (
        <div className="p-4 sm:p-8 min-h-screen">
          <div className="max-w-7xl mx-auto">
            <div className="flex flex-wrap justify-between items-center mb-4 gap-4">
              <h1 className="text-3xl sm:text-4xl font-bold font-orbitron glowing-text text-cyan-300 flex items-center">
                <span className="text-5xl mr-4">{userData.avatar || '👨\u200d🚀'}</span>
                Welcome, {userData.name}! {userData.title && <span className="text-lg ml-4 bg-yellow-500/20 text-yellow-300 px-3 py-1 rounded-full border border-yellow-500">{userData.title}</span>}
              </h1>
              <div className="flex gap-2">
                <button onClick={() => setView('settings')} className="bg-slate-700 text-cyan-300 font-semibold py-2 px-4 rounded-lg hover:bg-slate-600 transition-colors">Profile</button>
                <button onClick={() => setView('achievements')} className="bg-slate-700 text-cyan-300 font-semibold py-2 px-4 rounded-lg hover:bg-slate-600 transition-colors">Achievements</button>
                <button onClick={() => setView('admin')} className="bg-slate-700 text-cyan-300 font-semibold py-2 px-4 rounded-lg hover:bg-slate-600 transition-colors">Admin Panel</button>
              </div>
            </div>

            <div className="bg-slate-800/50 border border-slate-700 rounded-xl p-4 mb-8">
              <div className="flex justify-between items-center mb-2 font-orbitron">
                <span className="font-bold text-cyan-300">Level {userData.level}</span>
                <span className="text-sm text-slate-400">{userData.xp} / {xpForNextLevel} XP</span>
              </div>
              <div className="w-full bg-slate-700 rounded-full h-4 border-2 border-slate-600">
                <div className="bg-gradient-to-r from-cyan-500 to-blue-500 h-full rounded-full transition-all duration-500" style={{ width: `${Math.min(100, Math.max(0, xpPercent))}%` }}></div>
              </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
              <div className="bg-slate-800/50 border-2 border-purple-500 rounded-xl p-6 shadow-lg">
                <div className="flex justify-between items-center">
                  <div>
                    <h2 className="text-2xl font-orbitron text-purple-300">Daily Challenge</h2>
                    <p className="text-slate-400">A quick warm-up to get you started!</p>
                  </div>
                  <div className="text-center">
                    <div className="text-4xl">🔥</div>
                    <div className="font-bold text-xl">{userData.dailyChallengeStreak || 0} Day Streak</div>
                  </div>
                </div>
                <div className="mt-4">
                  {userData.dailyChallenge?.completedToday ? (
                    <p className="text-center text-green-400 font-bold p-3 bg-slate-800 rounded-lg">Challenge Complete! Come back tomorrow.</p>
                  ) : (
                    <button onClick={handleDailyChallenge} className="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-500">Start Daily Challenge</button>
                  )}
                </div>
              </div>
              <div className="bg-slate-800/50 border-2 border-orange-500 rounded-xl p-6 shadow-lg">
                <h2 className="text-2xl font-orbitron text-orange-300">Review Mistakes</h2>
                <p className="text-slate-400 mb-4">Tackle the questions you've gotten wrong before.</p>
                <button onClick={handlePracticeMistakes} disabled={!hasMistakes} className="w-full bg-orange-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-orange-500 disabled:bg-slate-600 disabled:cursor-not-allowed">
                  Practice Your Mistakes
                </button>
              </div>
            </div>

            <CharacterMessage message={getGameMasterMessage()} character="GameMaster" />
            
            <div className="bg-slate-800/50 border border-slate-700 rounded-xl shadow-lg p-6">
              <h2 className="text-2xl font-bold font-orbitron text-cyan-300 mb-6">Available Tests</h2>
              {allTests.length > 0 ? (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                  {allTests.filter(t => !t.isBoss).map(test => (
                    <TestCard key={test.id} testId={test.id} test={test} onStart={() => handleSelectTest(test.id)} progress={userData.progress?.[test.id]} />
                  ))}
                </div>
              ) : (
                <p className="text-slate-400">No tests found. Create one in the Admin Panel.</p>
              )}
            </div>
          </div>
        </div>
      );
    };

    const TestCard = ({ testId, test, onStart, progress }) => {
      const questionsCount = test.questions.length;
      const answeredCount = progress ? Object.keys(progress.answers || {}).length : 0;
      const progressPercent = questionsCount > 0 ? (answeredCount / questionsCount) * 100 : 0;

      return (
        <div className="bg-slate-800 border border-slate-700 rounded-lg p-5 flex flex-col justify-between hover:border-cyan-400 hover:shadow-cyan-500/10 hover:shadow-lg transition-all">
          <div>
            <h3 className="text-xl font-bold font-orbitron text-cyan-300">{test.title}</h3>
            <p className="text-slate-400 mb-4">{test.subject} - {questionsCount} Questions</p>
            <div className="w-full bg-slate-700 rounded-full h-2.5 mb-2">
              <div className="bg-cyan-400 h-2.5 rounded-full" style={{ width: `${progressPercent}%` }}></div>
            </div>
            <p className="text-sm text-slate-400 mb-4">{answeredCount} / {questionsCount} answered</p>
          </div>
          <button onClick={onStart} className="w-full bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-500 transition-colors">
            {answeredCount > 0 && answeredCount < questionsCount ? 'Continue Test' : 'Start Test'}
          </button>
        </div>
      );
    };

    const QuestionNavigator = ({ total, current, answeredIndices, onNavigate }) => {
        return (
            <div className="flex flex-wrap gap-2 my-4">
                {Array.from({ length: total }, (_, i) => {
                    const isAnswered = answeredIndices.has(i);
                    const isCurrent = i === current;
                    let buttonClass = 'bg-slate-700 hover:bg-slate-600';
                    if (isCurrent) {
                        buttonClass = 'bg-cyan-500 ring-2 ring-cyan-200';
                    } else if (isAnswered) {
                        buttonClass = 'bg-slate-600 border border-slate-500';
                    }
                    return (
                        <button key={i} onClick={() => onNavigate(i)}
                          aria-label={`Go to question ${i + 1}${isAnswered ? ' (answered)' : ''}`}
                          className={`w-10 h-10 rounded-md font-mono font-bold transition-all ${buttonClass}`}>
                          {i + 1}
                        </button>
                    );
                })}
            </div>
        );
    }
    
    const QuizView = ({ userData, testDetails, setView, allTests, updateUserData, updateAllData, showNotification, showModal }) => {
      const { id: testId, settings } = testDetails;
      const test = allTests.find(t => t.id === testId);

      const existingProgress = userData?.progress?.[testId] || {};
      const [currentQuestionIndex, setCurrentQuestionIndex] = useState(existingProgress?.lastQuestionIndex || 0);
      const [userAnswers, setUserAnswers] = useState(existingProgress?.answers || {});
      const [submittedAnswers, setSubmittedAnswers] = useState({});
      const [streak, setStreak] = useState(existingProgress?.streak || 0);
      const [hint, setHint] = useState(null);
      const [isHintLoading, setIsHintLoading] = useState(false);
      const [feedback, setFeedback] = useState(null);
      const [flash, setFlash] = useState(null);
      const [shuffledOrder, setShuffledOrder] = useState(null);
      const [showExplanation, setShowExplanation] = useState(false);
      const [lastAnswerResult, setLastAnswerResult] = useState(null);
      const [questionStartTime, setQuestionStartTime] = useState(Date.now());
      const hintAbortRef = useRef(null);
      const hintReqRef = useRef(0);
      const quizMountedRef = useRef(true);

      useEffect(() => {
        quizMountedRef.current = true;
        return () => {
          quizMountedRef.current = false;
          if (hintAbortRef.current) hintAbortRef.current.abort();
        };
      }, []);

      const totalTime = test?.subject === 'Mixed' ? 60 * 60 : 30 * 60;
      const getInitialTime = () => {
        const savedTime = existingProgress?.timeLeft;
        return (savedTime !== undefined && savedTime > 0) ? savedTime : totalTime;
      };
      const [timeLeft, setTimeLeft] = useState(getInitialTime);
      const [isPaused, setIsPaused] = useState(false);
      const initialTotalRef = useRef(existingProgress?.initialTotalTime || totalTime);

      const timerEnabled = settings.mode === 'Test' || (settings.mode === 'Custom' && settings.timer);
      
      const answeredSet = useMemo(() => {
        const keys = Object.keys(userAnswers).map(Number);
        if (!shuffledOrder) return new Set(keys);
        const pos = new Set();
        keys.forEach(origIdx => {
          const shuffledPos = shuffledOrder.indexOf(origIdx);
          if (shuffledPos !== -1) pos.add(shuffledPos);
        });
        return pos;
      }, [userAnswers, shuffledOrder]);

      useEffect(() => {
        if (!timerEnabled || isPaused) return;
        const id = setInterval(() => {
          setTimeLeft(t => (t > 0 ? t - 1 : 0));
        }, 1000);
        return () => clearInterval(id);
      }, [timerEnabled, isPaused]);
      
      useEffect(() => {
        if (settings.shuffle && !existingProgress.shuffledOrder) {
            const indices = Array.from(test.questions.keys());
            for (let i = indices.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [indices[i], indices[j]] = [indices[j], indices[i]];
            }
            setShuffledOrder(indices);
            const newProgress = { ...userData.progress, [testId]: { ...existingProgress, shuffledOrder: indices, settings } };
            updateUserData({ ...userData, progress: newProgress }, { event: { type: 'NO_OP' } });
        } else if (existingProgress.shuffledOrder) {
            setShuffledOrder(existingProgress.shuffledOrder);
        }
      }, []); // eslint-disable-line react-hooks/exhaustive-deps

      useEffect(() => {
        if (!test) return;
        if (currentQuestionIndex >= test.questions.length) {
          setCurrentQuestionIndex(Math.max(0, test.questions.length - 1));
        }
      }, [test, currentQuestionIndex]);

      const calculateScore = useCallback(() => {
        return Object.entries(userAnswers).reduce((acc, [index, userAnswer]) => {
          const question = test.questions[index];
          if (isAnswerCorrect(question, userAnswer)) {
            return acc + 1;
          }
          return acc;
        }, 0);
      }, [userAnswers, test.questions]);

      const saveProgress = useCallback((isFinished = false, options = {}) => {
        const { silentAchievements = false, auto = false, overrideIndex } = options;
        const score = calculateScore();
        const now = Date.now();
        let newUserData = { ...userData };
        const newProgressEntry = { 
          answers: userAnswers, 
          lastQuestionIndex: (typeof overrideIndex === 'number') ? overrideIndex : currentQuestionIndex, 
          score: score, 
          timeLeft: timeLeft, 
          streak: streak, 
          settings: settings,
          initialTotalTime: initialTotalRef.current,
          ...(shuffledOrder && { shuffledOrder }),
          ...(isFinished ? { completedAt: now } : {})
        };
        const newProgress = { ...newUserData.progress, [testId]: newProgressEntry };
        newUserData.progress = newProgress;
        
        const lastOriginalIndex = shuffledOrder ? shuffledOrder[test.questions.length - 1] : (test.questions.length - 1);
        const lastAnswer = userAnswers[lastOriginalIndex];

        const postTestContext = {
            finishedTestId: testId,
            totalQuestions: test.questions.length,
            score,
            mode: settings.mode,
            timeLeft,
            initialTotalTime: initialTotalRef.current,
            testHasGeometry: test.questions.some(q => (q.tags || []).includes('geometry')),
            lastQuestionCorrect: isAnswerCorrect(test.questions[lastOriginalIndex], lastAnswer),
            isFullPractice: testId.startsWith('full-test') || test.questions.length === 56,
            isDailyChallenge: testId === 'daily-challenge',
            finishedAt: now,
            allAnswers: userAnswers,
            testQuestions: test.questions
        };

        updateUserData(newUserData, {
          silentAchievements: !!silentAchievements || !!auto,
          event: isFinished ? { type: 'PACK_COMPLETED', payload: postTestContext } : undefined
        });
      }, [userData, testId, userAnswers, currentQuestionIndex, calculateScore, timeLeft, streak, settings, updateUserData, test, shuffledOrder]);

      const handleFinish = useCallback((auto = false) => { 
        if (testId === 'mistakes-test') {
          const newProgress = { ...userData.progress };
          const correctlyAnsweredMistakes = [];

          test.questions.forEach((q, index) => {
            const userAnswer = userAnswers[index];
            if (isAnswerCorrect(q, userAnswer)) {
              correctlyAnsweredMistakes.push({
                testId: q.originalTestId,
                qIndex: q.originalQIndex,
                answer: q.answer
              });
            }
          });

          const affectedTests = new Set();
          correctlyAnsweredMistakes.forEach(correction => {
            const target = newProgress[correction.testId];
            if (!target) return;
            if (!target.answers) target.answers = {};
            const idx = Number(correction.qIndex);
            if (!Number.isNaN(idx)) {
              target.answers[idx] = correction.answer;
              affectedTests.add(correction.testId);
            }
          });

          affectedTests.forEach(tid => {
            const t = allTests.find(tt => tt.id === tid);
            if (t) {
              const p = newProgress[tid];
              const newScore = Object.entries(p.answers || {}).reduce((acc, [idx, ua]) => {
                return acc + (isAnswerCorrect(t.questions[idx], ua) ? 1 : 0);
              }, 0);
              newProgress[tid] = { ...p, score: newScore };
            }
          });
          
          const updatedUser = { ...userData, progress: newProgress };
          updateUserData(updatedUser, { 
            event: { 
                type: 'MISTAKES_REVIEWED', 
                payload: { corrections: correctlyAnsweredMistakes.length } 
            }
          });
          
          showModal({
            title: "Practice Complete!",
            message: "Well done! Your corrected answers have been updated.",
            onConfirm: () => setView('dashboard'),
            confirmText: "Back to Dashboard"
          });
        } else {
          saveProgress(true);
          setView('results');
          if (!auto) {
            showNotification({message: 'Test finished!', type: 'success'});
          }
        }
      }, [testId, test, userAnswers, userData, allTests, setView, showModal, showNotification, updateUserData, saveProgress]);

      useEffect(() => {
        if (timerEnabled && timeLeft === 0) {
          setIsPaused(true);
          handleFinish(true);
        }
      }, [timeLeft, timerEnabled, handleFinish]);
      
      useEffect(() => {
        // Always save on tab close or when the page becomes hidden
        const handleImmediateSave = () => { try { saveProgress(false, { auto: true }); } catch {} };
        const handleVisibility = () => {
          if (document.visibilityState === 'hidden') handleImmediateSave();
        };
        window.addEventListener('beforeunload', handleImmediateSave);
        document.addEventListener('visibilitychange', handleVisibility);
        
        // For timed modes, also autosave every 10s
        let interval;
        if (settings.mode !== 'Practice') {
          interval = setInterval(() => saveProgress(false, { auto: true }), 10000);
        }
        
        return () => {
          if (interval) clearInterval(interval);
          window.removeEventListener('beforeunload', handleImmediateSave);
          document.removeEventListener('visibilitychange', handleVisibility);
        };
      }, [saveProgress, settings.mode]);

      const originalIndex = shuffledOrder ? shuffledOrder[currentQuestionIndex] : currentQuestionIndex;

      const handleAnswerSelect = (answer) => {
        if (timerEnabled && timeLeft === 0) return;
        const newAnswers = { ...userAnswers, [originalIndex]: answer };
        setUserAnswers(newAnswers);
      };

      const showInstantFeedback = settings.mode === 'Practice' || (settings.mode === 'Custom' && settings.hints);

      const handleSubmitAnswer = () => {
        const answer = userAnswers[originalIndex];
        if (answer === undefined || answer === null || answer === "") return;

        setSubmittedAnswers({...submittedAnswers, [currentQuestionIndex]: true});

        const question = test.questions[originalIndex];
        const isCorrect = isAnswerCorrect(question, answer);
        const timeToAnswer = (Date.now() - questionStartTime) / 1000;
        
        setLastAnswerResult({ isCorrect, userAnswer: answer, question });

        const event = {
            type: 'ANSWER_SUBMITTED',
            payload: {
                correct: isCorrect,
                timeToAnswer,
                usedHint: !!hint,
                tags: question.tags || [],
                wasReviewed: testId === 'mistakes-test',
                mode: settings.mode,
                testId
            }
        };
        
        updateUserData({ ...userData }, { event });

        const newStreak = isCorrect ? streak + 1 : 0;
        setStreak(newStreak);

        setFlash(isCorrect ? 'correct' : 'incorrect');
        setTimeout(() => setFlash(null), 500);

        if (showInstantFeedback) {
          setFeedback(isCorrect ? "Correct! Great job!" : `Not quite. The correct answer is: ${question.answer}`);
        }

        saveProgress(false);

        if (!showInstantFeedback && currentQuestionIndex < test.questions.length - 1) {
            setTimeout(goToNext, 200);
        }
      };

      const navigateToQuestion = (index) => {
        if (index >= 0 && index < test.questions.length) {
            setFeedback(null);
            setHint(null);
            setShowExplanation(false);
            setLastAnswerResult(null);
            setCurrentQuestionIndex(index);
            setQuestionStartTime(Date.now());
            saveProgress(false, { overrideIndex: index });
        }
      };

      const goToNext = () => {
        if (currentQuestionIndex < test.questions.length - 1) {
          navigateToQuestion(currentQuestionIndex + 1);
        }
      };

      const handlePause = () => { 
        setIsPaused(true); 
        saveProgress(false, { auto: true }); 
        showNotification({message: 'Progress saved!', type: 'success'});
        setView('dashboard'); 
      };

      const fetchHint = async () => {
        setIsHintLoading(true);
        setHint(null);

        if (hintAbortRef.current) hintAbortRef.current.abort();
        const controller = new AbortController();
        hintAbortRef.current = controller;
        const thisReq = ++hintReqRef.current;

        try {
          const question = test.questions[originalIndex];
          const prompt = `You are a helpful teaching assistant for a 10-year-old student. Provide a short, simple hint for the following question. Do NOT give the answer. Just provide a small clue to help the student think about the problem correctly. Question: "${question.question}"`;
          
          const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
          const apiUrl = `/.netlify/functions/gemini-proxy`;
          const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
            signal: controller.signal
          });

          if (!response.ok) {
            let errorBody = {};
            try { errorBody = await response.json(); } catch {}
            throw new Error(`API Error: ${errorBody.error?.message || response.statusText}`);
          }

          const result = await response.json();
          const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;

          if (!quizMountedRef.current || thisReq !== hintReqRef.current) return;

          if (text) {
            setHint(text);
          } else {
            throw new Error("Invalid API response structure.");
          }
        } catch (error) {
          if (error?.name === 'AbortError') return;
          console.error("AI API Error:", error);
          showModal({
            title: "AI Feature Error",
            message: `Could not complete AI request. Please check your connection. Error: ${error.message}`,
            onConfirm: () => {},
            confirmText: "OK"
          });
          setHint("Sorry, could not get a hint at this time.");
        } finally {
          if (quizMountedRef.current && thisReq === hintReqRef.current) setIsHintLoading(false);
        }
      };

      if (!test || (settings.shuffle && !shuffledOrder)) return <LoadingSpinner message="Loading Test..." />;
      
      let currentQ;
      if (Array.isArray(test.questions) && test.questions.length > 0) {
        currentQ = test.questions[originalIndex] ?? test.questions[currentQuestionIndex] ?? test.questions[0];
      }

      if (!currentQ) {
        return (
          <div className="p-8 min-h-screen flex items-center justify-center">
            <div className="bg-slate-800 border border-slate-700 rounded-xl p-6 max-w-xl w-full text-center">
              <h2 className="text-2xl font-bold text-cyan-300 mb-2 font-orbitron">No questions available</h2>
              <p className="text-slate-300 mb-4">We couldn't load the questions for this session. This can happen if question indexes are out of sync.</p>
              <button onClick={() => setView('dashboard')} className="bg-cyan-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-cyan-500">
                Back to Dashboard
              </button>
            </div>
          </div>
        );
      }

      const isCurrentQSubmitted = !!submittedAnswers[currentQuestionIndex];
      const isLocked = timerEnabled && timeLeft === 0;
      const hintsEnabled = settings.mode === 'Practice' || (settings.mode === 'Custom' && settings.hints);
      
      return (
        <div className={`p-4 sm:p-8 min-h-screen flex items-center justify-center ${flash === 'correct' ? 'flash-correct' : ''} ${flash === 'incorrect' ? 'flash-incorrect' : ''}`}>
          <div className="bg-slate-800 border border-slate-700 rounded-xl shadow-2xl p-6 sm:p-8 w-full max-w-4xl">
            <div className="flex justify-between items-center mb-2">
              <h2 className="text-xl sm:text-2xl font-bold font-orbitron text-cyan-300">{test.title}</h2>
              {streak > 1 && <span className="text-lg text-orange-400 font-orbitron">🔥 {streak} Streak!</span>}
              {timerEnabled && <div className="text-lg sm:text-xl font-mono bg-slate-900 text-cyan-300 px-4 py-2 rounded-lg glowing-border">{Math.floor(timeLeft / 60)}:{('0' + timeLeft % 60).slice(-2)}</div>}
            </div>
            
            <QuestionNavigator
              total={test.questions.length}
              current={currentQuestionIndex}
              answeredIndices={answeredSet}
              onNavigate={navigateToQuestion}
            />

            <hr className="border-slate-600 my-4" />

            <p className="text-center font-mono text-slate-400 mb-4">Question {currentQuestionIndex + 1} of {test.questions.length}</p>
            <div className="mb-6 min-h-[6rem]"><p className="text-lg text-gray-300">{currentQ.question}</p></div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
              {currentQ.options ? currentQ.options.map((option, index) => (
                <button key={index} onClick={() => handleAnswerSelect(option)} disabled={isCurrentQSubmitted || isLocked} className={`p-4 rounded-lg border-2 text-left transition-all ${userAnswers[originalIndex] === option ? 'bg-cyan-900 border-cyan-400' : 'bg-slate-700 border-slate-600 hover:bg-slate-600'} ${isCurrentQSubmitted || isLocked ? 'cursor-not-allowed opacity-70' : ''}`}>{option}</button>
              )) : <textarea value={userAnswers[originalIndex] || ''} onChange={(e) => handleAnswerSelect(e.target.value)} disabled={isCurrentQSubmitted || isLocked} className="w-full col-span-2 p-4 bg-slate-700 border-2 border-slate-600 rounded-lg disabled:opacity-70" placeholder="Type your answer here..." rows="4"></textarea>}
            </div>

            {!isCurrentQSubmitted && (
              <div className="text-center my-4">
                <button onClick={handleSubmitAnswer} disabled={!userAnswers[originalIndex] || isLocked} className="bg-green-600 text-white font-bold py-2 px-8 rounded-lg hover:bg-green-500 disabled:bg-slate-600 disabled:cursor-not-allowed">
                    {showInstantFeedback ? 'Submit Answer' : 'Confirm Answer'}
                </button>
              </div>
            )}

            <div className="my-4 text-center">
              {hintsEnabled && <button onClick={fetchHint} disabled={isHintLoading || !!hint} className="text-sm text-cyan-400 hover:text-cyan-200 disabled:opacity-50 disabled:cursor-not-allowed">
                {isHintLoading ? '✨ Generating Hint...' : (hint ? 'Hint Revealed!' : '✨ Get a Hint')}
              </button>}
              {hint && <div className="mt-2 p-3 bg-slate-700 border border-slate-600 text-yellow-300 rounded-lg text-sm">{hint}</div>}
            </div>

            {feedback && <div className={`p-4 rounded-lg my-4 text-white ${feedback.startsWith('Correct') ? 'bg-green-500' : 'bg-red-500'}`}>{feedback}</div>}
            
            {lastAnswerResult && !lastAnswerResult.isCorrect && showInstantFeedback && !showExplanation && (
              <button onClick={() => setShowExplanation(true)} className="mt-2 px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">
                🤖 Explain my mistake
              </button>
            )}

            {showExplanation && (
              <AIExplanation
                key={currentQuestionIndex}
                question={lastAnswerResult.question}
                userAnswer={lastAnswerResult.userAnswer}
                correctAnswer={lastAnswerResult.question.answer}
                onClose={() => setShowExplanation(false)}
              />
            )}

            <div className="flex justify-between mt-8">
              <button onClick={handlePause} className="bg-yellow-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-yellow-500">Pause & Save</button>
              {currentQuestionIndex < test.questions.length - 1 ? (
                <button onClick={goToNext} disabled={(!isCurrentQSubmitted && showInstantFeedback) || isLocked} className="bg-cyan-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-cyan-500 disabled:bg-slate-600 disabled:cursor-not-allowed">Next</button>
              ) : (
                <button onClick={() => handleFinish(false)} disabled={(!isCurrentQSubmitted && showInstantFeedback) || isLocked} className="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-500 disabled:bg-slate-600 disabled:cursor-not-allowed">Finish Test</button>
              )}
            </div>
          </div>
        </div>
      );
    };

    const ResultsView = ({ userData, setView, testDetails, allTests, showModal }) => {
      const { id: testId } = testDetails;
      const test = allTests.find(t => t.id === testId);
      
      const progress = userData.progress?.[testId] || null;
      
      const [aiFeedback, setAiFeedback] = useState('');
      const [isFeedbackLoading, setIsFeedbackLoading] = useState(false);
      const [conceptExplanations, setConceptExplanations] = useState({});
      const [isLoadingExplanation, setIsLoadingExplanation] = useState(null);
      const fbAbortRef = useRef(null);
      const fbReqRef = useRef(0);
      const ceAbortRef = useRef(null);
      const ceReqRef = useRef(0);
      const mountedRef = useRef(true);

      useEffect(() => {
        mountedRef.current = true;
        return () => {
          mountedRef.current = false;
          if (fbAbortRef.current) fbAbortRef.current.abort();
          if (ceAbortRef.current) ceAbortRef.current.abort();
        };
      }, []);
      
      const userAnswers = progress?.answers || {};
      const score = progress?.score ?? 0;
      
      useEffect(() => {
        if (!progress) {
          setView('dashboard');
        }
      }, [progress, setView]);
      
      if (!test) return <LoadingSpinner message="Loading Results..." />;
      if (!progress) {
        return <LoadingSpinner message="No results found, redirecting..." />;
      }
      
      const topicStats = useMemo(() => {
        const stats = {};
        if (!test || !userAnswers) return [];
        test.questions.forEach((q, index) => {
          const tags = q.tags || ['General'];
          tags.forEach(tag => {
            if (!stats[tag]) {
              stats[tag] = { correct: 0, total: 0 };
            }
            stats[tag].total += 1;
            if (isAnswerCorrect(q, userAnswers[index])) {
              stats[tag].correct += 1;
            }
          });
        });
        return Object.entries(stats);
      }, [test, userAnswers]);

      const getAIFeedback = async () => {
        setIsFeedbackLoading(true);

        if (fbAbortRef.current) fbAbortRef.current.abort();
        const controller = new AbortController();
        fbAbortRef.current = controller;
        const thisReq = ++fbReqRef.current;

        try {
          const incorrectQuestions = test.questions.filter((q, i) => !isAnswerCorrect(q, userAnswers[i]));
          const prompt = `My son, Nicolas, just completed a test. He scored ${score} out of ${test.questions.length}. Here are the questions he got wrong: ${JSON.stringify(incorrectQuestions)}. Please provide a short, encouraging summary of his performance. Highlight his strengths based on the questions he likely got right, and gently point out one or two common themes or topics from the incorrect answers that he could focus on next time. Keep the tone positive and motivating for a 10-year-old.`;

          let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
          const payload = { contents: chatHistory };
          const apiUrl = `/.netlify/functions/gemini-proxy`;
          const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload), signal: controller.signal });
          if (!response.ok) {
            let errorBody = {};
            try { errorBody = await response.json(); } catch {}
            throw new Error(errorBody.error?.message || 'API error');
          }
          const result = await response.json();
          if (!mountedRef.current || thisReq !== fbReqRef.current) return;
          const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
          if(text) setAiFeedback(text); else throw new Error("Invalid AI response");
        } catch (error) {
          if (error?.name === 'AbortError') return;
          console.error("AI API Error:", error);
          showModal({
            title: "AI Feature Error",
            message: `Could not complete AI request. Please check your connection. Error: ${error.message}`,
            onConfirm: () => {},
            confirmText: "OK"
          });
          setAiFeedback("Sorry, couldn't generate feedback at this time.");
        } finally {
          if (mountedRef.current && thisReq === fbReqRef.current) setIsFeedbackLoading(false);
        }
      };
      
      const getConceptExplanation = async (question, index) => {
        setIsLoadingExplanation(index);

        if (ceAbortRef.current) ceAbortRef.current.abort();
        const controller = new AbortController();
        ceAbortRef.current = controller;
        const thisReq = ++ceReqRef.current;

        try {
          const prompt = `Please explain the concept behind this question for a 10-year-old. Question: "${question.question}". Correct Answer: "${question.answer}". Keep it simple and clear.`;
          let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
          const payload = { contents: chatHistory };
          const apiUrl = `/.netlify/functions/gemini-proxy`;
          const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload), signal: controller.signal });
          if (!response.ok) {
            let errorBody = {};
            try { errorBody = await response.json(); } catch {}
            throw new Error(errorBody.error?.message || 'API error');
          }
          const result = await response.json();
          if (!mountedRef.current || thisReq !== ceReqRef.current) return;
          const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
          if(text) setConceptExplanations(prev => ({...prev, [index]: text})); else throw new Error("Invalid AI response");
        } catch (error) {
          if (error?.name === 'AbortError') return;
          console.error("AI API Error:", error);
          showModal({
            title: "AI Feature Error",
            message: `Could not complete AI request. Please check your connection. Error: ${error.message}`,
            onConfirm: () => {},
            confirmText: "OK"
          });
          setConceptExplanations(prev => ({...prev, [index]: "Sorry, couldn't get an explanation."}));
        } finally {
          if (mountedRef.current && thisReq === ceReqRef.current) setIsLoadingExplanation(null);
        }
      };

      return (
        <div className="p-4 sm:p-8 min-h-screen">
          <div className="max-w-4xl mx-auto">
            <div className="bg-slate-800 border border-slate-700 rounded-xl shadow-2xl p-6 sm:p-8 w-full">
              <h2 className="text-4xl font-bold text-cyan-300 font-orbitron mb-2 text-center">Test Complete!</h2>
              <p className="text-2xl text-center mb-4">You scored: <span className="font-bold text-yellow-400">{score} / {test.questions.length}</span></p>
              
              <div className="bg-slate-700/50 p-4 rounded-lg my-6 border border-slate-600">
                <h3 className="font-bold font-orbitron text-cyan-300 mb-4 text-center">Review by Topic</h3>
                <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                    {topicStats.map(([tag, stats]) => (
                        <div key={tag} className="bg-slate-800 p-3 rounded-md text-center">
                            <p className="capitalize font-semibold text-slate-300">{tag}</p>
                            <p className="text-xl font-bold text-cyan-400">{stats.correct}/{stats.total}</p>
                            <p className="text-xs text-slate-400">({Math.round((stats.correct/stats.total) * 100)}%)</p>
                        </div>
                    ))}
                </div>
              </div>

              <div className="text-center my-6">
                <button onClick={getAIFeedback} disabled={isFeedbackLoading} className="bg-purple-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-purple-500 disabled:bg-slate-600">
                  {isFeedbackLoading ? '✨ Analyzing Performance...' : '✨ Get AI Feedback'}
                </button>
              </div>
              
              {aiFeedback && (
                <div className="bg-slate-700/50 p-4 rounded-lg my-4 border border-slate-600">
                  <h3 className="font-bold font-orbitron text-purple-300 mb-2">Performance Review</h3>
                  <p className="text-slate-300 whitespace-pre-wrap">{aiFeedback}</p>
                </div>
              )}

              <h3 className="font-bold font-orbitron text-cyan-300 my-6 text-center text-xl">Detailed Question Review</h3>
              <div className="space-y-4 mt-8">
                {test.questions.map((q, index) => {
                  const userAnswer = userAnswers[index];
                  const isCorrect = isAnswerCorrect(q, userAnswer);
                  return (
                    <div key={index} className={`p-4 rounded-lg border-l-4 ${isCorrect ? 'bg-green-900/40 border-green-500' : 'bg-red-900/40 border-red-500'}`}>
                      <p className="font-semibold text-slate-300 mb-2">{index + 1}. {q.question}</p>
                      <p className={`text-sm ${isCorrect ? 'text-green-400' : 'text-red-400'}`}>Your answer: <span className="font-bold">{userAnswer || "Not answered"}</span></p>
                      {!isCorrect && <p className="text-sm text-yellow-400">Correct answer: <span className="font-bold">{q.answer}</span></p>}
                      {!isCorrect && (
                        <div className="mt-2">
                          <button onClick={() => getConceptExplanation(q, index)} disabled={isLoadingExplanation === index} className="text-xs text-cyan-400 hover:text-cyan-200 disabled:opacity-50">
                            {isLoadingExplanation === index ? '✨ Explaining...' : '✨ Explain Concept'}
                          </button>
                          {conceptExplanations[index] && <p className="text-xs mt-1 p-2 bg-slate-700 rounded">{conceptExplanations[index]}</p>}
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>

              <div className="text-center mt-8">
                <button onClick={() => setView('dashboard')} className="bg-cyan-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-cyan-500">Back to Dashboard</button>
              </div>
            </div>
          </div>
        </div>
      )
    };

    const AdminView = ({ userData, setView, allTests, updateAllData, showModal, showNotification, handleFullReset }) => {
      const [adminView, setAdminView] = useState('main');
      const [editingTest, setEditingTest] = useState(null);
      const importFileRef = useRef(null);

      const handleResetProgress = (testId) => {
        showModal({
          title: "Reset Progress?",
          message: `Are you sure you want to reset all progress for this test? This action cannot be undone.`,
          confirmText: "Reset",
          onConfirm: () => {
            const newProgress = { ...userData.progress };
            delete newProgress[testId];
            updateAllData({ userData: { ...userData, progress: newProgress }, allTests });
            showNotification({message: "Progress reset successfully!", type: 'success'});
          }
        });
      };

      const handleDeleteTest = (testId) => {
        showModal({
          title: "Delete Test?",
          message: `Are you sure you want to permanently delete this test? This action cannot be undone.`,
          confirmText: "Delete",
          onConfirm: () => {
            const newAllTests = allTests.filter(t => t.id !== testId);
            const newProgress = { ...userData.progress };
            delete newProgress[testId];
            updateAllData({ userData: { ...userData, progress: newProgress }, allTests: newAllTests });
            showNotification({message: "Test deleted successfully!", type: 'success'});
          }
        });
      };
      
      const handleExportData = () => {
        try {
            const data = localStorage.getItem('seagPortalData');
            if (!data) {
                showNotification({ message: "No data found to export.", type: 'error' });
                return;
            }
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `seag-portal-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification({ message: "Data exported successfully!", type: 'success' });
        } catch (error) {
            showNotification({ message: `Export failed: ${error.message}`, type: 'error' });
        }
      };
      
      const handleImportData = (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const text = e.target.result;
                const importedData = JSON.parse(text);

                if (!importedData.userData || !importedData.allTests) {
                    throw new Error("Invalid backup file format.");
                }

                showModal({
                    title: "Confirm Import",
                    message: "Are you sure you want to overwrite all current data with the backup file? This cannot be undone.",
                    confirmText: "Overwrite",
                    onConfirm: () => {
                        updateAllData(importedData);
                        showNotification({ message: "Data imported successfully! The page will now reload.", type: 'success' });
                        setTimeout(() => window.location.reload(), 1500);
                    }
                });
            } catch (error) {
                showNotification({ message: `Import failed: ${error.message}`, type: 'error' });
            } finally {
                if(importFileRef.current) importFileRef.current.value = "";
            }
        };
        reader.readAsText(file);
      };

      const handleEditTest = (test) => {
        setEditingTest(test);
        setAdminView('create');
      };

      const handleResetAllData = () => {
        showModal({
          title: "Reset All Player Data?",
          message: "Are you sure you want to completely reset all player data, including progress, XP, and achievements? This action will keep all created tests but cannot be undone.",
          confirmText: "Reset Everything",
          onConfirm: handleFullReset
        });
      };
      
      if (adminView === 'create') {
        return <CreateTestView setAdminView={setAdminView} allTests={allTests} updateAllData={updateAllData} userData={userData} showNotification={showNotification} editingTest={editingTest} setEditingTest={setEditingTest} showModal={showModal} />;
      }
      
      if (adminView === 'analysis') {
        return <PerformanceDashboardView setAdminView={setAdminView} userData={userData} allTests={allTests} showModal={showModal} />;
      }

      return (
        <div className="p-8 min-h-screen">
          <div className="max-w-5xl mx-auto">
            <div className="flex justify-between items-center mb-8">
              <h1 className="text-4xl font-bold font-orbitron text-cyan-300">Admin Panel</h1>
              <button onClick={() => setView('dashboard')} className="bg-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-600">&larr; Back to Dashboard</button>
            </div>
            
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
              <button onClick={() => { setEditingTest(null); setAdminView('create'); }} className="bg-green-600 text-white p-6 rounded-lg font-bold text-xl hover:bg-green-500">Create New Test</button>
              <button onClick={() => setAdminView('analysis')} className="bg-purple-600 text-white p-6 rounded-lg font-bold text-xl hover:bg-purple-500">Performance Dashboard</button>
            </div>

            <div className="bg-slate-800/50 border border-slate-700 rounded-xl p-6 mb-8">
                <h2 className="text-2xl font-bold mb-4 font-orbitron text-cyan-300">Data Management</h2>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button onClick={handleExportData} className="bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-500">Export All Data</button>
                    <div>
                        <input type="file" accept=".json" ref={importFileRef} onChange={handleImportData} className="hidden" id="import-file" />
                        <label htmlFor="import-file" className="cursor-pointer w-full text-center block bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-500">
                            Import from Backup
                        </label>
                    </div>
                    <button onClick={handleResetAllData} className="bg-red-800 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700 col-span-1 md:col-span-2">
                      Reset All Player Data
                    </button>
                </div>
                 <p className="text-slate-400 mt-4 text-sm">All progress and created tests are saved in this browser's local storage. Use Export to create a backup file. Clearing browser data will erase everything.</p>
            </div>

            <div className="bg-slate-800/50 border border-slate-700 rounded-xl p-6">
              <h2 className="text-2xl font-bold mb-4 font-orbitron text-cyan-300">Manage Tests</h2>
              <div className="space-y-4">
                {allTests.map(test => (
                  <div key={test.id} className="bg-slate-800 p-4 rounded-lg flex flex-wrap justify-between items-center gap-4">
                    <div><h3 className="text-lg font-bold">{test.title}</h3><p className="text-slate-400">{test.questions.length} questions</p></div>
                    <div className="flex gap-2 flex-wrap">
                      <button onClick={() => handleEditTest(test)} className="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Edit</button>
                      <button onClick={() => handleDeleteTest(test.id)} className="bg-red-800 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700">Delete</button>
                      <button onClick={() => handleResetProgress(test.id)} className="bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-yellow-700">Reset Progress</button>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        </div>
      );
    };
    
    const CreateTestView = ({ setAdminView, allTests, updateAllData, userData, showNotification, editingTest, setEditingTest, showModal }) => {
      const [title, setTitle] = useState(editingTest?.title || '');
      const [subject, setSubject] = useState(editingTest?.subject || 'Maths');
      const [notes, setNotes] = useState(editingTest?.notes || '');
      const [questions, setQuestions] = useState(editingTest?.questions || [{ question: '', options: ['', '', '', ''], answer: '' }]);
      const [isParsing, setIsParsing] = useState(false);
      const [bulkText, setBulkText] = useState('');
      const [aiTopic, setAiTopic] = useState('');
      const [aiNumQuestions, setAiNumQuestions] = useState(10);

      const handleQuestionChange = (index, field, value) => {
        const newQuestions = [...questions];
        newQuestions[index][field] = value;
        setQuestions(newQuestions);
      };
      
      const handleOptionChange = (qIndex, oIndex, value) => {
        const newQuestions = [...questions];
        if (!newQuestions[qIndex].options) newQuestions[qIndex].options = ['', '', '', ''];
        newQuestions[qIndex].options[oIndex] = value;
        setQuestions(newQuestions);
      };

      const addQuestion = () => {
        setQuestions([...questions, { question: '', options: ['', '', '', ''], answer: '' }]);
      };
      
      const handleSaveTest = () => {
        if (!title || questions.some(q => !q.question || !q.answer)) {
          showNotification({message: "Title and all question fields are required.", type: 'error'});
          return;
        }

        if (title.length > 100) {
          showNotification({message: "Title must be less than 100 characters.", type: 'error'});
          return;
        }
        const invalidQuestion = questions.find(q => q.question.length > 1000);
        if (invalidQuestion) {
          showNotification({message: "Questions must be less than 1000 characters.", type: 'error'});
          return;
        }

        const invalid = questions.find((q, idx) => {
          const hasOptions = Array.isArray(q.options) && q.options.some(o => (o || '').trim() !== '');
          if (!hasOptions) return false;
          const answerTrim = (q.answer || '').trim();
          return !q.options.some(o => (o || '').trim() === answerTrim);
        });
        if (invalid) {
          showNotification({message: "Each MCQ's 'Correct Answer' must exactly match one of its options.", type: 'error'});
          return;
        }

        if (editingTest) {
          const updatedTest = { ...editingTest, title, subject, questions, notes };
          const newAllTests = allTests.map(t => t.id === editingTest.id ? updatedTest : t);
          updateAllData({ userData, allTests: newAllTests });
          showNotification({message: "Test updated successfully!", type: 'success'});
        } else {
          const newTest = { id: `custom-${Date.now()}`, title, subject, questions, notes };
          const newAllTests = [...allTests, newTest];
          updateAllData({ userData, allTests: newAllTests });
          showNotification({message: "Test created successfully!", type: 'success'});
        }
        setEditingTest(null);
        setAdminView('main');
      };

      const handleBulkImport = () => {
        try {
          const parsedQuestions = [];
          const lines = bulkText.split('\n');
          let currentQuestion = null;

          for (const raw of lines) {
            const line = raw.trim();
            if (line.startsWith('Q:')) {
              if (currentQuestion) parsedQuestions.push(currentQuestion);
              currentQuestion = { question: line.substring(2).trim(), options: [], answer: '' };
            } else if (line.startsWith('O:') && currentQuestion) {
              currentQuestion.options.push(line.substring(2).trim());
            } else if (line.startsWith('A:') && currentQuestion) {
              currentQuestion.answer = line.substring(2).trim();
            }
          }
          if (currentQuestion) parsedQuestions.push(currentQuestion);

          if (parsedQuestions.length > 0) {
            setQuestions(parsedQuestions);
            showNotification({message: 'Bulk import successful!', type: 'success'});
          } else {
            showNotification({message: 'Could not find any questions in the provided format.', type: 'error'});
          }
        } catch (e) {
          showNotification({message: 'Error parsing bulk text. Please check the format.', type: 'error'});
        }
      };
      
      const handleAIGenerate = async () => {
        if (!aiTopic) {
          showNotification({ message: "Please enter a topic to generate questions.", type: "error" });
          return;
        }
        setIsParsing(true);
        let controller = new AbortController();
        try {
          const prompt = `Generate ${aiNumQuestions} multiple-choice ${subject} questions suitable for a 10-year-old based on the topic: "${aiTopic}". Provide the response as a JSON array of objects. Each object should have keys "question", "options" (an array of strings), and "answer". Example: [{"question": "What is 2+2?", "options": ["3", "4", "5"], "answer": "4"}]`;
          
          let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
          const payload = { contents: chatHistory };
          const apiUrl = `/.netlify/functions/gemini-proxy`;
          
          const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload), signal: controller.signal });

          if (!response.ok) {
            let errorBody = {};
            try { errorBody = await response.json(); } catch {}
            throw new Error(`API Error: ${errorBody.error?.message || response.statusText}`);
          }

          const result = await response.json();
          let rawText = result?.candidates?.[0]?.content?.parts?.[0]?.text || "";
          
          if (rawText) {
            let cleaned = rawText.replace(/^```(\w+)?\s*/m, '').replace(/```$/m, '').trim();
            if (!cleaned.trim().startsWith('[')) {
              const first = cleaned.indexOf('[');
              const last = cleaned.lastIndexOf(']');
              if (first !== -1 && last !== -1 && last > first) {
                cleaned = cleaned.substring(first, last + 1);
              }
            }
            const parsedJson = JSON.parse(cleaned);
            if (Array.isArray(parsedJson)) {
              setQuestions(parsedJson.map(q => ({ question: q.question, options: q.options || ['', '', '', ''], answer: q.answer })));
              setTitle={`AI Generated: ${aiTopic}`);
              showNotification({ message: "AI generated questions successfully!", type: 'success' });
            } else {
              throw new Error("AI response was not in the expected format (array of questions).");
            }
          } else {
            throw new Error("Failed to get a valid response from the AI.");
          }
        } catch (error) {
          if (error?.name === 'AbortError') return;
          console.error("AI API Error:", error);
          showModal({
            title: "AI Feature Error",
            message: `Could not complete AI request. Please check your connection. Error: ${error.message}`,
            onConfirm: () => {},
            confirmText: "OK"
          });
        } finally {
          setIsParsing(false);
          controller = null;
        }
      };

      return (
        <div className="p-8 min-h-screen">
          <div className="max-w-4xl mx-auto">
            <div className="flex justify-between items-center mb-8">
              <h1 className="text-3xl font-bold font-orbitron text-cyan-300">{editingTest ? 'Edit Test' : 'Create New Test'}</h1>
              <button onClick={() => { setEditingTest(null); setAdminView('main'); }} className="bg-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-600">&larr; Back to Admin</button>
            </div>
            <div className="bg-slate-800/50 border border-slate-700 p-6 rounded-xl space-y-6">
              <div className="bg-slate-800 p-4 rounded-lg border border-purple-500">
                <h3 className="text-lg font-bold mb-2 text-purple-300">✨ Generate Test with AI</h3>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <input type="text" value={aiTopic} onChange={e => setAiTopic(e.target.value)} placeholder="Enter a topic..." className="md:col-span-2 p-2 bg-slate-700 rounded-md border border-slate-600" />
                  <input type="number" value={aiNumQuestions} onChange={e => setAiNumQuestions(parseInt(e.target.value, 10))} className="p-2 bg-slate-700 rounded-md border border-slate-600" />
                </div>
                <button onClick={handleAIGenerate} disabled={isParsing} className="mt-2 w-full bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-500 disabled:bg-slate-600">
                  {isParsing ? 'Generating...' : 'Generate Questions'}
                </button>
              </div>

              <div className="bg-slate-800 p-4 rounded-lg border border-slate-700">
                <h3 className="text-lg font-bold mb-2">Bulk Import from Text</h3>
                <textarea 
                  className="w-full p-2 bg-slate-700 rounded-md border border-slate-600"
                  rows="6"
                  placeholder={`Paste your test here. Use this format:\nQ: What is 2+2?\nO: 3\nO: 4\nO: 5\nA: 4`}
                  value={bulkText}
                  onChange={e => setBulkText(e.target.value)}
                ></textarea>
                <button onClick={handleBulkImport} className="mt-2 w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-500">Parse Bulk Text</button>
              </div>

              <hr className="border-slate-600"/>

              <div>
                <label className="block mb-2 font-bold">Test Title</label>
                <input type="text" value={title} onChange={e => setTitle(e.target.value)} className="w-full p-2 bg-slate-700 rounded-md border border-slate-600" />
              </div>
              <div>
                <label className="block mb-2 font-bold">Subject</label>
                <select value={subject} onChange={e => setSubject(e.target.value)} className="w-full p-2 bg-slate-700 rounded-md border border-slate-600">
                  <option>Maths</option>
                  <option>English</option>
                  <option>Mixed</option>
                </select>
              </div>
              <div>
                <label className="block mb-2 font-bold">Admin Notes (Visible only to you)</label>
                <input type="text" value={notes} onChange={e => setNotes(e.target.value)} className="w-full p-2 bg-slate-700 rounded-md border border-slate-600" placeholder="e.g., Source of test, focus area..." />
              </div>
              <hr className="border-slate-600"/>
              {questions.map((q, qIndex) => (
                <div key={qIndex} className="bg-slate-800 p-4 rounded-lg border border-slate-700">
                  <label className="block mb-2 font-bold">Question {qIndex + 1}</label>
                  <textarea value={q.question} onChange={e => handleQuestionChange(qIndex, 'question', e.target.value)} className="w-full p-2 bg-slate-700 rounded-md border border-slate-600" rows="2" placeholder="Enter question text..."></textarea>
                  <div className="grid grid-cols-2 gap-4 my-4">
                    {(q.options || ['', '', '', '']).map((opt, oIndex) => (
                      <input key={oIndex} type="text" value={opt} onChange={e => handleOptionChange(qIndex, oIndex, e.target.value)} placeholder={`Option ${oIndex + 1}`} className="p-2 bg-slate-700 rounded-md border border-slate-600" />
                    ))}
                  </div>
                  <label className="block mb-2 font-bold">Correct Answer</label>
                  <input type="text" value={q.answer} onChange={e => handleQuestionChange(qIndex, 'answer', e.target.value)} placeholder="Must match one of the options exactly" className="w-full p-2 bg-slate-700 rounded-md border border-slate-600" />
                </div>
              ))}
              <button onClick={addQuestion} className="bg-slate-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-slate-500">Add Another Question</button>
            </div>
            <div className="mt-8 text-center">
              <button onClick={handleSaveTest} className="bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-500 text-xl">{editingTest ? 'Update Test' : 'Save Test'}</button>
            </div>
          </div>
        </div>
      );
    };
    
    const PerformanceDashboardView = ({ setAdminView, userData, allTests, showModal }) => {
      const chartRef = useRef(null);
      const chartInstanceRef = useRef(null);
      const [aiSummary, setAiSummary] = useState('');
      const [isSummaryLoading, setIsSummaryLoading] = useState(false);
      const summaryAbortRef = useRef(null);
      const summaryReqRef = useRef(0);
      const mountedRef = useRef(true);

      useEffect(() => {
        mountedRef.current = true;
        return () => {
          mountedRef.current = false;
          if (summaryAbortRef.current) summaryAbortRef.current.abort();
        };
      }, []);

      useEffect(() => {
        if (!chartRef.current) return;
        
        if (!window.Chart) {
          console.warn('Chart.js failed to load from CDN');
          return;
        }

        const completedTests = Object.entries(userData.progress || {})
          .map(([testId, progressData]) => {
            const test = allTests.find(t => t.id === testId);
            if (!test || Object.keys(progressData.answers || {}).length !== test.questions.length) return null;
            return {
              ...test,
              ...progressData,
              completedAt: progressData.completedAt || Date.now()
            };
          })
          .filter(Boolean)
          .sort((a, b) => a.completedAt - b.completedAt);

        const mathsScores = completedTests.filter(t => t.subject === 'Maths').map(t => (t.score / t.questions.length) * 100);
        const englishScores = completedTests.filter(t => t.subject === 'English').map(t => (t.score / t.questions.length) * 100);
        
        const labels = Array.from({length: Math.max(mathsScores.length, englishScores.length)}, (_, i) => `Test ${i + 1}`);

        const ctx = chartRef.current.getContext('2d');
        if (chartInstanceRef.current) {
          chartInstanceRef.current.destroy();
          chartInstanceRef.current = null;
        }
        chartInstanceRef.current = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [
              {
                label: 'Maths Average Score (%)',
                data: mathsScores,
                borderColor: 'rgba(54, 162, 235, 1)',
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                fill: false,
                tension: 0.1
              },
              {
                label: 'English Average Score (%)',
                data: englishScores,
                borderColor: 'rgba(255, 99, 132, 1)',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                fill: false,
                tension: 0.1
              }
            ]
          },
          options: {
            scales: {
              y: {
                beginAtZero: true,
                max: 100
              }
            }
          }
        });

        return () => {
          if (chartInstanceRef.current) {
            chartInstanceRef.current.destroy();
            chartInstanceRef.current = null;
          }
        };
      }, [userData, allTests]);

      const getAISummary = async () => {
        setIsSummaryLoading(true);

        if (summaryAbortRef.current) summaryAbortRef.current.abort();
        const controller = new AbortController();
        summaryAbortRef.current = controller;
        const thisReq = ++summaryReqRef.current;

        try {
          const incorrectAnswers = [];
          
          Object.entries(userData.progress || {}).forEach(([testId, progressData]) => {
            const test = allTests.find(t => t.id === testId);
            if (test) {
              Object.entries(progressData.answers || {}).forEach(([qIndex, userAnswer]) => {
                const question = test.questions[qIndex];
                if (question && !isAnswerCorrect(question, userAnswer)) {
                  incorrectAnswers.push(question.question);
                }
              });
            }
          });

          const prompt = `Based on this list of incorrectly answered questions for a 10-year-old student, please identify 2-3 conceptual patterns or common themes of weakness. Keep the summary concise and framed in a positive, actionable way for a parent. Incorrect questions: ${JSON.stringify(incorrectAnswers.slice(0, 50))}`;

          const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
          const apiUrl = `/.netlify/functions/gemini-proxy`;
          const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload), signal: controller.signal });
          if (!response.ok) {
            let errorBody = {};
            try { errorBody = await response.json(); } catch {}
            throw new Error(`API Error: ${errorBody.error?.message || response.statusText}`);
          }
          const result = await response.json();
          if (!mountedRef.current || thisReq !== summaryReqRef.current) return;
          const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
          if (text) {
            setAiSummary(text);
          } else {
            throw new Error("Invalid API response structure.");
          }
        } catch (error) {
          if (error?.name === 'AbortError') return;
          console.error("AI API Error:", error);
          showModal({
            title: "AI Feature Error",
            message: `Could not complete AI request. Please check your connection. Error: ${error.message}`,
            onConfirm: () => {},
            confirmText: "OK"
          });
        } finally {
          if (mountedRef.current && thisReq === summaryReqRef.current) setIsSummaryLoading(false);
        }
      };

      return (
        <div className="p-8 min-h-screen">
          <div className="max-w-4xl mx-auto">
            <div className="flex justify-between items-center mb-8">
              <h1 className="text-3xl font-bold font-orbitron text-cyan-300">Performance Dashboard</h1>
              <button onClick={() => setAdminView('main')} className="bg-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-600">&larr; Back to Admin</button>
            </div>

            <div className="bg-slate-800/50 border border-slate-700 p-6 rounded-xl mb-8">
              <h2 className="text-xl font-bold mb-4">Score Over Time</h2>
              <canvas ref={chartRef}></canvas>
            </div>
            
            <div className="bg-slate-800/50 border border-slate-700 p-6 rounded-xl mb-8">
              <h2 className="text-xl font-bold mb-4">AI Performance Summary</h2>
              <button onClick={getAISummary} disabled={isSummaryLoading} className="bg-purple-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-purple-500 disabled:bg-slate-600">
                {isSummaryLoading ? '✨ Analyzing Performance...' : '✨ Generate AI Summary'}
              </button>
              {aiSummary && (
                <div className="bg-slate-700/50 p-4 rounded-lg mt-4 border border-slate-600">
                  <p className="text-slate-300 whitespace-pre-wrap">{aiSummary}</p>
                </div>
              )}
            </div>
          </div>
        </div>
      );
    };

    const SettingsView = ({ userData, setView, updateUserData, showNotification }) => {
      const [name, setName] = useState(userData.name);
      const [avatar, setAvatar] = useState(userData.avatar || '👨\u200d🚀');
      const [dyslexiaFriendly, setDyslexiaFriendly] = useState(userData.dyslexiaFriendly || false);
      const avatars = ['👨\u200d🚀', '🚀', '⭐', '🎮', '🤖', '🧠', '💡', '🏆'];

      const handleSave = () => {
        updateUserData({ ...userData, name, avatar, dyslexiaFriendly }, { event: { type: 'NO_OP' } });
        showNotification({message: "Settings saved!", type: "success"});
        setView('dashboard');
      };

      return (
        <div className="p-8 min-h-screen flex items-center justify-center">
          <div className="max-w-md mx-auto w-full bg-slate-800 border border-slate-700 rounded-xl p-8">
            <h1 className="text-3xl font-bold font-orbitron text-cyan-300 mb-6 text-center">Profile Settings</h1>
            <div className="mb-6">
              <label className="block mb-2 font-bold">Player Name</label>
              <input type="text" value={name} onChange={e => setName(e.target.value)} className="w-full p-2 bg-slate-700 rounded-md border border-slate-600" />
            </div>
            <div className="mb-8">
              <label className="block mb-2 font-bold">Choose Your Avatar</label>
              <div className="grid grid-cols-4 gap-4">
                {avatars.map(av => (
                  <button key={av} onClick={() => setAvatar(av)} className={`text-4xl p-4 rounded-lg transition-all ${avatar === av ? 'bg-cyan-600 ring-2 ring-cyan-300' : 'bg-slate-700 hover:bg-slate-600'}`}>{av}</button>
                ))}
              </div>
            </div>
            <div className="mb-8 p-4 border border-slate-600 rounded-lg">
                <div className="flex items-center justify-between">
                    <div>
                        <label htmlFor="dyslexia-toggle" className="font-bold text-slate-200">Dyslexia Friendly Font</label>
                        <p className="text-sm text-slate-400">Increases readability with a special font.</p>
                    </div>
                    <input 
                        id="dyslexia-toggle" 
                        type="checkbox" 
                        checked={dyslexiaFriendly} 
                        onChange={() => setDyslexiaFriendly(!dyslexiaFriendly)} 
                        className="w-6 h-6 rounded text-cyan-500 bg-slate-800 border-slate-500 focus:ring-cyan-600" 
                    />
                </div>
            </div>
            <div className="flex gap-4">
              <button onClick={() => setView('dashboard')} className="w-full bg-slate-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-slate-500">Cancel</button>
              <button onClick={handleSave} className="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-500">Save</button>
            </div>
          </div>
        </div>
      );
    };
    
    const AchievementsView = ({ userData, setView, updateUserData, showNotification }) => {
      const [activeTab, setActiveTab] = useState('Badges');

      const unlockedTitles = achievementsList.filter(ach => userData.achievements[ach.id] && ach.unlocksTitle);
      const hasTitles = achievementsList.some(a => !!a.unlocksTitle);

      const handleEquipTitle = (title) => {
        updateUserData({ ...userData, title: title }, { event: { type: 'NO_OP' } });
        showNotification({message: `Title "${title}" equipped!`, type: 'success'});
      };

      return (
        <div className="p-8 min-h-screen">
          <div className="max-w-5xl mx-auto">
            <div className="flex justify-between items-center mb-8">
              <h1 className="text-4xl font-bold font-orbitron text-cyan-300">Achievements</h1>
              <button onClick={() => setView('dashboard')} className="bg-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-600">&larr; Back to Dashboard</button>
            </div>

            <div className="flex border-b border-slate-700 mb-6">
              <button onClick={() => setActiveTab('Badges')} className={`py-2 px-4 font-semibold ${activeTab === 'Badges' ? 'border-b-2 border-cyan-400 text-cyan-300' : 'text-slate-400'}`}>Badges</button>
              {hasTitles && <button onClick={() => setActiveTab('Titles')} className={`py-2 px-4 font-semibold ${activeTab === 'Titles' ? 'border-b-2 border-cyan-400 text-cyan-300' : 'text-slate-400'}`}>Titles</button>}
            </div>

            {activeTab === 'Badges' && (
              <div>
                {['Quick Wins', 'Medium-Term', 'Longer-Term'].map(category => (
                  <div key={category} className="mb-8">
                    <h2 className="text-2xl font-orbitron text-cyan-300 mb-4">{category}</h2>
                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                      {achievementsList.filter(ach => ach.category === category).map(ach => {
                        const isUnlocked = userData.achievements[ach.id];
                        return (
                          <div key={ach.id} className={`p-4 rounded-lg border-2 text-center ${isUnlocked ? 'border-yellow-400 bg-slate-800' : 'border-slate-700 bg-slate-800/50'}`}>
                            <div className={`text-5xl mb-2 transition-all duration-300 ${isUnlocked ? 'text-yellow-400' : 'text-slate-600 scale-90 grayscale'}`}>🏆</div>
                            <h3 className={`font-bold ${isUnlocked ? 'text-yellow-300' : 'text-slate-400'}`}>{ach.title}</h3>
                            <p className="text-sm text-slate-500">{ach.description}</p>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                ))}
              </div>
            )}

            {activeTab === 'Titles' && (
              <div className="bg-slate-800/50 border border-slate-700 p-6 rounded-xl">
                <h2 className="text-2xl font-orbitron text-cyan-300 mb-4">Equip a Title</h2>
                {unlockedTitles.length > 0 ? (
                  <div className="space-y-3">
                    {unlockedTitles.map(ach => (
                      <div key={ach.id} className="bg-slate-800 p-4 rounded-lg flex justify-between items-center">
                        <div>
                          <p className="font-bold text-lg text-yellow-300">{ach.unlocksTitle}</p>
                          <p className="text-sm text-slate-400">Unlocked from: "{ach.title}"</p>
                        </div>
                        <button onClick={() => handleEquipTitle(ach.unlocksTitle)} disabled={userData.title === ach.unlocksTitle} className="bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-500 disabled:bg-slate-600 disabled:cursor-not-allowed">
                          {userData.title === ach.unlocksTitle ? 'Equipped' : 'Equip'}
                        </button>
                      </div>
                    ))}
                  </div>
                ) : (
                  <p className="text-slate-400">No titles unlocked yet. Earn badges to unlock them!</p>
                )}
              </div>
            )}
          </div>
        </div>
      );
    };

    // --- Main App Component ---
    function App() {
      const [appData, setAppData] = useState(null);
      const [view, setView] = useState('loading');
      const [selectedTest, setSelectedTest] = useState(null);
      const [notification, setNotification] = useState({ show: false, message: '', type: '' });
      const [modal, setModal] = useState({ show: false, title: '', message: '', onConfirm: null, onCancel: null, confirmText: "Confirm", children: null });

      const showNotification = ({message, type = 'success'}) => {
        setNotification({ show: true, message, type });
      };

      const hideModal = () => {
        setModal({ show: false });
      };

      const showModal = ({ title, message, onConfirm, onCancel, confirmText, children }) => {
        setModal({ 
          show: true, 
          title, 
          message, 
          onConfirm: onConfirm ? () => {
            onConfirm();
            hideModal();
          } : null,
          onCancel: onCancel ? () => {
            onCancel();
            hideModal();
          } : hideModal,
          confirmText: confirmText,
          children
        });
      };

      useEffect(() => {
        const savedData = localStorage.getItem('seagPortalData');
        let loadedData;
        if (savedData) {
          try {
            loadedData = JSON.parse(savedData);
          } catch(e) {
            console.error("Failed to parse saved data, initializing fresh.", e);
            loadedData = null;
          }
        }
        
        if (!loadedData) {
          loadedData = {
            userData: {},
            allTests: defaultTests
          };
        }

        const defaultUserData = {
            name: "Nicolas",
            avatar: '👨\u200d🚀',
            title: null,
            dyslexiaFriendly: false,
            level: 1,
            xp: 0,
            achievements: {},
            progress: {},
            // Counters/stats used by achievements
            totalCorrectAnswers: 0,
            correctAnswersByTag: {}, // e.g. { fractions: 12, punctuation: 5 }
            lastAnswerWasIncorrect: false,
            correctRunAfterWrong: 0,
            // Daily challenge tracking
            dailyChallengeStreak: 0,
            dailyChallenge: { completedToday: false, lastCompletedDate: null },
            // Longitudinal tracking
            badgeProgress: { geometryGuruTests: [] },
            weeklyCompletionWeeks: [],
            fullTestsCompleted: [],
            // NEW: track achievements unlocked during an in-progress test
            pendingAchievementIdsByTest: {} // { [testId]: string[] }
        };

        loadedData.userData = { ...defaultUserData, ...loadedData.userData };
        
        setAppData(loadedData);
        setView('dashboard');
      }, []);
      
      useEffect(() => {
        if (appData && appData.userData) {
            updateUserData(appData.userData, { event: { type: 'DAY_STARTED' } });
        }
      }, [!!appData]);

      useEffect(() => {
        if (appData?.userData?.dyslexiaFriendly) {
            document.body.classList.add('dyslexia-friendly');
        } else {
            document.body.classList.remove('dyslexia-friendly');
        }
      }, [appData?.userData?.dyslexiaFriendly]);

      const updateAllData = useCallback((newData) => {
        setAppData(newData);
        // Quota-safe write
        safeSetLocalStorage('seagPortalData', JSON.stringify(newData));
      }, []);
      
      const handleFullReset = useCallback(() => {
        if (!appData) return;

        const testsToKeep = appData.allTests;

        // Re-create the default user data object
        const newCleanUserData = {
            name: "Nicolas",
            avatar: '👨\u200d🚀',
            title: null,
            dyslexiaFriendly: false,
            level: 1,
            xp: 0,
            achievements: {},
            progress: {},
            totalCorrectAnswers: 0,
            correctAnswersByTag: {},
            lastAnswerWasIncorrect: false,
            correctRunAfterWrong: 0,
            dailyChallengeStreak: 0,
            dailyChallenge: { completedToday: false, lastCompletedDate: null },
            badgeProgress: { geometryGuruTests: [] },
            weeklyCompletionWeeks: [],
            fullTestsCompleted: [],
            pendingAchievementIdsByTest: {}
        };

        const newData = {
            allTests: testsToKeep,
            userData: newCleanUserData
        };

        updateAllData(newData);

        showNotification({ message: "All player data has been reset. The app will now reload.", type: 'success' });
        setTimeout(() => window.location.reload(), 1500);

      }, [appData, updateAllData]);

      const updateUserData = useCallback((newUserData, options = {}) => {
        if (!appData) return;
        
        const { event, silentAchievements } = options || {};
        // Rebase on the latest store to prevent stale overwrites from rapid successive calls
        let mutableUserData = { ...(appData.userData || {}), ...(newUserData || {}) };
        const { type, payload = {} } = event || {};
        
        // Ensure new structure exists
        mutableUserData.pendingAchievementIdsByTest = mutableUserData.pendingAchievementIdsByTest || {};
        // Harden commonly used containers (patch)
        mutableUserData.achievements = mutableUserData.achievements || {};
        mutableUserData.correctAnswersByTag = mutableUserData.correctAnswersByTag || {};
        mutableUserData.badgeProgress = mutableUserData.badgeProgress || {};
        mutableUserData.badgeProgress.geometryGuruTests = Array.isArray(mutableUserData.badgeProgress.geometryGuruTests)
          ? mutableUserData.badgeProgress.geometryGuruTests
          : [];
        mutableUserData.weeklyCompletionWeeks = Array.isArray(mutableUserData.weeklyCompletionWeeks) ? mutableUserData.weeklyCompletionWeeks : [];
        mutableUserData.fullTestsCompleted = Array.isArray(mutableUserData.fullTestsCompleted) ? mutableUserData.fullTestsCompleted : [];
        mutableUserData.weeklyDayMap = mutableUserData.weeklyDayMap || {};
        mutableUserData.perTopicStats = mutableUserData.perTopicStats || {};
        mutableUserData.progress = mutableUserData.progress || {};
        
        // 1) Update stats based on the event (these count regardless of mode; unlocks will be gated)
        if (type === 'ANSWER_SUBMITTED') {
            mutableUserData.totalAttempts = (mutableUserData.totalAttempts || 0) + 1;
            const today = new Date().toISOString().split('T')[0];
            const currentTags = Array.isArray(payload.tags) ? payload.tags : [];
            const uniqueTagsToday = mutableUserData.uniqueTagsToday || { date: null, tags: [] };
            if (uniqueTagsToday.date !== today) {
                mutableUserData.uniqueTagsToday = { date: today, tags: [...new Set(currentTags)] };
            } else {
                const merged = new Set([...uniqueTagsToday.tags, ...currentTags]);
                mutableUserData.uniqueTagsToday = { date: today, tags: [...merged] };
            }
            const primaryTag = currentTags[0] || 'general';
            mutableUserData.perTopicStats = mutableUserData.perTopicStats || {};
            const prevTopic = mutableUserData.perTopicStats[primaryTag] || { correct: 0, total: 0 };
            const isCorrect = !!payload.correct;
            mutableUserData.perTopicStats[primaryTag] = {
                correct: prevTopic.correct + (isCorrect ? 1 : 0),
                total: prevTopic.total + 1
            };
            
            const prevWasIncorrect = !!mutableUserData.lastAnswerWasIncorrect;
            mutableUserData.lastAnswerWasIncorrect = !isCorrect;
            if (isCorrect) {
                mutableUserData.totalCorrectAnswers = (mutableUserData.totalCorrectAnswers || 0) + 1;
                mutableUserData.currentStreak = (mutableUserData.currentStreak || 0) + 1;

                // NEW: per-tag correct counters for achievements
                const tags = Array.isArray(payload.tags) ? payload.tags : [];
                mutableUserData.correctAnswersByTag = mutableUserData.correctAnswersByTag || {};
                tags.forEach(tag => {
                    mutableUserData.correctAnswersByTag[tag] = (mutableUserData.correctAnswersByTag[tag] || 0) + 1;
                });

                if (!payload.usedHint) {
                    mutableUserData.noHintStreak = (mutableUserData.noHintStreak || 0) + 1;
                    mutableUserData.noHintCorrectCount = (mutableUserData.noHintCorrectCount || 0) + 1;
                }
                const timeToAnswer = Number(payload.timeToAnswer) || 0;
                const newTimes = [...(mutableUserData.lastCorrectAnswerTimes || []), timeToAnswer];
                mutableUserData.lastCorrectAnswerTimes = newTimes.slice(-3);
                if (payload.wasReviewed) {
                    mutableUserData.reviewCorrections = (mutableUserData.reviewCorrections || 0) + 1;
                }
                mutableUserData.correctRunAfterWrong = prevWasIncorrect ? (mutableUserData.correctRunAfterWrong || 0) + 1 : (mutableUserData.correctRunAfterWrong || 0);
            } else {
                mutableUserData.currentStreak = 0;
                mutableUserData.noHintStreak = 0;
                mutableUserData.correctRunAfterWrong = 0;
            }
        }
        
        if (type === 'DAY_STARTED') {
            const today = new Date().toISOString().split('T')[0];
            if (mutableUserData.lastActiveDate !== today) {
                const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
                if (mutableUserData.lastActiveDate === yesterday) {
                    mutableUserData.loginStreak = (mutableUserData.loginStreak || 1) + 1;
                } else {
                    mutableUserData.loginStreak = 1;
                }
                mutableUserData.lastActiveDate = today;
                const activity = new Set(mutableUserData.dailyActivityDates || []);
                activity.add(today);
                mutableUserData.dailyActivityDates = [...activity];
                mutableUserData.dailyChallenge = mutableUserData.dailyChallenge || {};
                mutableUserData.dailyChallenge.completedToday = false;
            }
        }

        if (type === 'PACK_COMPLETED' && payload.isDailyChallenge) {
          const today = new Date().toISOString().split('T')[0];
          mutableUserData.dailyChallenge = mutableUserData.dailyChallenge || {};
          if (!mutableUserData.dailyChallenge.completedToday) {
            mutableUserData.dailyChallenge.completedToday = true;
            const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
            const lastDay = mutableUserData.dailyChallenge.lastCompletedDate;
            if (lastDay === yesterday) {
              mutableUserData.dailyChallengeStreak = (mutableUserData.dailyChallengeStreak || 0) + 1;
            } else if (lastDay !== today) {
              mutableUserData.dailyChallengeStreak = 1;
            }
            mutableUserData.dailyChallenge.lastCompletedDate = today;
          }
        }
        
        // 2) Run unlocker
        const { updated: withAchievements, unlockedIds } = unlockAchievements(mutableUserData, event);
        let finalUserData = withAchievements;
        
        // 3) Buffer newly unlocked achievements (Test mode only was enforced inside unlocker)
        if (unlockedIds?.length) {
          const bufferTestId = payload?.testId || payload?.finishedTestId || null;
        
          if (bufferTestId) {
            const existing = new Set(finalUserData.pendingAchievementIdsByTest[bufferTestId] || []);
            unlockedIds.forEach(id => existing.add(id));
            finalUserData.pendingAchievementIdsByTest[bufferTestId] = Array.from(existing);
          }
        }
        
        // 4) On PACK_COMPLETED in Test mode, award XP (patched)
        if (type === 'PACK_COMPLETED' && payload?.mode === 'Test') {
          const finishedId = payload.finishedTestId;
          const pendingIds = finalUserData.pendingAchievementIdsByTest?.[finishedId] || [];
        
          let xpToAdd = payload.score; // 1 XP per correct answer
          if (pendingIds.length > 0) {
            xpToAdd += pendingIds.reduce((sum, id) => sum + xpForAchievementId(id), 0);
          }

          finalUserData.xp = Math.max(0, (finalUserData.xp ?? 0) + xpToAdd);
          finalUserData.level = finalUserData.level || 1;

          // Fast approximate jump + capped loop to avoid infinite iteration
          const fastLevelAdvance = () => {
            const L = Math.max(1, Number(finalUserData.level) || 1);
            let X = Math.max(0, Number(finalUserData.xp) || 0);

            // Max n s.t. 100*(n*L + n*(n-1)/2) <= X
            const a = 1;
            const b = 2 * L - 1;
            const c = -2 * (X / 100);
            const disc = Math.max(0, b * b - 4 * a * c);
            const nApprox = Math.floor((-b + Math.sqrt(disc)) / (2 * a));

            if (nApprox > 0) {
              const consumed = 100 * (nApprox * L + (nApprox * (nApprox - 1)) / 2);
              finalUserData.level = L + nApprox;
              finalUserData.xp = Math.max(0, X - consumed);
            }
          };

          fastLevelAdvance();

          let guard = 0;
          while (finalUserData.xp >= (finalUserData.level * 100) && guard < 100) {
            finalUserData.xp -= finalUserData.level * 100;
            finalUserData.level += 1;
            guard += 1;
          }

          // Clear pending for this completed test
          if (finalUserData.pendingAchievementIdsByTest) {
            delete finalUserData.pendingAchievementIdsByTest[finishedId];
          }
        }
        
        // 5) Persist
        updateAllData({ ...appData, userData: finalUserData });
        
        // 6) Celebrate unlocks (modal)
        if (unlockedIds?.length && !silentAchievements) {
          const unlockedAchievementsDetails = unlockedIds
            .map(id => achievementsList.find(a => a.id === id))
            .filter(Boolean);
          const message = unlockedAchievementsDetails.map(u => `"${u.title}"`).join(', ');
          showModal({
            title: "🏆 Achievement Unlocked! 🏆",
            message: `Congratulations! You've earned: ${message}`,
            onConfirm: () => {},
            confirmText: "Awesome!"
          });
        }
      }, [appData, updateAllData, showModal, showNotification]);

      if (!appData) {
        return <LoadingSpinner message="Initializing System..." />;
      }

      const renderView = () => {
        switch (view) {
          case 'loading': return <LoadingSpinner message="Loading Portal..." />;
          case 'dashboard': return <Dashboard userData={appData.userData} setView={setView} setSelectedTest={setSelectedTest} allTests={appData.allTests} showModal={showModal} hideModal={hideModal} updateUserData={updateUserData} appData={appData} updateAllData={updateAllData} showNotification={showNotification} />;
          case 'quiz': return <QuizView userData={appData.userData} testDetails={selectedTest} setView={setView} allTests={appData.allTests} updateUserData={updateUserData} updateAllData={updateAllData} showNotification={showNotification} showModal={showModal} />;
          case 'results': return <ResultsView userData={appData.userData} setView={setView} testDetails={selectedTest} allTests={appData.allTests} showModal={showModal} />;
          case 'admin': return <AdminView userData={appData.userData} setView={setView} allTests={appData.allTests} updateAllData={updateAllData} showModal={showModal} showNotification={showNotification} handleFullReset={handleFullReset} />;
          case 'settings': return <SettingsView userData={appData.userData} setView={setView} updateUserData={updateUserData} showNotification={showNotification} />;
          case 'achievements': return <AchievementsView userData={appData.userData} setView={setView} updateUserData={updateUserData} showNotification={showNotification} />;
          default: return <LoadingSpinner message="Loading Portal..." />;
        }
      };

      return (
        <div className="font-sans">
          {renderView()}
          {notification.show && <Notification message={notification.message} type={notification.type} onDismiss={() => setNotification({ show: false })} />}
          {modal.show && <Modal title={modal.title} message={modal.message} onConfirm={modal.onConfirm} onCancel={modal.onCancel} confirmText={modal.confirmText}>{modal.children}</Modal>}
        </div>
      );
    }

    const container = document.getElementById('root');
    const root = ReactDOM.createRoot(container);
    root.render(<App />);
  </script>
</body>
</html>
